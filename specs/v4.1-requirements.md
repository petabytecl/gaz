# v4.1 Milestone Requirements: Server & Transport Layer

**Objective:** Implement production-ready HTTP and gRPC server capabilities with a unified Gateway pattern, enabling seamless dual-protocol support for `gaz` applications.

## 1. Milestone Overview

This milestone introduces the Transport Layer to `gaz`, allowing applications to expose APIs via HTTP and gRPC. The design prioritizes:
- **Standard Library:** Using Go 1.22+ `net/http` features where possible.
- **Type Safety:** Leveraging `gaz` generics for configuration and dependency injection.
- **Observability:** Built-in OpenTelemetry (OTEL) support.
- **Simplicity:** A "batteries-included" Gateway pattern that requires minimal boilerplate for service developers.

## 2. Core Features

### 2.1 HTTP Server
*   **Foundation:** built on standard `net/http`.
*   **Router:** Use Go 1.22+ `http.ServeMux` for routing.
*   **Lifecycle:** Implement `Starter` and `Stopper` interfaces for graceful shutdown.
*   **Configuration:**
    *   Port/Host configurable via `gaz` config system.
    *   Read/Write/Idle timeouts with safe defaults.
    *   Max header bytes configuration.

### 2.2 gRPC Server
*   **Foundation:** `google.golang.org/grpc`.
*   **Registration:** Provide a clean pattern for registering gRPC servers.
*   **Interceptors:** Support for unary and stream interceptors (logging, recovery, OTEL).
*   **Reflection:** Enable gRPC reflection by default (configurable).
*   **Health:** Standard gRPC health check protocol implementation.

### 2.3 gRPC-Gateway
A specialized HTTP server that proxies JSON REST requests to the gRPC server.

*   **Architecture:**
    *   Runs on a **separate port** from the gRPC server (e.g., 8081 for HTTP, 8082 for gRPC).
    *   Connects to the gRPC server via a loopback gRPC dialer.
*   **Dynamic Registration Pattern:**
    *   Define a `Service` interface for gateway registration:
        ```go
        type Service interface {
            // WithHandler registers the service's HTTP proxy handler with the mux
            WithHandler(ctx context.Context, mux *runtime.ServeMux, conn *grpc.ClientConn) error
        }
        ```
    *   The Gateway module should collect all registered `Service` implementations from the DI container and register them automatically on startup.
*   **Middleware:**
    *   **CORS:** Configurable CORS support (Origins, Methods, Headers, Credentials).
    *   **OTEL:** `otelhttp` instrumentation for tracing HTTP requests.
    *   **Request Logging:** Structured logging of HTTP requests.
*   **Static Files:** Support for serving static content (e.g., Swagger UI) alongside API routes.

## 3. Infrastructure

### 3.1 Health Checks
*   **Database:** Add `jackc/pgx` support to `health/checks` to allow monitoring Postgres connections.
*   **gRPC Health:** Integrate standard gRPC health checks into the `gaz` health system.

## 4. Architecture Guidelines

### 4.1 Port Separation
Explicitly separate HTTP and gRPC ports to avoid protocol multiplexing complexity and potential H2/H2C conflicts.
- **App (gRPC):** Primary application logic, running on H2.
- **Gateway (HTTP):** Proxy layer, running on HTTP/1.1 or H2.

### 4.2 DI Integration (gaz adaptation)
Adapt the `uber/fx` lifecycle patterns to `gaz`:

*   **Registration:**
    ```go
    // Example usage in a module
    gaz.For[*Gateway](c).Eager().Provider(NewGateway)
    ```
*   **Lifecycle Management:**
    The Gateway and Server structs must implement the `Starter` and `Stopper` interfaces:
    ```go
    func (s *Server) OnStart(ctx context.Context) error { ... }
    func (s *Server) OnStop(ctx context.Context) error { ... }
    ```
*   **Dependency Injection:**
    The Gateway provider should accept a slice of `Service`s (or a registry) to iterate over. Since `gaz` is explicit, we might need a `RegisterGatewayService` helper or a group pattern if `gaz` supports it, otherwise explicit wiring in the app composition root.
    *   *Note:* Investigate if `gaz` needs a "Group" or "Collection" feature for discovering all implementations of `Service`, or if we stick to explicit registration.

### 4.3 Module Design
Expose dedicated packages:
- `transport/http`: Standard HTTP server.
- `transport/grpc`: gRPC server components.
- `transport/gateway`: The gRPC-Gateway implementation.

## 5. Success Metrics
- A developer can spin up a gRPC service with HTTP transcoding in < 20 lines of main.go code.
- Full OTEL tracing propagation from HTTP Gateway -> gRPC Server -> Database.
- 90%+ Test Coverage for the new packages.
