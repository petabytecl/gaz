# Milestone v4.0: Dependency Reduction

**Status:** SHIPPED 2026-02-02
**Phases:** 32-36
**Total Plans:** 18

## Overview

The v4.0 Dependency Reduction milestone replaced external dependencies with internal implementations to reduce dependency footprint and gain full control over critical infrastructure. Four major dependencies were replaced (jpillora/backoff, lmittmann/tint, robfig/cron/v3, alexliesenfeld/health) and builtin health checks were added for common infrastructure dependencies.

## Phases

### Phase 32: Backoff Package

**Goal**: Workers can retry operations with exponential backoff using internal implementation
**Depends on**: Nothing (first phase of v4.0)
**Plans**: 3 plans

Plans:
- [x] 32-01: Core BackOff types (interface, Stop constant, ExponentialBackOff)
- [x] 32-02: Wrappers and retry helpers (Context, MaxRetries, Retry, Ticker)
- [x] 32-03: Worker integration and dependency removal

**Details:**
Created `backoff/` package with `BackOff` interface defining `NextBackOff()` and `Reset()` methods. ExponentialBackOff implementation with configurable InitialInterval, MaxInterval, Multiplier, RandomizationFactor. Overflow protection clamps result to MaxInterval. Thread-safe jitter using math/rand/v2. Worker package migrated to use internal backoff. jpillora/backoff dependency removed.

### Phase 33: Tint Package

**Goal**: Colored console logging uses internal slog handler implementation
**Depends on**: Phase 32
**Plans**: 3 plans

Plans:
- [x] 33-01: Core logger/tint package (Handler, Options, buffer pool, TTY detection)
- [x] 33-02: Handle method with colorized output + comprehensive tests
- [x] 33-03: Logger integration and dependency removal

**Details:**
Created `logger/tint/` package with `Handler` implementing `slog.Handler` interface. Log levels display in correct ANSI colors (DEBUG=blue, INFO=green, WARN=yellow, ERROR=red). TTY detection auto-disables colors for non-terminal output. Drop-in replacement with identical API. lmittmann/tint dependency removed.

### Phase 34: Cron Package

**Goal**: Scheduled tasks use internal cron engine implementation
**Depends on**: Phase 33
**Plans**: 3 plans

Plans:
- [x] 34-01: Core cron/internal package (types, schedule, parser)
- [x] 34-02: Cron scheduler and chain wrappers
- [x] 34-03: Integration into cron/scheduler and dependency removal

**Details:**
Created `cron/internal/` package with `Cron` scheduler type and standard 5-field parser. Descriptor shortcuts (@daily, @hourly, @weekly, @monthly, @yearly, @every) work correctly. SkipIfStillRunning wrapper prevents overlapping job executions. CRON_TZ prefix and DST transitions handled correctly. cron/scheduler migrated to use internal package. robfig/cron/v3 dependency removed.

### Phase 35: Health Package + Integration

**Goal**: Health checks use internal implementation and all tests pass with maintained coverage
**Depends on**: Phase 34
**Plans**: 3 plans

Plans:
- [x] 35-01: Core health/internal package (Check, Checker, parallel execution)
- [x] 35-02: HTTP handler and IETF result writer
- [x] 35-03: Integration and dependency removal

**Details:**
Created `health/internal/` package with `Check`, `Checker`, `Handler`, and `ResultWriter` types. Health handler returns correct status codes (200 for up, configurable for down). Liveness handler returns 200 even when checks fail. IETF health+json response format built-in. health/manager migrated to use internal package. alexliesenfeld/health dependency removed. All existing tests pass, coverage maintained at 91.7%.

### Phase 36: Add builtin checks on `health/checks`

**Goal**: Reusable, production-ready health checks for common infrastructure dependencies
**Depends on**: Phase 35
**Plans**: 6 plans

Plans:
- [x] 36-01: Package foundation + SQL database check
- [x] 36-02: TCP dial + DNS resolution checks
- [x] 36-03: HTTP upstream check
- [x] 36-04: Runtime metrics checks (goroutine, memory, GC)
- [x] 36-05: Redis check (valkey-go)
- [x] 36-06: Disk space check (gopsutil/v4)

**Details:**
Created `health/checks/` package with subpackages for each check type. Each check has Config struct + New() factory returning `func(context.Context) error`. SQL check uses db.PingContext. Redis check uses client.Ping with valkey UniversalClient interface. HTTP check validates response status with configurable expected code. TCP/DNS checks use stdlib net package with timeout support. Runtime checks (goroutine, memory, GC) use stdlib runtime package. Disk check uses gopsutil/v4 for cross-platform support.

---

## Milestone Summary

**Decimal Phases:**
- None in v4.0

**Key Decisions:**
- Keep BackoffConfig for API compatibility — users may configure via options
- Drop-in API compatibility for tint preserves existing behavior
- cron/internal uses *slog.Logger directly — no adapter needed
- Empty health checker returns StatusUp for backward compatibility
- Config + New factory pattern for all health checks
- Disk check uses percentage threshold (0-100) for portability

**Issues Resolved:**
- External dependency footprint reduced (4 dependencies removed)
- Full control over critical infrastructure code
- No API breaking changes for consumers

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

*For current project status, see .planning/ROADMAP.md*
*Archived: 2026-02-02*
