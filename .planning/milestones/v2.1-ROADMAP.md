# Milestone v2.1: API Enhancement

**Status:** SHIPPED 2026-01-29
**Phases:** 19-21
**Total Plans:** 8

## Overview

v2.1 enhances GAZ's developer experience with interface auto-detection for lifecycle hooks, CLI args injection, testing utilities, and convenience APIs for building services and modules. All features build on v2.0's stable foundation without architectural changes.

## Phases

### Phase 19: Interface Auto-Detection + CLI Args

**Goal**: Services with lifecycle interfaces are automatically detected, and CLI args are accessible via DI
**Depends on**: v2.0 complete (Phase 18)
**Plans**: 3 plans

Plans:
- [x] 19-01-PLAN.md - [TDD] Lifecycle Auto-Detection
- [x] 19-02-PLAN.md - CLI Arguments Integration
- [x] 19-03-PLAN.md - Lifecycle Hook Mutual Exclusion

**Details:**
- Implemented automatic detection of Starter/Stopper interfaces using reflection
- Services implementing lifecycle interfaces have hooks called without explicit registration
- CLI positional arguments accessible via `gaz.GetArgs(container)` helper
- `CommandArgs` struct provides access to `*cobra.Command` and `Args []string`
- Explicit `.OnStart()/.OnStop()` registration takes precedence over interface detection

### Phase 20: Testing Utilities (gaztest)

**Goal**: Testing DI apps is easy with proper utilities and automatic cleanup
**Depends on**: Phase 19
**Plans**: 2 plans

Plans:
- [x] 20-01-PLAN.md - [TDD] Core gaztest package (Builder, App, TB interface)
- [x] 20-02-PLAN.md - Integration tests and examples

**Details:**
- `gaztest.New(t)` creates test app that automatically cleans up via `t.Cleanup()`
- `RequireStart()`/`RequireStop()` fail tests on error with `t.Fatal()`
- Test apps use shorter default timeouts (5s) suitable for testing
- `Replace(mock)` allows swapping dependencies for mocks
- fxtest-inspired pattern: Builder -> Build -> RequireStart -> test -> RequireStop
- 94.2% test coverage for gaztest package

### Phase 21: Service Builder + Unified Provider

**Goal**: Creating production-ready services and reusable modules is streamlined
**Depends on**: Phase 20
**Plans**: 3 plans

Plans:
- [x] 21-01-PLAN.md - [TDD] ModuleBuilder Core + App.Use()
- [x] 21-02-PLAN.md - Service Builder + Health Auto-Registration
- [x] 21-03-PLAN.md - Module Flags Integration

**Details:**
- `NewModule(name)` returns fluent `ModuleBuilder` for bundling registrations
- `ModuleBuilder.Provide()` adds provider functions to the module
- `ModuleBuilder.Flags()` registers command-line flags for the module
- `ModuleBuilder.Use()` allows module composition (child modules applied before parent)
- `App.Use(Module)` applies all bundled registrations to an App
- `service.New()` creates pre-configured App with standard providers
- Health module auto-registers when config implements `HealthConfigProvider` interface

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**

- Used reflection on zero value and pointer to check Starter/Stopper implementation
- Test apps registered with t.Cleanup() for automatic cleanup at Build() time
- Child modules applied in order before parent's providers
- Module flags applied to PersistentFlags on cobra command
- Health config registered as instance before health module is applied

**Issues Resolved:**

- Gap where services implementing lifecycle interfaces weren't auto-detected
- Testing DI apps required manual cleanup and boilerplate
- No standard pattern for bundling CLI flags with providers

**Issues Deferred:**

- Build Info package (version, commit, branch via ldflags) - deferred to later
- Pre/Post run hooks for App - deferred to later
- Frame introspection utilities - deferred to later

**Technical Debt Incurred:**

None

---

*For current project status, see .planning/ROADMAP.md*
