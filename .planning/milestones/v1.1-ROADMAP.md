# Milestone v1.1: Security & Hardening

**Status:** SHIPPED 2026-01-27
**Phases:** 7-10
**Total Plans:** 12

## Overview

Milestone v1.1 hardens the `gaz` framework for production use by introducing two critical control gates: strict configuration validation at startup and guaranteed timeout enforcement at shutdown. This ensures applications never run in an undefined state and never hang indefinitely during rollouts.

## Phases

### Phase 7: Validation Engine

**Goal**: Users can define struct tags that prevent application startup if configuration is invalid.
**Depends on**: None (builds on v1.0 Config)
**Plans**: 2 plans

Plans:
- [x] 07-01-PLAN.md — Core implementation: validator dependency, validation.go, ConfigManager integration
- [x] 07-02-PLAN.md — Comprehensive tests: basic tags, cross-field, nested structs, error formatting

**Details:**

**Requirements:**
- **VAL-01**: Config manager validates structs using `validate` tags upon load
- **VAL-02**: Application fails to start (exits) if config validation fails
- **VAL-03**: Config validation supports cross-field constraints (required_if, etc)

**Success Criteria:**
1. User can add `validate:"required"` to a config struct field and see it enforced.
2. Application exits with non-zero code immediately if validation fails.
3. User sees a human-readable error message listing specifically which fields failed validation.
4. User can use complex rules like `required_if` to validate dependencies between config fields.

---

### Phase 8: Hardened Lifecycle

**Goal**: Application guarantees process termination within a fixed timeout, preventing zombie processes.
**Depends on**: Phase 7 (Stable startup required for stable shutdown testing)
**Plans**: 3 plans

Plans:
- [x] 08-01-PLAN.md — Shutdown orchestrator with per-hook timeout and blame logging
- [x] 08-02-PLAN.md — Double-SIGINT force exit handling
- [x] 08-03-PLAN.md — Comprehensive shutdown hardening tests

**Details:**

**Requirements:**
- **LIFE-01**: Application enforces a hard timeout (default 30s) on shutdown
- **LIFE-02**: Application forces `os.Exit(1)` if shutdown hooks exceed timeout
- **LIFE-03**: Application exits immediately if SIGINT received twice
- **LIFE-04**: Application logs which specific lifecycle hook caused a shutdown hang

**Success Criteria:**
1. Application shuts down gracefully if all hooks complete within timeout.
2. Application forcefully exits (exit code 1) if a hook sleeps longer than the timeout (simulated).
3. Logs explicitly identify the component name of the hook that caused the timeout.
4. Pressing Ctrl+C twice triggers an immediate exit without waiting for the graceful timeout.

---

### Phase 9: Provider Config Registration

**Goal**: Services/providers can register flags/config keys on the app config manager.
**Depends on**: Phase 8
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md — Define ConfigProvider interface, ConfigFlag struct, ErrConfigKeyCollision
- [x] 09-02-PLAN.md — App integration, ConfigManager wiring, ProviderValues, comprehensive tests

**Details:**

**Requirements:**
- **PROV-01**: Providers can implement ConfigProvider interface to declare config needs
- **PROV-02**: Provider config keys are auto-prefixed with declared namespace
- **PROV-03**: Duplicate config keys from different providers fail at Build() with clear error
- **PROV-04**: Config values are injectable via ProviderValues type

**Success Criteria:**
1. Provider implementing ConfigProvider has config collected during Build()
2. Keys are auto-prefixed (e.g., redis + host = redis.host)
3. Two providers registering same key fails with ErrConfigKeyCollision
4. Required flags missing fails Build() with clear error message
5. ProviderValues injectable and provides typed getters (GetString, GetInt, etc)
6. Env vars work with translated names (redis.host -> REDIS_HOST)

---

### Phase 10: Documentation & Examples

**Goal**: Comprehensive documentation and examples demonstrating all library features.
**Depends on**: Phase 9 (All features complete before documenting)
**Plans**: 5 plans

Plans:
- [x] 10-01-PLAN.md — README.md and package doc.go
- [x] 10-02-PLAN.md — Documentation guides (docs/*.md)
- [x] 10-03-PLAN.md — Testable godoc examples
- [x] 10-04-PLAN.md — Basic example applications (basic, lifecycle, config-loading)
- [x] 10-05-PLAN.md — Advanced example applications (http-server, modules, cobra-cli)

**Details:**

**Requirements:**
- **DOC-01**: All public APIs documented with usage examples
- **DOC-02**: Working example applications demonstrating common patterns
- **DOC-03**: API reference with complete type documentation

**Success Criteria:**
1. README covers installation, quick start, and core concepts.
2. Each major feature (DI, Config, Lifecycle, Validation, Providers) has dedicated documentation.
3. Example applications compile and run successfully.
4. API reference generated and accessible.

---

## Milestone Summary

**Key Decisions:**
- Decision: Use go-playground/validator (Rationale: Industry-standard, cross-field support)
- Decision: Per-hook timeout with blame logging (Rationale: Debugging hung shutdowns)
- Decision: exitFunc global for test injection (Rationale: Necessary for shutdown testing)
- Decision: Skip transient services in config collection (Rationale: Avoid side effects)

**Issues Resolved:**
- Config validation at startup prevents undefined runtime state
- Shutdown timeout prevents zombie processes in container orchestration
- Provider config registration simplifies service configuration

**Issues Deferred:**
- Custom validation function registration (VAL-04) deferred to v2

**Technical Debt Incurred:**
- exitFunc global variable (Low) - necessary for testing, has nolint directive
- configValidator singleton (Low) - documented design choice for performance
- Deprecated NewApp() still exists (Low) - marked deprecated, redirects to New()

---

*For current project status, see .planning/ROADMAP.md*
