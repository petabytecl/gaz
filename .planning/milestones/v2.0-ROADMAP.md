# Milestone v2.0: Cleanup & Concurrency

**Status:** ✅ SHIPPED 2026-01-29
**Phases:** 11-18 (12 phases including inserted)
**Total Plans:** 34

## Overview

This milestone cleaned up deprecated code, extracted DI and Config into standalone packages, and added concurrency primitives (Workers, Cron, EventBus) that integrate with the existing lifecycle system. The cleanup phase removed technical debt before building new features. Package extractions enabled standalone usage of DI and Config without the full framework. Concurrency primitives leverage gaz's existing Starter/Stopper lifecycle for seamless integration.

## Phases

### Phase 11: Cleanup

**Goal**: Remove all deprecated code and update all examples/tests to use generic fluent API.
**Depends on**: Nothing (first phase of v2.0)
**Plans**: 2 plans

Plans:
- [x] 11-01-PLAN.md — Remove deprecated APIs and migrate tests to For[T]()
- [x] 11-02-PLAN.md — Rewrite examples and update documentation

**Details:**
Removed deprecated NewApp(), AppOption, and all reflection-based Provide* methods. Updated all tests and examples to use the For[T]() fluent registration pattern. Retained registerInstance() internally for WithConfig.

---

### Phase 12: DI Package

**Goal**: Extract DI into `gaz/di` subpackage that works standalone without gaz App.
**Depends on**: Phase 11
**Plans**: 4 plans

Plans:
- [x] 12-01-PLAN.md — Create di package with core DI types (Container, For, Resolve, accessor methods)
- [x] 12-02-PLAN.md — Add introspection APIs and backward compatibility wrappers
- [x] 12-03-PLAN.md — Update App to use di.Container, remove redundant root files
- [x] 12-04-PLAN.md — Create di package tests and update root package tests

**Details:**
Created standalone `gaz/di` package with New(), For[T](), Resolve[T](), MustResolve[T](). Exported ServiceWrapper interface for App integration. Root package re-exports for backward compatibility.

---

### Phase 13: Config Package

**Goal**: Extract Config into `gaz/config` subpackage with Backend interface abstracting viper.
**Depends on**: Phase 12
**Plans**: 4 plans

Plans:
- [x] 13-01-PLAN.md — Create config package with Backend interfaces and ViperBackend
- [x] 13-02-PLAN.md — Create Manager, options, validation, and generic accessors
- [x] 13-03-PLAN.md — Integrate config package with App and backward compatibility
- [x] 13-04-PLAN.md — Create config package tests and verify all tests pass

**Details:**
Created `gaz/config` with Backend interface, Watcher, Writer, EnvBinder composed interfaces. ViperBackend in subpackage to isolate viper dependency. Manager with Load(), Get[T]() accessors.

---

### Phase 14: Workers

**Goal**: Add background worker support with lifecycle integration, graceful shutdown, and panic recovery.
**Depends on**: Phase 13
**Plans**: 4 plans

Plans:
- [x] 14-01-PLAN.md — Worker interface, options, backoff configuration, jpillora/backoff dependency
- [x] 14-02-PLAN.md — WorkerManager and Supervisor with panic recovery and circuit breaker
- [x] 14-03-PLAN.md — App integration with auto-discovery and lifecycle
- [x] 14-04-PLAN.md — Tests and verify all tests pass

**Details:**
Worker interface with Start(), Stop(), Name(). Supervisor with panic recovery and circuit breaker. Workers auto-discovered during Build() and integrated with lifecycle (start after Starters, stop before Stoppers).

---

### Phase 14.1: Cleanup Deprecated Re-exports (INSERTED)

**Goal**: Remove backward compatibility re-exports from root gaz package, only keep methods that make sense and we plan to maintain long-term.
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:
- [x] 14.1-01-PLAN.md — Remove deprecated config re-exports (delete options.go, config.go, update errors.go)
- [x] 14.1-02-PLAN.md — Update tests and documentation to use config.* imports

**Details:**
Removed deprecated config re-exports. Kept DI error aliases as ergonomic conveniences. NewContainer retained as permanent convenience API.

---

### Phase 14.2: Update All Relevant Documentation and Examples (INSERTED)

**Goal:** Update all documentation (README, godoc, examples) to use v2.0 APIs: For[T]() pattern, explicit config package imports, and ConfigProvider pattern.
**Depends on:** Phase 14.1
**Plans**: 4 plans

Plans:
- [x] 14.2-01-PLAN.md — Rewrite getting-started.md and concepts.md with For[T]() API
- [x] 14.2-02-PLAN.md — Rewrite configuration.md and validation.md with config package patterns
- [x] 14.2-03-PLAN.md — Update advanced.md, README.md (worker feature), and CHANGELOG.md (package additions)
- [x] 14.2-04-PLAN.md — Create package READMEs (di, config, worker) and update config-loading example README

**Details:**
All documentation updated to show For[T]() as sole registration pattern. ConfigProvider pattern documented as primary config approach. Package READMEs created for di, config, worker subpackages.

---

### Phase 14.3: Flag-Based Config Registration (INSERTED)

**Goal:** Change config pattern so providers/services register required configs via flags and fetch values in constructor before build. Remove generic struct loading pattern from examples.
**Depends on:** Phase 14.2
**Plans**: 1 plan

Plans:
- [x] 14.3-01-PLAN.md — Rewrite config-loading example to use ConfigProvider pattern

**Details:**
Replaced struct-based config loading with flag-based ConfigProvider pattern. ProviderValues resolved in main() after Build().

---

### Phase 14.4: Config Flag and ProviderValues (INSERTED)

**Goal:** Add `WithConfigFile()` option for explicit config paths and enable ProviderValues injection inside provider functions.
**Depends on:** Phase 14.3
**Plans**: 1 plan

Plans:
- [x] 14.4-01-PLAN.md — Config file path support and early ProviderValues registration

**Details:**
WithConfigFile() for explicit config file paths. ProviderValues registered before collectProviderConfigs in Build() for use inside providers.

---

### Phase 15: Cron

**Goal**: Add scheduled task support wrapping robfig/cron with DI-aware jobs and graceful shutdown.
**Depends on**: Phase 14
**Plans**: 4 plans

Plans:
- [x] 15-01-PLAN.md — CronJob interface and package foundation
- [x] 15-02-PLAN.md — Scheduler and DI-aware job wrapper
- [x] 15-03-PLAN.md — App integration and lifecycle management
- [x] 15-04-PLAN.md — Tests and verification

**Details:**
CronJob interface with Name(), Schedule(), Timeout(), Run(). Scheduler wrapping robfig/cron v3 with DI-aware job wrapper and panic recovery. Scheduler implements worker.Worker for lifecycle integration.

---

### Phase 16: EventBus

**Goal**: Add type-safe in-process pub/sub with generics API and DI integration.
**Depends on**: Phase 14
**Plans**: 4 plans

Plans:
- [x] 16-01-PLAN.md — Event interface, Handler type, Subscription, and options
- [x] 16-02-PLAN.md — EventBus core with Subscribe/Publish and lifecycle
- [x] 16-03-PLAN.md — App integration with DI registration and WorkerManager
- [x] 16-04-PLAN.md — Tests and verification

**Details:**
Type-safe EventBus with Publish[T]() and Subscribe[T]() generics. Async fire-and-forget delivery with per-subscription bounded buffers. Topic filtering and context propagation. Integrates with DI container and WorkerManager.

---

### Phase 17: Cobra CLI Flags

**Goal:** Expose ConfigProvider flags to Cobra CLI - auto-register provider config flags as cobra command flags for CLI override and --help visibility.
**Depends on:** Phase 16
**Plans:** 2 plans

Plans:
- [x] 17-01-PLAN.md — Add FlagBinder interface and RegisterCobraFlags method
- [x] 17-02-PLAN.md — Comprehensive tests for flag registration and CLI override

**Details:**
RegisterCobraFlags(cmd) method for explicit flag registration before Execute(). FlagBinder interface for pflag binding. Key transformation: server.host → --server-host. Viper binding with original dot-notation for correct precedence.

---

### Phase 18: System Info CLI Example

**Goal:** Create system info CLI example showcasing DI, ConfigProvider, Workers, and Cobra integration.
**Depends on:** Phase 17
**Plans:** 2 plans

Plans:
- [x] 18-01-PLAN.md — ConfigProvider and Collector with gopsutil integration
- [x] 18-02-PLAN.md — Worker, main.go with RegisterCobraFlags, and README

**Details:**
ConfigProvider with sysinfo.refresh, sysinfo.format, sysinfo.once flags. Collector using gopsutil/v4 for CPU, memory, disk, host info. Worker with graceful shutdown. RegisterCobraFlags for --help visibility.

---

## Milestone Summary

**Decimal Phases:**
- Phase 14.1: Cleanup Deprecated Re-exports (inserted after Phase 14 for API cleanup)
- Phase 14.2: Update Documentation and Examples (inserted for v2.0 API documentation)
- Phase 14.3: Flag-Based Config Registration (inserted for ConfigProvider pattern)
- Phase 14.4: Config Flag/ProviderValues (inserted for config file and early values)

**Key Decisions:**
- Decision: For[T]() is the sole registration API (Rationale: Type-safe, no reflection)
- Decision: Renamed NewContainer() → New() (Rationale: Idiomatic Go constructor)
- Decision: Composed interfaces for config Backend (Rationale: Optional capabilities)
- Decision: Circuit breaker hand-rolled (Rationale: Simple counter+window sufficient)
- Decision: Scheduler implements Worker interface (Rationale: Unified lifecycle)
- Decision: Async fire-and-forget for EventBus (Rationale: Non-blocking publish)

**Issues Resolved:**
- Removed all deprecated reflection-based APIs
- Extracted DI and Config to standalone packages
- Unified worker lifecycle (Workers, Cron, EventBus all use worker.Worker pattern)
- CLI flag visibility via RegisterCobraFlags

**Issues Deferred:**
- Worker pools with configurable size (deferred to v2.1)
- Koanf backend (deferred to v2.1)

**Technical Debt Incurred:**
- None — all phases verified clean with no TODO/FIXME comments

---

*For current project status, see .planning/ROADMAP.md*
*Archived: 2026-01-29*
