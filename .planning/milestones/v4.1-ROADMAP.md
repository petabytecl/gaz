# Milestone v4.1: Server & Transport Layer

**Status:** SHIPPED 2026-02-04
**Phases:** 37-45 (including 38.1 INSERTED)
**Total Plans:** 23

## Overview

Milestone v4.1 transforms `gaz` into a production-ready application server by implementing a dual-port architecture (gRPC + HTTP Gateway). This roadmap delivers the "Dynamic Gateway" pattern, where HTTP traffic is transparently proxied to gRPC services via auto-discovery. This requires a fundamental upgrade to the Core DI engine (`di.List[T]`) to support service enumeration, followed by the implementation of the transport and observability layers.

## Phases

### Phase 37: Core Discovery

**Goal:** Enable the container to resolve all registered providers of a type to support auto-discovery patterns.
**Depends on:** None
**Requirements:** CORE-01
**Plans:** 2/2 plans complete

Plans:
- [x] 37-01-PLAN.md — Refactor Core DI engine & Implement Discovery API
- [x] 37-02-PLAN.md — Verify Discovery with Plugin Example

**Details:**
- Enabled `di.List[T]` for multi-binding resolution
- Added `gaz.ResolveAll` and `gaz.ResolveGroup` discovery APIs
- Plugin pattern example demonstrating auto-discovery

### Phase 38: Transport Foundations

**Goal:** Establish independent, production-ready gRPC and HTTP listeners on configurable ports.
**Depends on:** Phase 37
**Requirements:** TRN-01, TRN-02, TRN-03, GW-01
**Plans:** 3/3 plans complete

Plans:
- [x] 38-01-PLAN.md — gRPC Server with interceptors, reflection, service discovery
- [x] 38-02-PLAN.md — HTTP Server with configurable timeouts
- [x] 38-03-PLAN.md — Unified module and tests

**Details:**
- gRPC server with logging/recovery interceptors and reflection
- HTTP server with Read/Write/Idle/Header timeout protection
- Unified `server.NewModule` composing both servers

### Phase 38.1: gRPC and HTTP Server CLI Flags (INSERTED)

**Goal:** Enable gRPC and HTTP servers to register CLI flags for configuring ports and core settings.
**Depends on:** Phase 38
**Requirements:** Derived from TRN-01, TRN-02
**Plans:** 1/1 plan complete

Plans:
- [x] 38.1-01-PLAN.md — Add NewModuleWithFlags returning gaz.Module with CLI flags

**Details:**
- `--grpc-port`, `--grpc-reflection`, `--grpc-dev` flags
- `--http-port` flag for HTTP server
- Backward-compatible API with NewModule() preserved

### Phase 39: Gateway Integration

**Goal:** Unify HTTP and gRPC via a dynamic, auto-discovering Gateway layer.
**Depends on:** Phase 37 (Discovery), Phase 38 (Servers)
**Requirements:** GW-02, GW-03, GW-04
**Plans:** 3/3 plans complete

Plans:
- [x] 39-01-PLAN.md — Core Gateway package (config, headers, gateway, errors)
- [x] 39-02-PLAN.md — Gateway module with DI and CLI flags
- [x] 39-03-PLAN.md — Comprehensive tests (92% coverage)

**Details:**
- Dynamic registration via `Registrar` interface
- HTTP→gRPC proxy via loopback connection
- CORS support with configurable origins/methods/headers
- RFC 7807 error responses

### Phase 40: Observability & Health

**Goal:** Expose standard health checks and telemetry for production monitoring.
**Depends on:** Phase 38 (Servers)
**Requirements:** INF-01, INF-02, INF-03
**Plans:** 3/3 plans complete

Plans:
- [x] 40-01-PLAN.md — Health check interface, aggregator, gRPC health server
- [x] 40-02-PLAN.md — OpenTelemetry TracerProvider and server instrumentation
- [x] 40-03-PLAN.md — PGX health check and comprehensive tests

**Details:**
- gRPC Health Server with polling-based status sync
- OpenTelemetry TracerProvider with OTLP export
- PGX health check for PostgreSQL connectivity
- Auto gRPC health integration in server/grpc

### Phase 41: Refactor Server Module Architecture and Consistency

**Goal:** Ensure architectural consistency, robust lifecycle management, and standard patterns across server modules.
**Depends on:** Phase 40
**Plans:** 4/4 plans complete

Plans:
- [x] 41-01-PLAN.md — Standardize Logger Usage
- [x] 41-02-PLAN.md — Gateway atomic handler and naming consistency
- [x] 41-03-PLAN.md — Simplify server module and config consistency
- [x] 41-04-PLAN.md — Integrate health check into gRPC server

**Details:**
- Logger fallback to slog.Default() across all server packages
- Atomic handler for race-free dynamic handler updates
- ConfigProvider pattern for all server modules
- Native health integration in gRPC server

### Phase 42: Refactor Framework Ergonomics

**Goal:** Improve library ergonomics to achieve expected DX (config/flags, signals, blocking).
**Depends on:** Phase 41
**Plans:** 3/3 plans complete

Plans:
- [x] 42-01-PLAN.md — Enable deferred flag registration and recursive module flag collection
- [x] 42-02-PLAN.md — Update Cobra integration to apply deferred flags and provide default lifecycle
- [x] 42-03-PLAN.md — Refactor gRPC Gateway example to demonstrate new ergonomics

**Details:**
- Deferred flag registration decouples App.Use from Cobra
- Cobra lifecycle management with proper shutdown handling
- Zero-boilerplate configuration in examples
- Auto-discovery of local gRPC port in Gateway module

### Phase 43: Logger CLI Flags

**Goal:** Enable logger configuration via CLI flags by deferring logger creation to Build() and adding logger module.
**Depends on:** Phase 42
**Plans:** 2/2 plans complete

Plans:
- [x] 43-01-PLAN.md — Restructure App to defer Logger initialization to Build()
- [x] 43-02-PLAN.md — Create logger module with CLI flag support

**Details:**
- `--log-level`, `--log-format`, `--log-output`, `--log-add-source` flags
- Deferred logger/subsystem initialization until Build()
- logger/module subpackage to avoid circular imports

### Phase 44: Config File CLI Flag

**Goal:** Enable configuration to register a `--config` flag to receive a config file path as an argument.
**Depends on:** Phase 43
**Plans:** 1/1 plans complete

Plans:
- [x] 44-01-PLAN.md — Add --config, --env-prefix, --config-strict CLI flags with auto-search

**Details:**
- `--config`, `--env-prefix`, `--config-strict` flags
- Auto-search in cwd and XDG config directories
- Strict mode defaults to true for early typo detection

### Phase 45: Cleanup Pre-Milestone Closure

**Goal:** Clean up dead code and reduce duplication to maintain codebase quality before closing the milestone.
**Depends on:** Phase 44
**Plans:** 1/1 plans complete

Plans:
- [x] 45-01-PLAN.md — Delete dead code and consolidate lifecycle types

**Details:**
- Deleted ~110 lines of dead code from di/lifecycle_engine.go
- Consolidated lifecycle types via type aliases

---

## Milestone Summary

**Decimal Phases:**
- Phase 38.1: gRPC/HTTP CLI Flags (inserted after Phase 38 for CLI configuration support)

**Key Decisions:**
- Port Separation: Running Gateway and gRPC on separate ports to avoid cmux complexity
- Auto-Discovery: Gateway uses di.List[Registrar] to find services via DI
- Implicit Collection: Register appends duplicates instead of returning error
- HTTP Default Port 8080, gRPC Default Port 50051
- ReadHeaderTimeout 5s prevents slow loris attacks
- grpc.NewClient used instead of deprecated grpc.Dial
- OTEL graceful degradation returns nil TracerProvider when collector unreachable
- Logger fallback to slog.Default() makes logger module optional
- Atomic handler for race-free dynamic handler updates
- Deferred flag registration decouples App.Use from Cobra
- WithCobra as Option to gaz.New() for flag availability before logger creation
- Config module uses "config-flags" name to avoid collision
- Strict mode defaults to true for early typo detection
- Type aliasing for lifecycle type consolidation

**Issues Resolved:**
- Gateway race condition fixed with atomic handler
- Server modules now respect default config flags
- Logger circular import resolved via subpackage pattern
- Dead code removed from di package

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None

---

*For current project status, see .planning/ROADMAP.md (next milestone)*
