---
phase: 27-error-standardization
plan: 04
type: execute
wave: 3
depends_on: ["27-02", "27-03"]
files_modified:
  - worker/errors.go
  - worker/manager.go
  - worker/circuit.go
  - cron/scheduler.go
  - gaz/app.go
  - gaz/app_use.go
  - gaz/provider_config.go
autonomous: true

must_haves:
  truths:
    - "worker package no longer defines its own sentinel errors"
    - "cron inline error replaced with gaz.ErrCronNotRunning"
    - "All error references use gaz.Err* naming"
    - "errors.Is/As work correctly for all gaz error types"
  artifacts:
    - path: "worker/manager.go"
      provides: "Worker manager using gaz errors"
      contains: "gaz.ErrWorker"
    - path: "cron/scheduler.go"
      provides: "Scheduler using gaz.ErrCronNotRunning"
      contains: "gaz.ErrCronNotRunning"
  key_links:
    - from: "worker/*.go"
      to: "gaz/errors.go"
      via: "import and error references"
      pattern: "gaz\\.ErrWorker"
---

<objective>
Complete error migration: worker package, cron package, and gaz package updates.

Purpose: Finish ERR-01, ERR-02, ERR-03 requirements with all packages using consolidated errors
Output: All error references migrated, all tests passing, v3 error standardization complete
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-error-standardization/27-CONTEXT.md
@.planning/phases/27-error-standardization/27-02-SUMMARY.md
@.planning/phases/27-error-standardization/27-03-SUMMARY.md
@gaz/errors.go
@worker/errors.go
@worker/manager.go
@cron/scheduler.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate worker and cron packages</name>
  <files>worker/errors.go, worker/manager.go, worker/circuit.go, cron/scheduler.go</files>
  <action>
**Worker package:**
1. Add import `"github.com/petabytecl/gaz"` to worker/*.go files that use errors
2. Replace error references:
   - `ErrCircuitBreakerTripped` → `gaz.ErrWorkerCircuitTripped`
   - `ErrWorkerStopped` → `gaz.ErrWorkerStopped`
   - `ErrCriticalWorkerFailed` → `gaz.ErrWorkerCriticalFailed`
   - `ErrManagerAlreadyRunning` → `gaz.ErrWorkerManagerRunning`
3. Delete `worker/errors.go`
4. Update wrapping to "worker: context: %w" format

**Cron package:**
1. Add import `"github.com/petabytecl/gaz"` to cron/scheduler.go
2. Replace inline error:
   ```go
   // Before
   return errors.New("scheduler not running")
   // After
   return gaz.ErrCronNotRunning
   ```
3. Update any other wrapping to "cron: context: %w" format
  </action>
  <verify>
Run `go build ./worker/... ./cron/...` - should compile
  </verify>
  <done>
worker/errors.go deleted, worker and cron packages use gaz.ErrWorker* and gaz.ErrCronNotRunning
  </done>
</task>

<task type="auto">
  <name>Task 2: Update gaz package and all remaining tests</name>
  <files>gaz/*.go, gaz/*_test.go, worker/*_test.go, cron/*_test.go</files>
  <action>
**gaz package main files:**
1. In `app.go`, `app_use.go`, `provider_config.go`, etc:
   - Ensure error references use new names from gaz/errors.go directly
   - Update `ErrDuplicateModule` → already defined in errors.go, just reference it
   - Update `ErrConfigKeyCollision` → already defined in errors.go
   - Remove any imports from di, config, worker error packages if now unnecessary

2. In `provider_config.go`:
   - Replace `config.ErrKeyNotFound` → `ErrConfigNotFound` (local, same package)

**Test files - update all error assertions:**

gaz/*_test.go:
- `gaz.ErrDuplicate` → `gaz.ErrDIDuplicate`
- `gaz.ErrNotFound` → `gaz.ErrDINotFound`
- `gaz.ErrCycle` → `gaz.ErrDICycle`
- `config.ErrConfigValidation` → `gaz.ErrConfigValidation`
- `config.ErrKeyNotFound` → `gaz.ErrConfigNotFound`

worker/*_test.go:
- `worker.ErrCircuitBreakerTripped` → `gaz.ErrWorkerCircuitTripped`
- `worker.ErrWorkerStopped` → `gaz.ErrWorkerStopped`
- `worker.ErrManagerAlreadyRunning` → `gaz.ErrWorkerManagerRunning`

cron/*_test.go:
- Verify any error checks use new naming
  </action>
  <verify>
Run `go test ./...` - all tests should pass
  </verify>
  <done>
All test files updated to use new error names, all tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and documentation</name>
  <files>None (verification only)</files>
  <action>
Run comprehensive verification:

1. **No stale error files:**
   - `ls di/errors.go config/errors.go worker/errors.go` - all should be "No such file"

2. **No stale error references:**
   - `grep -r "di\.ErrNotFound\|di\.ErrCycle" --include="*.go" .` - should find nothing
   - `grep -r "config\.ErrConfigValidation\|config\.ErrKeyNotFound" --include="*.go" .` - should find nothing (except comments/docs if any)
   - `grep -r "worker\.Err" --include="*.go" .` - should find nothing

3. **All tests pass:**
   - `go test ./...` - full test suite

4. **Verify errors.Is works correctly:**
   - Check that existing tests using `errors.Is` still work
   - ValidationError.Unwrap() returns ErrConfigValidation so errors.Is works

5. **Verify doc.go examples:**
   - Update doc.go example to show `errors.Is(err, gaz.ErrDINotFound)` pattern
  </action>
  <verify>
All verification commands pass as described
  </verify>
  <done>
Phase 27 complete: ERR-01 (sentinels consolidated), ERR-02 (namespaced naming), ERR-03 (consistent wrapping)
  </done>
</task>

</tasks>

<verification>
1. `ls di/errors.go config/errors.go worker/errors.go` - all return "No such file"
2. `go build ./...` passes
3. `go test ./...` passes with no failures
4. `grep -rn "ErrNotFound\|ErrCycle\|ErrDuplicate" --include="*.go" . | grep -v "gaz\." | grep -v "_test.go"` shows no bare references in production code
5. Verify coverage remains above 90%
</verification>

<success_criteria>
- All subsystem errors.go files deleted (di, config, worker)
- All code uses gaz.ErrSubsystemAction naming
- All error wrapping uses "pkg: context: %w" format
- errors.Is/As work correctly through wrapping chain
- All tests pass
- Coverage >= 90%
</success_criteria>

<output>
After completion, create `.planning/phases/27-error-standardization/27-04-SUMMARY.md`
</output>
