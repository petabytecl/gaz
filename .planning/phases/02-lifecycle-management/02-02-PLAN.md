---
phase: 02
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [lifecycle.go, registration.go, service.go]
autonomous: true
must_haves:
  truths:
    - "User can register OnStart hooks via builder"
    - "User can register OnStop hooks via builder"
    - "Hooks accept context and return error"
    - "Service wrappers store these hooks"
  artifacts:
    - path: "lifecycle.go"
      provides: "Hook definitions"
    - path: "registration.go"
      provides: "Fluent configuration"
  key_links:
    - from: "RegistrationBuilder"
      to: "serviceWrapper"
      via: "transfer of hooks"
---

<objective>
Define lifecycle interfaces and update registration API to support hooks.

Purpose: Allow developers to attach startup/shutdown logic to services.
Output: Updated Builder API and Service wrappers capable of storing hooks.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@registration.go
@service.go

# Need to add OnStart/OnStop to RegistrationBuilder and transfer to serviceWrapper
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Lifecycle Types</name>
  <files>lifecycle.go</files>
  <action>
    Create `lifecycle.go`:
    - Define `HookFunc func(context.Context) error`.
    - Define `HookConfig` struct (for timeouts, etc.).
    - Define `HookOption func(*HookConfig)` (for future extensibility like `WithTimeout`).
    - Define `Starter` interface with `OnStart(context.Context) error`.
    - Define `Stopper` interface with `OnStop(context.Context) error`.
  </action>
  <verify>
    `go build lifecycle.go` checks syntax.
  </verify>
  <done>
    Types defined and exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Registration Builder</name>
  <files>registration.go</files>
  <action>
    Update `RegistrationBuilder[T]` struct:
    - Add `startHooks []HookFunc` (where HookFunc is internal generic wrapper).
    - Add `stopHooks []HookFunc`.
    
    Add methods to `RegistrationBuilder`:
    - `OnStart(fn func(context.Context, T) error, opts ...HookOption) *RegistrationBuilder[T]`
    - `OnStop(fn func(context.Context, T) error, opts ...HookOption) *RegistrationBuilder[T]`
    
    Implementation details:
    - Accept `opts` to configure the hook (e.g., timeout).
    - Create a wrapper closure that applies the options (e.g., creating a context with timeout) and invokes the user's typed function.
    - Store these wrappers to be passed to the `serviceWrapper` in `Provider()`.
    - `wrapperHook = func(ctx, instance any) error { ... apply opts ... return userHook(ctx, instance.(T)) }`.
  </action>
  <verify>
    Check `go doc` or compilation.
  </verify>
  <done>
    Builder supports type-safe hook registration with options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Service Wrappers</name>
  <files>service.go</files>
  <action>
    Update `serviceWrapper` interface:
    - Add `start(context.Context) error`
    - Add `stop(context.Context) error`
    - Add `hasLifecycle() bool` (optimization)
    
    Update `lazySingleton`, `eagerSingleton`, `instanceService`:
    - Add fields to store the hooks (as `func(context.Context, any) error`).
    - Implement `start/stop` methods that invoke these hooks with `s.instance`.
    - Ensure thread safety (read `s.instance` under lock if needed).
    
    Update `transientService`:
    - Implement no-op `start/stop` (or return error/log warning that transient services don't support app lifecycle).
    - For now, no-op is safest.
    
    Update constructors (`newLazySingleton`, etc.) in `service.go` and calls in `registration.go` to pass hooks.
  </action>
  <verify>
    `go test ./...`
  </verify>
  <done>
    Service wrappers can execute hooks on their instances.
  </done>
</task>

</tasks>

<verification>
Create a test in `registration_test.go` that registers a service with OnStart/OnStop, builds the container, and manually invokes the internal `start/stop` methods (via casting to private interface if needed, or just relying on unit tests in `service_test.go`).
</verification>

<success_criteria>
- [ ] RegistrationBuilder has OnStart/OnStop methods
- [ ] OnStart accepts typed `func(ctx, T) error` and options
- [ ] Service wrappers store and execute these hooks
- [ ] Transient services handle hooks gracefully (ignore or warn)
</success_criteria>

<output>
After completion, create `.planning/phases/02-lifecycle-management/02-02-SUMMARY.md`
</output>
