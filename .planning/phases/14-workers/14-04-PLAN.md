---
phase: 14-workers
plan: 04
type: execute
wave: 4
depends_on: ["14-03"]
files_modified:
  - worker/manager_test.go
  - worker/supervisor_test.go
  - worker/options_test.go
  - worker/backoff_test.go
  - app_worker_test.go
autonomous: true

must_haves:
  truths:
    - "Worker package has comprehensive test coverage (target 70%+)"
    - "Supervisor panic recovery is tested"
    - "Circuit breaker behavior is tested"
    - "App worker integration is tested end-to-end"
  artifacts:
    - path: "worker/manager_test.go"
      provides: "Manager tests"
      contains: "func TestManager"
    - path: "worker/supervisor_test.go"
      provides: "Supervisor tests including panic recovery"
      contains: "func TestSupervisor"
    - path: "app_worker_test.go"
      provides: "App integration tests for workers"
      contains: "func TestApp.*Worker"
  key_links:
    - from: "worker/supervisor_test.go"
      to: "worker/supervisor.go"
      via: "tests panic recovery and restart"
      pattern: "panic|recover"
    - from: "worker/manager_test.go"
      to: "worker/manager.go"
      via: "tests pool workers and lifecycle"
      pattern: "Register|Start|Stop"
---

<objective>
Create comprehensive tests for worker package and App integration, verify all existing tests pass.

Purpose: Ensure worker functionality is well-tested with coverage for panic recovery, restart behavior, circuit breaker, pool workers, and App lifecycle integration.
Output: Test files achieving 70%+ coverage for worker package.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-workers/14-CONTEXT.md
@.planning/phases/14-workers/14-RESEARCH.md
@.planning/phases/14-workers/14-01-SUMMARY.md
@.planning/phases/14-workers/14-02-SUMMARY.md
@.planning/phases/14-workers/14-03-SUMMARY.md

# Files to test
@worker/worker.go
@worker/manager.go
@worker/supervisor.go
@worker/options.go
@worker/backoff.go
@app.go

# Existing test patterns
@config/manager_test.go
@app_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create worker package unit tests</name>
  <files>worker/manager_test.go, worker/supervisor_test.go, worker/options_test.go, worker/backoff_test.go</files>
  <action>
Create comprehensive unit tests following existing patterns from config/manager_test.go:

**worker/options_test.go:**
- Test DefaultWorkerOptions() returns sensible defaults
- Test each option function (WithPoolSize, WithCritical, etc.)
- Test option chaining

**worker/backoff_test.go:**
- Test NewBackoffConfig() returns correct defaults (1s min, 5m max, factor 2, jitter true)
- Test NewBackoff() creates valid jpillora/backoff instance
- Test backoff.Duration() increases exponentially
- Test backoff.Reset() resets to minimum

**worker/supervisor_test.go:**
- **TestSupervisor_PanicRecovery:** Worker that panics is recovered, logged, and restarted
- **TestSupervisor_ExponentialBackoff:** Restart delays increase exponentially
- **TestSupervisor_CircuitBreaker:** After MaxRestarts in CircuitWindow, supervisor stops restarting
- **TestSupervisor_CleanExit:** Worker that exits cleanly is not restarted
- **TestSupervisor_StableRunResetBackoff:** After StableRunPeriod, backoff resets
- **TestSupervisor_CriticalWorkerCallback:** Critical worker trips circuit breaker and calls onCriticalFail

**worker/manager_test.go:**
- **TestManager_RegisterAndStart:** Workers are registered and started
- **TestManager_Stop:** All workers stop when manager stops
- **TestManager_PoolWorkers:** Pool workers get indexed names
- **TestManager_Done:** Done channel closes after all workers stop
- **TestManager_ConcurrentStart:** All workers start concurrently (not sequentially)
- **TestManager_DoubleStart:** Starting twice returns error
- **TestManager_RegisterWhileRunning:** Registering while running returns error

Use testify/require and testify/assert. Create mock Worker implementations for testing:
```go
type mockWorker struct {
    name       string
    startCount int
    stopCount  int
    started    chan struct{}
    stopped    chan struct{}
    panicOnStart bool
}

func (w *mockWorker) Start() {
    w.startCount++
    if w.panicOnStart {
        panic("intentional panic")
    }
    close(w.started)
}

func (w *mockWorker) Stop() {
    w.stopCount++
    close(w.stopped)
}

func (w *mockWorker) Name() string {
    return w.name
}
```
  </action>
  <verify>`go test ./worker/... -v` passes and `go test ./worker/... -cover` shows 70%+ coverage</verify>
  <done>Worker package unit tests with 70%+ coverage, testing panic recovery, backoff, circuit breaker</done>
</task>

<task type="auto">
  <name>Task 2: Create App integration tests and verify all tests pass</name>
  <files>app_worker_test.go</files>
  <action>
Create integration tests in root package:

**app_worker_test.go:**
- **TestApp_WorkerAutoDiscovery:** Worker registered via For[T] is auto-discovered
- **TestApp_WorkerStartsAfterServices:** Workers start after Starter hooks complete
- **TestApp_WorkerStopsBeforeServices:** Workers stop before Stopper hooks run
- **TestApp_WorkerPanicRecovery:** Worker panic doesn't crash app
- **TestApp_CriticalWorkerShutdown:** Critical worker failure triggers app shutdown

Create test worker implementations:
```go
type testWorker struct {
    name     string
    started  chan struct{}
    stopped  chan struct{}
    stopCh   chan struct{}
}

func NewTestWorker(name string) *testWorker {
    return &testWorker{
        name:    name,
        started: make(chan struct{}),
        stopped: make(chan struct{}),
        stopCh:  make(chan struct{}),
    }
}

func (w *testWorker) Start() {
    close(w.started)
    <-w.stopCh // Block until Stop() called
}

func (w *testWorker) Stop() {
    close(w.stopCh)
    close(w.stopped)
}

func (w *testWorker) Name() string {
    return w.name
}
```

**Verify all existing tests pass:**
```bash
go test ./... -v
```

Address any failures from existing tests due to App changes.

**Check coverage targets:**
- worker package: 70%+ (run `go test ./worker/... -cover`)
- Overall: should not decrease from current levels
  </action>
  <verify>`go test ./... -v` all pass and `go test ./worker/... -cover` shows 70%+ coverage</verify>
  <done>App integration tests pass, worker package at 70%+ coverage, all existing tests still pass</done>
</task>

</tasks>

<verification>
- [ ] `go test ./worker/... -v` all tests pass
- [ ] `go test ./worker/... -cover` shows 70%+ coverage
- [ ] `go test ./... -v` all tests pass (including existing tests)
- [ ] Panic recovery tested with intentional panic
- [ ] Circuit breaker tested with repeated failures
- [ ] Pool workers tested with indexed naming
- [ ] App integration tested end-to-end
</verification>

<success_criteria>
- Worker package coverage: 70%+ (same target as config package)
- All new tests pass
- All existing tests still pass (no regressions)
- Panic recovery is verified to work
- Circuit breaker is verified to trip after max failures
- Critical worker failure is verified to trigger app shutdown
</success_criteria>

<output>
After completion, create `.planning/phases/14-workers/14-04-SUMMARY.md`
</output>
