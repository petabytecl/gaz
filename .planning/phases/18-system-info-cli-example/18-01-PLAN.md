---
phase: 18-system-info-cli-example
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/system-info-cli/go.mod
  - examples/system-info-cli/config.go
  - examples/system-info-cli/collector.go
autonomous: true

must_haves:
  truths:
    - "ConfigProvider declares sysinfo.refresh, sysinfo.format, sysinfo.once flags"
    - "Collector gathers CPU, memory, disk, host info via gopsutil"
    - "Display supports text (tabwriter) and JSON formats"
  artifacts:
    - path: "examples/system-info-cli/config.go"
      provides: "SystemInfoConfig ConfigProvider"
      exports: ["SystemInfoConfig", "NewSystemInfoConfig"]
    - path: "examples/system-info-cli/collector.go"
      provides: "System info collection service"
      exports: ["SystemInfo", "Collector", "NewCollector"]
  key_links:
    - from: "config.go"
      to: "ProviderValues"
      via: "DI injection in NewSystemInfoConfig"
      pattern: "gaz\\.Resolve\\[\\*gaz\\.ProviderValues\\]"
    - from: "collector.go"
      to: "gopsutil packages"
      via: "import gopsutil/v4"
      pattern: "gopsutil/v4/(cpu|mem|disk|host)"
---

<objective>
Create the foundation for the system-info-cli example: ConfigProvider for flag-based configuration and Collector service for gopsutil data gathering.

Purpose: Establish the core types that main.go and Worker will depend on, demonstrating ConfigProvider pattern with typed accessor methods and gopsutil integration.

Output: config.go (ConfigProvider implementation) and collector.go (gopsutil wrapper with display formatting)
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-system-info-cli-example/18-RESEARCH.md
@examples/config-loading/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create example directory and ConfigProvider</name>
  <files>
    examples/system-info-cli/go.mod
    examples/system-info-cli/config.go
  </files>
  <action>
Create examples/system-info-cli/ directory.

Create go.mod:
```
module github.com/petabytecl/gaz/examples/system-info-cli

go 1.24.0

require (
    github.com/petabytecl/gaz v0.0.0
    github.com/shirou/gopsutil/v4 v4.25.0
    github.com/spf13/cobra v1.10.0
)

replace github.com/petabytecl/gaz => ../..
```

Create config.go implementing ConfigProvider with:
- SystemInfoConfig struct storing *gaz.ProviderValues
- ConfigNamespace() returning "sysinfo"
- ConfigFlags() declaring:
  - "refresh" (Duration, default 5*time.Second, "Refresh interval")
  - "format" (String, default "text", "Output format (text, json)")
  - "once" (Bool, default false, "Run once and exit")
- NewSystemInfoConfig(c *gaz.Container) resolving ProviderValues
- Typed accessor methods: RefreshInterval(), Format(), Once()

Follow the pattern from examples/config-loading/main.go exactly.
  </action>
  <verify>
File exists and compiles: `ls examples/system-info-cli/config.go`
  </verify>
  <done>
ConfigProvider with sysinfo namespace declaring refresh, format, once flags with typed accessors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Collector service with gopsutil integration</name>
  <files>
    examples/system-info-cli/collector.go
  </files>
  <action>
Create collector.go with:

1. SystemInfo struct containing:
   - Hostname, Platform string
   - Uptime uint64
   - CPUModel string, CPUCores int, CPUUsage float64
   - MemTotal, MemUsed uint64, MemPercent float64
   - DiskTotal, DiskUsed uint64, DiskPercent float64

2. Collector struct with format field (from config)

3. NewCollector(c *gaz.Container) (*Collector, error) resolving SystemInfoConfig and extracting format

4. Collect() (*SystemInfo, error) method:
   - Use host.Info() for hostname, platform, uptime
   - Use cpu.Info() for model, cores
   - Use cpu.Percent(100*time.Millisecond, false) for CPU usage (non-zero duration avoids empty on first call)
   - Use mem.VirtualMemory() for memory stats
   - Use disk.Usage("/") for disk stats (handle errors gracefully)

5. Display(info *SystemInfo) error method:
   - JSON format: json.NewEncoder with indentation
   - Text format: tabwriter with aligned columns showing:
     - System Information header
     - Hostname, Platform, Uptime (formatted as human-readable duration)
     - CPU section: Model, Cores, Usage%
     - Memory section: Total, Used (with %)
     - Disk section: Total, Used (with %)

Include helper functions:
- formatBytes(bytes uint64) string - convert to human readable (KB, MB, GB)
- formatDuration(seconds uint64) string - convert to "Xd Xh Xm" format

Import gopsutil/v4 subpackages (not v3):
- github.com/shirou/gopsutil/v4/cpu
- github.com/shirou/gopsutil/v4/mem
- github.com/shirou/gopsutil/v4/disk
- github.com/shirou/gopsutil/v4/host
  </action>
  <verify>
Run `cd examples/system-info-cli && go mod tidy && go build -o /dev/null .` to verify compilation (will fail on main.go missing, that's expected - just verify collector.go syntax)
  </verify>
  <done>
Collector service with Collect() gathering CPU/memory/disk/host info and Display() supporting text and JSON formats.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `ls examples/system-info-cli/` shows go.mod, config.go, collector.go
2. Files have proper package declaration (package main)
3. gopsutil v4 import paths used correctly
</verification>

<success_criteria>
- ConfigProvider implements ConfigNamespace() and ConfigFlags()
- Three config flags declared: sysinfo.refresh, sysinfo.format, sysinfo.once
- Collector.Collect() returns populated SystemInfo struct
- Collector.Display() outputs text or JSON based on format
- go mod tidy succeeds (dependencies resolve)
</success_criteria>

<output>
After completion, create `.planning/phases/18-system-info-cli-example/18-01-SUMMARY.md`
</output>
