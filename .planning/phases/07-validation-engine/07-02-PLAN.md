---
phase: 07-validation-engine
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - validation_test.go
autonomous: true

must_haves:
  truths:
    - "required validation tag rejects empty strings"
    - "min/max validation tags enforce numeric constraints"
    - "oneof validation tag restricts to allowed values"
    - "required_if cross-field validation works"
    - "nested struct validation works recursively"
    - "error messages show mapstructure field names, not Go field names"
    - "all validation errors are collected and shown together"
  artifacts:
    - path: "validation_test.go"
      provides: "Comprehensive validation test coverage"
      min_lines: 150
      contains: "TestValidation"
  key_links:
    - from: "validation_test.go"
      to: "validation.go"
      via: "validateConfigTags calls"
      pattern: "validateConfigTags"
    - from: "validation_test.go"
      to: "config_manager.go"
      via: "ConfigManager.Load() integration tests"
      pattern: "ConfigManager"
---

<objective>
Create comprehensive tests for the validation engine covering basic validation tags, cross-field validation, nested structs, and error formatting.

Purpose: Ensure validation works correctly for all supported scenarios and error messages are actionable.

Output: validation_test.go with full coverage of validation functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-validation-engine/07-01-SUMMARY.md

@validation.go
@config_manager.go
@config_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Basic validation tests</name>
  <files>validation_test.go</files>
  <action>
Create `validation_test.go` with testify suite structure matching existing test patterns in the codebase.

1. Create `ValidationSuite` with `suite.Suite` embedding.

2. Add test cases for basic validation tags:

   a) `TestRequiredValidation`:
   - Config struct with `validate:"required"` on string field
   - Empty value fails with "required field cannot be empty"
   - Non-empty value passes

   b) `TestMinMaxValidation`:
   - Config struct with `validate:"min=1,max=65535"` on int field
   - Value 0 fails with "must be at least 1"
   - Value 70000 fails with "must be at most 65535"
   - Value 8080 passes

   c) `TestOneOfValidation`:
   - Config struct with `validate:"oneof=debug info warn error"` on string field
   - Value "invalid" fails with "must be one of: debug info warn error"
   - Value "info" passes

   d) `TestNestedStructValidation`:
   - Config struct with nested struct having `validate:"required"` fields
   - Missing nested field fails with proper namespace path (e.g., "database.host:")
   - Fully populated nested struct passes

   e) `TestMapstructureFieldNames`:
   - Config struct with `mapstructure:"db_host"` and `validate:"required"`
   - Error message shows "db_host" not "DBHost"

   f) `TestAllErrorsCollected`:
   - Config struct with multiple invalid fields
   - All errors returned together (not just first)
   - Error contains multiple lines

3. Each test should:
   - Use descriptive test struct types (e.g., `RequiredConfig`, `PortConfig`)
   - Define struct inline in test for clarity
   - Check error message contains expected text
   - Use `s.Require().Error()` or `s.Require().NoError()` appropriately
  </action>
  <verify>
- `go test -v -run TestValidationSuite ./...` passes
- `grep -c "func (s \*ValidationSuite) Test" validation_test.go` shows 6+ test methods
- Tests cover: required, min, max, oneof, nested, field names, error collection
  </verify>
  <done>
- validation_test.go created with ValidationSuite
- Basic validation tag tests pass (required, min, max, oneof)
- Nested struct validation test passes
- Mapstructure field name test passes
- Error collection test passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Cross-field validation and integration tests</name>
  <files>validation_test.go</files>
  <action>
Extend `validation_test.go` with cross-field validation and ConfigManager integration tests:

1. Add cross-field validation tests:

   a) `TestRequiredIfValidation`:
   ```go
   type AuthConfig struct {
       Type     string `mapstructure:"type" validate:"required,oneof=none basic oauth"`
       Username string `mapstructure:"username" validate:"required_if=Type basic"`
       Password string `mapstructure:"password" validate:"required_if=Type basic"`
       Token    string `mapstructure:"token" validate:"required_if=Type oauth"`
   }
   ```
   - Type="basic" without username/password fails
   - Type="basic" with username/password passes
   - Type="oauth" without token fails
   - Type="oauth" with token passes
   - Type="none" passes without any auth fields

2. Add integration tests via ConfigManager:

   a) `TestConfigManagerValidation`:
   - Use ConfigManager.Load() with config struct having validate tags
   - Verify validation runs after defaults are applied
   - Verify error is returned when validation fails

   b) `TestValidationAfterDefaults`:
   - Config struct with Default() that sets required values
   - Without defaults: would fail required validation
   - With defaults applied first: passes validation
   - Verifies order: Unmarshal → Default() → validateConfigTags → Validate()

   c) `TestValidationBeforeCustomValidate`:
   - Config struct with both validate tags AND Validate() method
   - Tag validation runs first
   - If tags fail, Validate() method is NOT called
   - If tags pass, Validate() method IS called

3. Add error message format tests:

   a) `TestErrorMessageFormat`:
   - Verify error message format: `{namespace}: {message} (validate:"{tag}")`
   - Check humanized messages for each supported tag
   - Verify newline separation for multiple errors

4. Run full test suite to ensure no regressions.
  </action>
  <verify>
- `go test -v -run TestValidationSuite ./...` passes all tests
- `go test ./... -count=1` passes (no regressions in other tests)
- `grep -c "func (s \*ValidationSuite) Test" validation_test.go` shows 10+ test methods
- Cross-field validation (required_if) tested
- ConfigManager integration tested
  </verify>
  <done>
- Cross-field validation tests (required_if) pass
- ConfigManager integration tests pass
- Validation order tests pass (after defaults, before Validate())
- Error message format tests pass
- All existing tests pass (no regressions)
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. Full test suite passes:
   ```bash
   go test ./... -count=1 -v
   ```

2. Validation test coverage:
   ```bash
   go test -v -run TestValidationSuite ./...
   ```

3. No linting issues:
   ```bash
   make lint
   ```
</verification>

<success_criteria>
1. validation_test.go exists with comprehensive test coverage
2. Basic validation tags tested: required, min, max, oneof
3. Nested struct validation tested with proper namespace paths
4. Cross-field validation tested (required_if)
5. ConfigManager integration tested
6. Error message format verified
7. All tests pass, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-validation-engine/07-02-SUMMARY.md`
</output>
