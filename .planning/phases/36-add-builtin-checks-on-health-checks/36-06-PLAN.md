---
phase: 36-add-builtin-checks
plan: 06
type: execute
wave: 2
depends_on: []
files_modified:
  - health/checks/disk/disk.go
  - health/checks/disk/disk_test.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Developer can create disk space threshold check"
    - "Disk check fails when usage exceeds threshold percentage"
    - "gopsutil/v4 is added as dependency"
    - "Check works cross-platform (Linux, macOS, Windows)"
  artifacts:
    - path: "health/checks/disk/disk.go"
      provides: "Disk space health check factory"
      exports: ["Config", "New"]
    - path: "health/checks/disk/disk_test.go"
      provides: "Disk check tests"
      min_lines: 30
  key_links:
    - from: "health/checks/disk/disk.go"
      to: "github.com/shirou/gopsutil/v4/disk"
      via: "disk.UsageWithContext"
      pattern: "UsageWithContext"
---

<objective>
Create disk space health check using gopsutil for cross-platform compatibility.

Purpose: Provide a check for disk space to prevent disk-full failures affecting logging and temp files.
Output: health/checks/disk/ subpackage with Config + New factory
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-add-builtin-checks-on-health-checks/36-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement disk space check</name>
  <files>health/checks/disk/disk.go</files>
  <action>
Create health/checks/disk/disk.go:

```go
// Package disk provides a health check for disk space using gopsutil.
package disk

import (
    "context"
    "fmt"

    "github.com/shirou/gopsutil/v4/disk"
)

// Config configures the disk space health check.
type Config struct {
    // Path is the filesystem path to check. Required.
    // Use "/" for root filesystem on Unix, "C:" for Windows.
    Path string
    // ThresholdPercent is the maximum usage percentage allowed (0-100). Required.
    // Check fails if current usage exceeds this threshold.
    ThresholdPercent float64
}

// New creates a new disk space health check.
// Uses gopsutil for cross-platform disk usage reporting.
//
// Returns nil if usage is under threshold, error if exceeded.
func New(cfg Config) func(context.Context) error {
    return func(ctx context.Context) error {
        if cfg.Path == "" {
            return fmt.Errorf("disk: path is empty")
        }
        if cfg.ThresholdPercent <= 0 || cfg.ThresholdPercent > 100 {
            return fmt.Errorf("disk: threshold must be between 0 and 100, got %.1f", cfg.ThresholdPercent)
        }
        
        usage, err := disk.UsageWithContext(ctx, cfg.Path)
        if err != nil {
            return fmt.Errorf("disk: failed to get usage: %w", err)
        }
        if usage.UsedPercent > cfg.ThresholdPercent {
            return fmt.Errorf("disk: usage %.1f%% exceeds threshold %.1f%%", 
                usage.UsedPercent, cfg.ThresholdPercent)
        }
        return nil
    }
}
```

Run `go get github.com/shirou/gopsutil/v4` to add the dependency.

Key implementation notes:
- Uses gopsutil for cross-platform support (Linux, macOS, Windows)
- UsageWithContext respects context cancellation
- Threshold is percentage (0-100), not bytes
- Validates threshold at check time (not factory time) for consistent behavior
  </action>
  <verify>go build ./health/checks/disk/...</verify>
  <done>Disk check compiles with gopsutil/v4 dependency</done>
</task>

<task type="auto">
  <name>Task 2: Add disk check tests</name>
  <files>health/checks/disk/disk_test.go</files>
  <action>
Create health/checks/disk/disk_test.go with tests:

1. Test empty path returns error
2. Test invalid threshold (0, negative, >100) returns error
3. Test successful check with high threshold (99.9% - almost always passes)
4. Test failure with low threshold (0.1% - almost always fails)
5. Test invalid path returns error (use "/nonexistent/path/that/does/not/exist")

Note: These tests will actually check disk space on the test machine.
Use extreme thresholds to make tests deterministic:
- 99.9% threshold will pass unless disk is literally full
- 0.1% threshold will fail unless disk is almost empty
  </action>
  <verify>go test -v ./health/checks/disk/...</verify>
  <done>Disk check validates usage against threshold, all tests pass</done>
</task>

</tasks>

<verification>
```bash
# Verify dependency added
go list -m github.com/shirou/gopsutil/v4

# Run tests
go test -v ./health/checks/disk/...

# Verify full build
go build ./...

# Run all check package tests
go test -v ./health/checks/...
```
</verification>

<success_criteria>
- health/checks/disk/disk.go exports Config and New
- Config has Path and ThresholdPercent fields
- gopsutil/v4 added to go.mod
- Check uses disk.UsageWithContext for cross-platform support
- Tests verify threshold behavior with extreme values
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/36-add-builtin-checks-on-health-checks/36-06-SUMMARY.md`
</output>
