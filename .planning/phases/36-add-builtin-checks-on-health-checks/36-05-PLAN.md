---
phase: 36-add-builtin-checks
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - health/checks/redis/redis.go
  - health/checks/redis/redis_test.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Developer can create Redis health check by passing existing client"
    - "Redis check uses PING command to verify connectivity"
    - "Redis check accepts redis.UniversalClient interface"
    - "go-redis/v9 is added as dependency"
  artifacts:
    - path: "health/checks/redis/redis.go"
      provides: "Redis health check factory"
      exports: ["Config", "New"]
    - path: "health/checks/redis/redis_test.go"
      provides: "Redis check tests"
      min_lines: 40
  key_links:
    - from: "health/checks/redis/redis.go"
      to: "github.com/redis/go-redis/v9"
      via: "client.Ping(ctx)"
      pattern: "Ping"
---

<objective>
Create Redis health check using go-redis/v9 client library.

Purpose: Provide a check for Redis cache/session store connectivity using existing connection pools.
Output: health/checks/redis/ subpackage with Config + New factory
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-add-builtin-checks-on-health-checks/36-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Redis check</name>
  <files>health/checks/redis/redis.go</files>
  <action>
Create health/checks/redis/redis.go:

```go
// Package redis provides a health check for Redis using go-redis/v9.
package redis

import (
    "context"
    "fmt"

    "github.com/redis/go-redis/v9"
)

// Config configures the Redis health check.
type Config struct {
    // Client is the Redis client to check. Required.
    // Accepts any client implementing redis.UniversalClient
    // (redis.Client, redis.ClusterClient, redis.Ring).
    Client redis.UniversalClient
}

// New creates a new Redis health check.
// Uses PING command to verify connectivity and response.
//
// Returns nil if PING returns "PONG", error otherwise.
func New(cfg Config) func(context.Context) error {
    return func(ctx context.Context) error {
        if cfg.Client == nil {
            return fmt.Errorf("redis: client is nil")
        }
        pong, err := cfg.Client.Ping(ctx).Result()
        if err != nil {
            return fmt.Errorf("redis: ping failed: %w", err)
        }
        if pong != "PONG" {
            return fmt.Errorf("redis: unexpected ping response: %q", pong)
        }
        return nil
    }
}
```

Run `go get github.com/redis/go-redis/v9` to add the dependency.

Key implementation notes:
- Uses redis.UniversalClient interface (works with Client, ClusterClient, Ring)
- Reuses existing connection pool (no DSN-based connection)
- PING is the standard Redis health check command
  </action>
  <verify>go build ./health/checks/redis/...</verify>
  <done>Redis check compiles with go-redis/v9 dependency</done>
</task>

<task type="auto">
  <name>Task 2: Add Redis check tests</name>
  <files>health/checks/redis/redis_test.go</files>
  <action>
Create health/checks/redis/redis_test.go with tests using a mock client:

Create a mock that implements redis.UniversalClient (just the Ping method):

```go
// mockClient is a minimal mock for redis.UniversalClient
type mockClient struct {
    redis.UniversalClient
    pingErr  error
    pingResp string
}

func (m *mockClient) Ping(ctx context.Context) *redis.StatusCmd {
    cmd := redis.NewStatusCmd(ctx)
    if m.pingErr != nil {
        cmd.SetErr(m.pingErr)
    } else {
        cmd.SetVal(m.pingResp)
    }
    return cmd
}
```

Tests:
1. Test nil client returns error
2. Test successful PING returns nil
3. Test PING error propagates
4. Test unexpected response (not "PONG") returns error
5. Test context cancellation

Note: Don't require actual Redis for unit tests. Use mock client.
  </action>
  <verify>go test -v ./health/checks/redis/...</verify>
  <done>Redis check validates PING response, all tests pass</done>
</task>

</tasks>

<verification>
```bash
# Verify dependency added
go list -m github.com/redis/go-redis/v9

# Run tests
go test -v ./health/checks/redis/...

# Verify full build
go build ./...
```
</verification>

<success_criteria>
- health/checks/redis/redis.go exports Config and New
- Config accepts redis.UniversalClient interface
- go-redis/v9 added to go.mod
- Check uses client.Ping(ctx) to verify connectivity
- Tests use mock client (no real Redis required)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/36-add-builtin-checks-on-health-checks/36-05-SUMMARY.md`
</output>
