---
phase: 17-expose-configprovider-flags-to-cobra-cli
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - cobra_flags_test.go
autonomous: true

must_haves:
  truths:
    - "Flags appear in cobra --help output"
    - "CLI flags override config file values via viper precedence"
    - "All ConfigFlagType values work correctly (string, int, bool, duration, float)"
    - "Flag name collisions are handled gracefully"
  artifacts:
    - path: "cobra_flags_test.go"
      provides: "Comprehensive test suite for RegisterCobraFlags"
      min_lines: 150
  key_links:
    - from: "cobra_flags_test.go"
      to: "cobra_flags.go"
      via: "tests RegisterCobraFlags method"
      pattern: "RegisterCobraFlags"
---

<objective>
Add comprehensive tests for RegisterCobraFlags functionality.

Purpose: Verify that ConfigProvider flags are correctly exposed to Cobra CLI, appear in help output, and properly override config values.

Output: Test suite covering flag registration, help visibility, CLI override, type coercion, and integration with existing cobra lifecycle.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-expose-configprovider-flags-to-cobra-cli/17-01-SUMMARY.md

@cobra_flags.go
@cobra_test.go
@provider_config_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test file with basic flag registration tests</name>
  <files>cobra_flags_test.go</files>
  <action>
Create new file `cobra_flags_test.go` with test suite:

```go
package gaz

import (
    "bytes"
    "testing"
    "time"

    "github.com/spf13/cobra"
    "github.com/stretchr/testify/suite"
)

type CobraFlagsSuite struct {
    suite.Suite
}

func TestCobraFlagsSuite(t *testing.T) {
    suite.Run(t, new(CobraFlagsSuite))
}

// testConfigProvider implements ConfigProvider for testing
type testConfigProvider struct {
    namespace string
    flags     []ConfigFlag
}

func (p *testConfigProvider) ConfigNamespace() string {
    return p.namespace
}

func (p *testConfigProvider) ConfigFlags() []ConfigFlag {
    return p.flags
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsRegistersFlags() {
    app := New()
    
    // Register a provider that implements ConfigProvider
    provider := &testConfigProvider{
        namespace: "server",
        flags: []ConfigFlag{
            {Key: "host", Type: ConfigFlagTypeString, Default: "localhost", Description: "Server host"},
            {Key: "port", Type: ConfigFlagTypeInt, Default: 8080, Description: "Server port"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    rootCmd := &cobra.Command{Use: "test"}
    
    // Register flags
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    // Verify flags are registered
    hostFlag := rootCmd.PersistentFlags().Lookup("server-host")
    s.NotNil(hostFlag, "server-host flag should be registered")
    s.Equal("Server host", hostFlag.Usage)
    s.Equal("localhost", hostFlag.DefValue)
    
    portFlag := rootCmd.PersistentFlags().Lookup("server-port")
    s.NotNil(portFlag, "server-port flag should be registered")
    s.Equal("Server port", portFlag.Usage)
    s.Equal("8080", portFlag.DefValue)
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsFlagsAppearInHelp() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "db",
        flags: []ConfigFlag{
            {Key: "host", Type: ConfigFlagTypeString, Default: "localhost", Description: "Database host"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    rootCmd := &cobra.Command{
        Use:   "myapp",
        Short: "Test app",
    }
    
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    // Capture help output
    buf := new(bytes.Buffer)
    rootCmd.SetOut(buf)
    rootCmd.SetArgs([]string{"--help"})
    _ = rootCmd.Execute()
    
    helpOutput := buf.String()
    s.Contains(helpOutput, "--db-host", "Help should contain --db-host flag")
    s.Contains(helpOutput, "Database host", "Help should contain flag description")
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsAllTypes() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "test",
        flags: []ConfigFlag{
            {Key: "str", Type: ConfigFlagTypeString, Default: "default", Description: "String flag"},
            {Key: "num", Type: ConfigFlagTypeInt, Default: 42, Description: "Int flag"},
            {Key: "flag", Type: ConfigFlagTypeBool, Default: true, Description: "Bool flag"},
            {Key: "dur", Type: ConfigFlagTypeDuration, Default: 30 * time.Second, Description: "Duration flag"},
            {Key: "flt", Type: ConfigFlagTypeFloat, Default: 3.14, Description: "Float flag"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    rootCmd := &cobra.Command{Use: "test"}
    
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    // Verify all flags are registered with correct types
    fs := rootCmd.PersistentFlags()
    
    strFlag := fs.Lookup("test-str")
    s.NotNil(strFlag)
    s.Equal("string", strFlag.Value.Type())
    
    numFlag := fs.Lookup("test-num")
    s.NotNil(numFlag)
    s.Equal("int", numFlag.Value.Type())
    
    boolFlag := fs.Lookup("test-flag")
    s.NotNil(boolFlag)
    s.Equal("bool", boolFlag.Value.Type())
    
    durFlag := fs.Lookup("test-dur")
    s.NotNil(durFlag)
    s.Equal("duration", durFlag.Value.Type())
    
    fltFlag := fs.Lookup("test-flt")
    s.NotNil(fltFlag)
    s.Equal("float64", fltFlag.Value.Type())
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsSkipsDuplicates() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "server",
        flags: []ConfigFlag{
            {Key: "host", Type: ConfigFlagTypeString, Default: "localhost", Description: "Server host"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    rootCmd := &cobra.Command{Use: "test"}
    
    // Pre-register a flag with the same name
    rootCmd.PersistentFlags().String("server-host", "preexisting", "Preexisting host")
    
    // RegisterCobraFlags should skip the duplicate
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    // Original flag should be preserved
    hostFlag := rootCmd.PersistentFlags().Lookup("server-host")
    s.Equal("preexisting", hostFlag.DefValue, "Original flag should be preserved")
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsIdempotent() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "server",
        flags: []ConfigFlag{
            {Key: "host", Type: ConfigFlagTypeString, Default: "localhost", Description: "Server host"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    rootCmd := &cobra.Command{Use: "test"}
    
    // Call twice - should not error
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err) // Second call should succeed (idempotent)
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsWithBuildIntegration() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "server",
        flags: []ConfigFlag{
            {Key: "host", Type: ConfigFlagTypeString, Default: "localhost", Description: "Server host"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    rootCmd := &cobra.Command{Use: "test"}
    
    // Register flags first
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    // Then build - should not duplicate work
    err = app.Build()
    s.Require().NoError(err)
    
    // Verify provider is still resolvable
    resolved, err := Resolve[*testConfigProvider](app.Container())
    s.Require().NoError(err)
    s.Equal("server", resolved.ConfigNamespace())
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsWithCobraLifecycle() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "app",
        flags: []ConfigFlag{
            {Key: "name", Type: ConfigFlagTypeString, Default: "myapp", Description: "App name"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    var capturedName string
    
    rootCmd := &cobra.Command{
        Use: "test",
        RunE: func(cmd *cobra.Command, _ []string) error {
            gotApp := FromContext(cmd.Context())
            pv := MustResolve[*ProviderValues](gotApp.Container())
            capturedName = pv.GetString("app.name")
            return nil
        },
    }
    
    // Full lifecycle: RegisterCobraFlags -> WithCobra -> Execute
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    app.WithCobra(rootCmd)
    
    rootCmd.SetArgs([]string{})
    execErr := rootCmd.Execute()
    s.Require().NoError(execErr)
    
    // Default value should be used (no flag override)
    s.Equal("myapp", capturedName)
}

func (s *CobraFlagsSuite) TestRegisterCobraFlagsCliOverride() {
    app := New()
    
    provider := &testConfigProvider{
        namespace: "server",
        flags: []ConfigFlag{
            {Key: "port", Type: ConfigFlagTypeInt, Default: 8080, Description: "Server port"},
        },
    }
    
    err := For[*testConfigProvider](app.Container()).Instance(provider)
    s.Require().NoError(err)
    
    var capturedPort int
    
    rootCmd := &cobra.Command{
        Use: "test",
        RunE: func(cmd *cobra.Command, _ []string) error {
            gotApp := FromContext(cmd.Context())
            pv := MustResolve[*ProviderValues](gotApp.Container())
            capturedPort = pv.GetInt("server.port")
            return nil
        },
    }
    
    err = app.RegisterCobraFlags(rootCmd)
    s.Require().NoError(err)
    
    app.WithCobra(rootCmd)
    
    // Pass flag on command line to override default
    rootCmd.SetArgs([]string{"--server-port=9090"})
    execErr := rootCmd.Execute()
    s.Require().NoError(execErr)
    
    // CLI flag should override default
    s.Equal(9090, capturedPort)
}

func (s *CobraFlagsSuite) TestConfigKeyToFlagName() {
    // Test the key transformation function
    s.Equal("server-host", configKeyToFlagName("server.host"))
    s.Equal("database-pool-size", configKeyToFlagName("database.pool.size"))
    s.Equal("simple", configKeyToFlagName("simple"))
}
```

The tests cover:
1. Basic flag registration with correct names/descriptions
2. Flags appearing in help output
3. All ConfigFlagType values (string, int, bool, duration, float)
4. Duplicate flag handling (skip if already exists)
5. Idempotency (calling twice is safe)
6. Integration with Build()
7. Full Cobra lifecycle integration
8. CLI flag override via viper precedence
9. Key transformation function
  </action>
  <verify>
Run `go test -v ./... -run TestCobraFlagsSuite` to verify all tests pass.
  </verify>
  <done>
Comprehensive test suite exists in cobra_flags_test.go.
All tests pass, covering flag registration, help visibility, CLI override, and type coercion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify coverage</name>
  <files>cobra_flags_test.go</files>
  <action>
1. Run the full test suite:
   ```bash
   go test -v ./... -run TestCobraFlagsSuite
   ```

2. Run with race detector:
   ```bash
   go test -race ./... -run TestCobraFlagsSuite
   ```

3. Check test coverage for cobra_flags.go:
   ```bash
   go test -coverprofile=coverage.out ./...
   go tool cover -func=coverage.out | grep cobra_flags
   ```

4. Verify existing tests still pass:
   ```bash
   go test ./...
   ```

5. Run linter:
   ```bash
   go vet ./...
   ```

If any tests fail, fix the issues in cobra_flags.go or the test file.
  </action>
  <verify>
`go test ./...` passes with no failures.
`go test -race ./...` passes with no race conditions.
Coverage for cobra_flags.go is >= 70%.
  </verify>
  <done>
All tests pass. No race conditions. Coverage meets target.
  </done>
</task>

</tasks>

<verification>
1. `go test -v ./... -run TestCobraFlagsSuite` passes all tests
2. `go test -race ./...` passes with no race conditions
3. `go test ./...` passes (all existing tests still work)
4. Coverage for new code >= 70%
</verification>

<success_criteria>
- Test suite covers flag registration, help visibility, CLI override, type coercion
- All tests pass
- No race conditions
- Existing tests unaffected
- Coverage >= 70% for cobra_flags.go
</success_criteria>

<output>
After completion, create `.planning/phases/17-expose-configprovider-flags-to-cobra-cli/17-02-SUMMARY.md`
</output>
