---
phase: 32-backoff-package
plan: 03
type: execute
wave: 3
depends_on: ["32-02"]
files_modified:
  - worker/supervisor.go
  - worker/backoff.go
  - worker/backoff_test.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "worker/supervisor.go imports github.com/petabytecl/gaz/backoff (internal)"
    - "worker/supervisor.go uses backoff.ExponentialBackOff instead of jpillora/backoff"
    - "jpillora/backoff is removed from go.mod require block"
    - "All worker tests pass with internal backoff"
  artifacts:
    - path: "worker/supervisor.go"
      provides: "Worker supervision with internal backoff"
      contains: "github.com/petabytecl/gaz/backoff"
    - path: "go.mod"
      provides: "Dependency manifest without jpillora/backoff"
  key_links:
    - from: "worker/supervisor.go"
      to: "backoff/exponential.go"
      via: "imports internal backoff package"
      pattern: "backoff\\.NewExponentialBackOff"
---

<objective>
Migrate worker package to use internal backoff and remove jpillora/backoff dependency.

Purpose: Complete the dependency replacement - workers now use the internal backoff package.
Output: Worker package uses internal backoff, jpillora/backoff removed from go.mod.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-backoff-package/32-RESEARCH.md
@.planning/phases/32-backoff-package/32-01-SUMMARY.md
@.planning/phases/32-backoff-package/32-02-SUMMARY.md

Current implementation:
@worker/backoff.go
@worker/supervisor.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update worker package to use internal backoff</name>
  <files>worker/supervisor.go, worker/backoff.go, worker/backoff_test.go</files>
  <action>
Migrate worker package from jpillora/backoff to internal backoff:

1. Update `worker/supervisor.go`:
   - Change import from `github.com/jpillora/backoff` to `github.com/petabytecl/gaz/backoff`
   - Change `backoff *backoff.Backoff` field to `backoff *backoff.ExponentialBackOff`
   - In `newSupervisor()`:
     - Remove `cfg := NewBackoffConfig()` and `cfg.NewBackoff()` pattern
     - Create backoff directly:
       ```go
       backoff: backoff.NewExponentialBackOff(
           backoff.WithInitialInterval(1 * time.Second),
           backoff.WithMaxInterval(5 * time.Minute),
           backoff.WithMultiplier(2.0),
           backoff.WithRandomizationFactor(0.5),
       ),
       ```
   - Change `s.backoff.Duration()` calls to `s.backoff.NextBackOff()`
   - `s.backoff.Reset()` remains the same (same method name)

2. Simplify `worker/backoff.go`:
   - Remove the entire jpillora/backoff import and wrapper
   - Keep `BackoffConfig` and `BackoffOption` types for API compatibility (users may configure via options)
   - Update `NewBackoffConfig()` to return a config struct
   - Change `NewBackoff()` method to return `*backoff.ExponentialBackOff`:
     ```go
     func (c *BackoffConfig) NewBackoff() *backoff.ExponentialBackOff {
         return backoff.NewExponentialBackOff(
             backoff.WithInitialInterval(c.Min),
             backoff.WithMaxInterval(c.Max),
             backoff.WithMultiplier(c.Factor),
             backoff.WithRandomizationFactor(0.5), // Jitter: true = 0.5, false = 0
         )
     }
     ```
   - Update import to use internal backoff package

3. Update `worker/backoff_test.go`:
   - Adjust any tests that depend on jpillora/backoff API
   - Test that NewBackoff() returns working ExponentialBackOff
   - Test that NextBackOff() returns increasing values

API mapping (from RESEARCH.md):
| jpillora/backoff | internal backoff |
|------------------|------------------|
| `b.Duration()` | `b.NextBackOff()` |
| `b.Reset()` | `b.Reset()` |
| `b.Min` | `WithInitialInterval(d)` |
| `b.Max` | `WithMaxInterval(d)` |
| `b.Factor` | `WithMultiplier(f)` |
| `b.Jitter` | `WithRandomizationFactor(f)` |
  </action>
  <verify>`go test ./worker/... -v` passes with no race conditions</verify>
  <done>worker package compiles and tests pass with internal backoff</done>
</task>

<task type="auto">
  <name>Task 2: Remove jpillora/backoff from go.mod and verify</name>
  <files>go.mod, go.sum</files>
  <action>
Remove the external dependency and verify complete migration:

1. Run `go mod tidy` to remove unused jpillora/backoff dependency

2. Verify jpillora/backoff is removed:
   - `grep -q "jpillora/backoff" go.mod && echo "FAIL: still present" || echo "OK: removed"`

3. Run full test suite to verify nothing breaks:
   - `go test ./...`
   - `go test -race ./...`

4. Verify no code imports jpillora/backoff:
   - `grep -r "jpillora/backoff" --include="*.go" . && echo "FAIL: still imported" || echo "OK: not imported"`

5. Build the entire project to verify compilation:
   - `go build ./...`
  </action>
  <verify>`go mod tidy && go test ./... && ! grep -q "jpillora/backoff" go.mod`</verify>
  <done>jpillora/backoff removed from go.mod, all tests pass, no code imports it</done>
</task>

</tasks>

<verification>
```bash
# Full test suite passes
go test ./... -v

# Race detector passes
go test -race ./...

# jpillora/backoff removed from dependencies
! grep -q "jpillora/backoff" go.mod

# No code imports jpillora/backoff
! grep -r "jpillora/backoff" --include="*.go" .

# Project builds cleanly
go build ./...
```
</verification>

<success_criteria>
- [ ] worker/supervisor.go imports internal backoff package
- [ ] worker/supervisor.go uses NextBackOff() instead of Duration()
- [ ] jpillora/backoff not present in go.mod
- [ ] No Go files import jpillora/backoff
- [ ] All tests pass including race detector
- [ ] Project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-backoff-package/32-03-SUMMARY.md`
</output>
