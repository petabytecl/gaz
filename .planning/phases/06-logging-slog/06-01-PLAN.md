---
phase: 06-logging-slog
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - logger/config.go
  - logger/context.go
  - logger/handler.go
  - logger/provider.go
  - logger/logger_test.go
autonomous: true
must_haves:
  truths:
    - "Logger outputs JSON in production mode"
    - "Logger outputs tinted text in development mode"
    - "ContextHandler extracts standard attributes from context"
  artifacts:
    - path: "logger/provider.go"
      provides: "NewLogger"
      exports: ["NewLogger", "Config"]
    - path: "logger/handler.go"
      provides: "ContextHandler"
  key_links:
    - from: "logger/provider.go"
      to: "logger/handler.go"
      via: "wraps"
---

<objective>
Establish the core logging infrastructure using `log/slog`.
Create the `logger` package with a `ContextHandler` that enables context propagation and a `NewLogger` provider that switches between JSON and Tinted output based on configuration.

Purpose: Foundation for structured logging across the framework.
Output: A `logger` package with `NewLogger` and `ContextHandler`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup Logger Package & Context Types</name>
  <files>logger/context.go, logger/config.go</files>
  <action>
    1. Create `logger/` directory.
    2. Run `go get github.com/lmittmann/tint`.
    3. Create `logger/config.go` with `Config` struct (Level, Format, etc.).
    4. Create `logger/context.go`:
       - Define unexported `ctxKey` type.
       - Define constants for standard keys: `trace_id`, `span_id`, `request_id` (use "trace_id" string values for context keys to allow interoperability, or use the unexported key but map to these strings in handler). 
       - *Decision*: Use unexported keys for *storing* in context, but map to standard string keys ("trace_id") in the handler.
       - Add `LevelVar` support in Config or global.
  </action>
  <verify>go list ./logger</verify>
  <done>Package exists and compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Implement ContextHandler</name>
  <files>logger/handler.go</files>
  <action>
    Implement `ContextHandler` struct that embeds `slog.Handler`.
    Implement `Handle(ctx context.Context, r slog.Record) error`:
    - Check if ctx is nil (pass through).
    - Extract `trace_id`, `request_id` from context using keys defined in Task 1.
    - Add them as attributes to the record (`r.AddAttrs`).
    - Delegate to embedded handler.
  </action>
  <verify>Unit test mocking a context with values and checking Record attrs</verify>
  <done>Handler extracts keys from context.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Provider & Tests</name>
  <files>logger/provider.go, logger/logger_test.go</files>
  <action>
    Implement `NewLogger(cfg *Config) *slog.Logger`:
    - Create `slog.HandlerOptions` with `Level` from config (support `slog.LevelVar`).
    - If `cfg.Format == "json"`, use `slog.NewJSONHandler`.
    - If `cfg.Format == "text"` (or dev), use `tint.NewHandler`.
    - Wrap with `ContextHandler`.
    - Return `slog.New(handler)`.
    - Call `slog.SetDefault(logger)` to enable global usage.
    
    Add unit tests:
    - Verify JSON output format.
    - Verify Tint output format.
    - Verify ContextHandler propagation.
  </action>
  <verify>go test -v ./logger/...</verify>
  <done>Tests pass, provider returns correctly configured logger.</done>
</task>

</tasks>

<verification>
Run `go test ./logger/...` to ensure core infrastructure works.
</verification>

<success_criteria>
- `NewLogger` returns `*slog.Logger`.
- JSON handler is used when configured.
- Tint handler is used when configured.
- Attributes in context appear in logs.
</success_criteria>

<output>
After completion, create `.planning/phases/06-logging-slog/06-01-SUMMARY.md`
</output>
