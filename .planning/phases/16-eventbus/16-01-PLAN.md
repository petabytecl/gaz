---
phase: 16-eventbus
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - eventbus/doc.go
  - eventbus/event.go
  - eventbus/subscription.go
  - eventbus/options.go
autonomous: true

must_haves:
  truths:
    - "Event interface defined with EventName() method"
    - "Handler[T] type defined accepting context and event"
    - "Subscription type has Unsubscribe() method"
    - "SubscribeOption functions exist for topic and buffer size"
  artifacts:
    - path: "eventbus/event.go"
      provides: "Event interface and Handler type"
      exports: ["Event", "Handler"]
    - path: "eventbus/subscription.go"
      provides: "Subscription handle for unsubscribe"
      exports: ["Subscription"]
    - path: "eventbus/options.go"
      provides: "SubscribeOption functional options"
      exports: ["SubscribeOption", "WithTopic", "WithBufferSize"]
    - path: "eventbus/doc.go"
      provides: "Package documentation"
      min_lines: 40
  key_links:
    - from: "eventbus/subscription.go"
      to: "eventbus/event.go"
      via: "Subscription stores reflect.Type of event"
      pattern: "reflect\\.Type"
---

<objective>
Create the eventbus package foundation with Event interface, Handler type, Subscription handle, and subscription options.

Purpose: Establish core types needed for type-safe pub/sub before implementing EventBus.
Output: eventbus package with Event, Handler, Subscription, and SubscribeOption types.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-eventbus/16-CONTEXT.md
@.planning/phases/16-eventbus/16-RESEARCH.md
@worker/worker.go
@worker/doc.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create eventbus package with Event interface and Handler type</name>
  <files>eventbus/doc.go, eventbus/event.go</files>
  <action>
1. Create `eventbus/doc.go` with package documentation following worker/doc.go pattern:
   - Package overview explaining type-safe in-process pub/sub
   - Usage example showing Event implementation and Subscribe/Publish
   - Reference async fire-and-forget behavior and buffer configuration
   - Document lifecycle integration (implements worker.Worker)

2. Create `eventbus/event.go` with Event interface per CONTEXT.md:
   ```go
   // Event is the interface all publishable events must implement.
   // This provides type-safe routing and logging/debugging support.
   type Event interface {
       // EventName returns a string identifier for logging and debugging.
       // Convention: Use the struct type name (e.g., "UserCreated").
       EventName() string
   }
   ```

3. Add Handler type with context support per CONTEXT.md:
   ```go
   // Handler is a function that handles events of type T.
   // Handlers receive context for cancellation awareness.
   // No error return - handlers are fire-and-forget (log internally if needed).
   type Handler[T Event] func(ctx context.Context, event T)
   ```

4. Add comprehensive godoc comments explaining the contract.
  </action>
  <verify>`go build ./eventbus/...` compiles successfully</verify>
  <done>Event interface and Handler type exported from eventbus package</done>
</task>

<task type="auto">
  <name>Task 2: Create Subscription handle and SubscribeOption functions</name>
  <files>eventbus/subscription.go, eventbus/options.go</files>
  <action>
1. Create `eventbus/subscription.go` with Subscription handle:
   ```go
   // Subscription represents an active event subscription.
   // Use Unsubscribe() to remove the subscription.
   type Subscription struct {
       id        uint64       // Atomic counter ID, not UUID
       eventType reflect.Type // Type key for handler lookup
       topic     string       // Optional topic filter
       bus       unsubscriber // Interface to avoid circular dependency
   }

   // unsubscriber is internal interface for EventBus unsubscribe method
   type unsubscriber interface {
       unsubscribe(eventType reflect.Type, topic string, id uint64)
   }

   // Unsubscribe removes this subscription from the EventBus.
   // Safe to call multiple times (idempotent).
   func (s *Subscription) Unsubscribe() {
       if s.bus != nil {
           s.bus.unsubscribe(s.eventType, s.topic, s.id)
       }
   }
   ```

2. Create `eventbus/options.go` with SubscribeOption functional options:
   ```go
   // SubscribeOption configures a subscription.
   type SubscribeOption func(*subscribeOptions)

   // subscribeOptions holds subscription configuration.
   type subscribeOptions struct {
       topic      string // Optional topic filter (empty = all topics)
       bufferSize int    // Buffer size for async delivery (default: 100)
   }

   // defaultSubscribeOptions returns defaults per RESEARCH.md
   func defaultSubscribeOptions() subscribeOptions {
       return subscribeOptions{
           topic:      "", // Subscribe to all topics of this type
           bufferSize: 100,
       }
   }

   // WithTopic filters events to only those published with matching topic.
   // Empty topic or omitting this option subscribes to all events of the type.
   func WithTopic(topic string) SubscribeOption {
       return func(o *subscribeOptions) {
           o.topic = topic
       }
   }

   // WithBufferSize sets the async buffer size for this subscription.
   // When buffer is full, Publish blocks (backpressure per CONTEXT.md).
   // Default: 100
   func WithBufferSize(size int) SubscribeOption {
       return func(o *subscribeOptions) {
           o.bufferSize = size
       }
   }
   ```

3. Add helper function to apply options:
   ```go
   func applyOptions(opts []SubscribeOption) subscribeOptions {
       options := defaultSubscribeOptions()
       for _, opt := range opts {
           opt(&options)
       }
       return options
   }
   ```
  </action>
  <verify>`go build ./eventbus/...` compiles, `go vet ./eventbus/...` passes</verify>
  <done>Subscription type with Unsubscribe(), SubscribeOption functions with WithTopic/WithBufferSize</done>
</task>

</tasks>

<verification>
1. `go build ./eventbus/...` - Package compiles
2. `go vet ./eventbus/...` - No vet errors
3. `grep -q "Event interface" eventbus/event.go` - Event interface defined
4. `grep -q "Handler\[T Event\]" eventbus/event.go` - Generic Handler type defined
5. `grep -q "Unsubscribe" eventbus/subscription.go` - Unsubscribe method exists
6. `grep -q "WithTopic" eventbus/options.go` - Topic option exists
7. `grep -q "WithBufferSize" eventbus/options.go` - Buffer size option exists
</verification>

<success_criteria>
- Event interface with EventName() method
- Handler[T Event] generic function type accepting context
- Subscription type with Unsubscribe() method
- SubscribeOption with WithTopic() and WithBufferSize() functions
- Package compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/16-eventbus/16-01-SUMMARY.md`
</output>
