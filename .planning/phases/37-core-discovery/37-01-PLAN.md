---
phase: 37-core-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [di/container.go, di/registration.go, di/resolution.go, types.go, di/resolution_test.go]
autonomous: true
must_haves:
  truths:
    - "Container stores multiple services per key"
    - "ResolveAll returns all services of a type"
    - "Resolve returns error if ambiguity exists"
  artifacts:
    - path: "di/container.go"
      provides: "Multi-binding storage"
    - path: "di/resolution.go"
      provides: "Discovery logic"
  key_links:
    - from: "di/resolution.go"
      to: "di/container.go"
      via: "c.services iteration"
---

<objective>
Refactor Core DI engine to support multi-binding storage and implement Discovery API.

Purpose: Enables "Implicit Collection" pattern where multiple providers can be registered for the same type/interface, and resolved via ResolveAll.
Output: Refactored container with ResolveAll/ResolveGroup capabilities.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@di/container.go
@di/registration.go
@di/resolution.go
@types.go
@di/service.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Internal Storage</name>
  <files>di/container.go</files>
  <action>
    Refactor `Container` struct in `di/container.go`.
    
    1. Change `services` field from `map[string]any` (or `*ServiceWrapper`) to `map[string][]*ServiceWrapper`.
    2. Update `Build()` method to iterate over the slice of wrappers when initializing eager services.
    3. Ensure thread-safety (RWMutex usage) accounts for the slice.
    
    Note: This will break existing code in registration/resolution, which must be fixed in subsequent tasks.
  </action>
  <verify>grep "map\[string\]\[\]\*ServiceWrapper" di/container.go</verify>
  <done>Container struct updated for multi-binding</done>
</task>

<task type="auto">
  <name>Task 2: Update Registration Logic</name>
  <files>di/registration.go</files>
  <action>
    Update `Register` method in `di/registration.go` to support Implicit Collection.
    
    1. If key exists: Append the new `ServiceWrapper` to the existing slice.
    2. If `Replace` option is set: Overwrite the *entire list* with the new wrapper (or clear and set).
    3. Remove `ErrDuplicate` check for normal registration.
    
    Update `di/builder.go` (if needed) to add `InGroup(name)` method to `RegistrationBuilder` and pass it to `ServiceWrapper`.
  </action>
  <verify>go build ./di/...</verify>
  <done>Registration appends instead of erroring</done>
</task>

<task type="auto">
  <name>Task 3: Implement Resolution Logic</name>
  <files>di/resolution.go</files>
  <action>
    Update `di/resolution.go` to handle the new storage structure.
    
    1. Update `Resolve[T](c)`:
       - Look up `services[name]`.
       - If `len(list) > 1`: Return `ErrAmbiguous` (define this new error in `di/errors.go`).
       - If `len(list) == 1`: Return `list[0]`.
       - If empty: `ErrNotFound`.
       
    2. Implement `ResolveAllByType[T](c) []T`:
       - Iterate ALL lists in `c.services`.
       - Check assignability: `wrapper.ServiceType().AssignableTo(reflect.TypeOf((*T)(nil)).Elem())`.
       - Return slice of instances.
       
    3. Implement `ResolveGroup[T](c, group) []T`:
       - Same as `ResolveAllByType` but check `wrapper.Groups()` contains `group`.
  </action>
  <verify>go test ./di/...</verify>
  <done>Resolution handles ambiguity and discovery</done>
</task>

<task type="auto">
  <name>Task 4: Expose Public API</name>
  <files>types.go</files>
  <action>
    Update `types.go` (root) to expose discovery functions.
    
    1. Add `gaz.ResolveAll[T](c)` -> calls `di.ResolveAll[T](c)`.
    2. Add `gaz.ResolveGroup[T](c, group)` -> calls `di.ResolveGroup[T](c, group)`.
    3. Ensure `di` package exports these helpers (if not added in Task 3, add them now).
  </action>
  <verify>go build .</verify>
  <done>Public API available</done>
</task>

</tasks>

<verification>
Run all tests to ensure no regressions in standard DI behavior:
`make test`
</verification>

<success_criteria>
- Multi-binding storage implemented.
- Ambiguity detection active.
- ResolveAll/ResolveGroup working.
- Existing single-service tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/37-core-discovery/37-01-SUMMARY.md`
</output>
