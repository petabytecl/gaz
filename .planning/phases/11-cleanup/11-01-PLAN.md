---
phase: 11-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.go
  - service.go
  - doc.go
  - cobra.go
  - app_test.go
  - app_integration_test.go
  - cobra_test.go
  - config_test.go
  - provider_config_test.go
  - example_test.go
  - example_lifecycle_test.go
autonomous: true

must_haves:
  truths:
    - "NewApp() function does not exist in codebase"
    - "AppOption type does not exist in codebase"
    - "App.ProvideSingleton/ProvideTransient/ProvideEager/ProvideInstance methods do not exist"
    - "Reflection-based service wrappers (lazySingletonAny, etc.) do not exist"
    - "All internal tests compile and pass using For[T]() pattern"
  artifacts:
    - path: "app.go"
      provides: "App without deprecated methods"
      must_not_contain: ["func NewApp", "func (a *App) ProvideSingleton", "func (a *App) registerProvider"]
    - path: "service.go"
      provides: "Service wrappers without reflection-based types"
      must_not_contain: ["lazySingletonAny", "transientServiceAny", "eagerSingletonAny", "instanceServiceAny"]
    - path: "doc.go"
      provides: "Updated package documentation"
      contains: "For[T]"
  key_links:
    - from: "app_test.go"
      to: "registration.go"
      via: "For[T]() calls"
      pattern: "For\\[.*\\]\\("
---

<objective>
Remove all deprecated APIs from gaz core library and migrate all internal tests to use the generic fluent `For[T]()` registration pattern.

Purpose: Clean break from old reflection-based registration, enabling simpler codebase and type-safe DI.
Output: Core library files without deprecated code, all tests passing with new pattern.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cleanup/11-CONTEXT.md

# Core files being modified
@app.go
@service.go
@doc.go
@registration.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove deprecated APIs from core files</name>
  <files>app.go, service.go, doc.go, cobra.go</files>
  <action>
Delete the following deprecated code from app.go:
1. `AppOption` type (line 55) and deprecation comment
2. `withShutdownTimeoutLegacy()` function (lines 83-88)
3. `NewApp()` function (lines 164-195) and its comment
4. `ProvideSingleton()` method (lines 229-246)
5. `ProvideTransient()` method (lines 248-259)
6. `ProvideEager()` method (lines 261-272)
7. `ProvideInstance()` method (lines 274-284)
8. `registerProvider()` method (lines 286-351)
9. `registerInstance()` method (lines 353-370)
10. Remove unused imports (`reflect`, `sort`) if no longer needed
11. Remove `providerWithErrorReturnCount` constant if unused

Delete the following from service.go (lines 363-591):
1. The entire section comment about non-generic service wrappers
2. `lazySingletonAny` type and `newLazySingletonAny()` function
3. `transientServiceAny` type and `newTransientAny()` function
4. `eagerSingletonAny` type and `newEagerSingletonAny()` function
5. `instanceServiceAny` type and `newInstanceServiceAny()` function

Update doc.go:
1. Replace ProvideSingleton examples with For[T]() equivalents
2. Update the service type documentation to reference For[T]() methods
3. Update any other references to deprecated methods

Update cobra.go:
1. Replace ProvideSingleton reference in comment (line 50) with For[T]() pattern

Update New() in app.go to use For[T]() for registering the Logger:
- Replace `app.registerInstance(app.Logger)` with `For[*slog.Logger](app.container).Instance(app.Logger)`

Update WithConfig() in app.go:
- Replace `app.registerInstance(target)` with `For[any](app.container).Instance(target)` (will need reflection for type)
- Or use a simpler approach: move config registration to use the same pattern as tests

Update registerProviderFlags() in app.go:
- Replace `app.registerInstance(pv)` call with `For[*ProviderValues](app.container).Instance(pv)`
  </action>
  <verify>
Run `go build ./...` to confirm no compilation errors.
Run `grep -r "func NewApp\|ProvideSingleton\|ProvideTransient\|ProvideEager\|ProvideInstance\|registerProvider\|registerInstance\|lazySingletonAny\|transientServiceAny\|eagerSingletonAny\|instanceServiceAny" *.go` returns no matches.
  </verify>
  <done>
All deprecated functions, methods, and types are removed from app.go, service.go, doc.go, and cobra.go. Code compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate internal tests to For[T]() pattern</name>
  <files>app_test.go, app_integration_test.go, cobra_test.go, config_test.go, provider_config_test.go, example_test.go, example_lifecycle_test.go</files>
  <action>
Update all tests that use deprecated APIs to use the For[T]() fluent registration pattern.

Pattern replacements:
- `app.ProvideSingleton(func(c *Container) (*T, error) {...})` → `For[*T](app.Container()).Provider(func(c *Container) (*T, error) {...})`
- `app.ProvideTransient(func(c *Container) (*T, error) {...})` → `For[*T](app.Container()).Transient().Provider(func(c *Container) (*T, error) {...})`
- `app.ProvideEager(func(c *Container) (*T, error) {...})` → `For[*T](app.Container()).Eager().Provider(func(c *Container) (*T, error) {...})`
- `app.ProvideInstance(instance)` → `For[*T](app.Container()).Instance(instance)`

For chained calls like `app.ProvideSingleton(...).ProvideSingleton(...)`:
- Convert to separate For[T]() calls, checking errors as needed

Files to update (based on grep results):
1. app_test.go: ~20 usages of ProvideSingleton/ProvideTransient/ProvideEager/ProvideInstance
2. app_integration_test.go: ~5 usages
3. cobra_test.go: ~5 usages
4. config_test.go: ~1 usage
5. provider_config_test.go: ~15 usages
6. example_test.go: ~5 usages (ExampleApp_ProvideSingleton → ExampleFor)
7. example_lifecycle_test.go: ~1 usage

For example_test.go:
- Rename `ExampleApp_ProvideSingleton` to `ExampleFor` or `ExampleFor_singleton`
- Update examples to demonstrate For[T]() pattern

Improve test quality while updating:
- Add error checking where missing
- Use clearer test helper names if appropriate
  </action>
  <verify>
Run `go test ./...` to confirm all tests pass.
Run `grep -r "ProvideSingleton\|ProvideTransient\|ProvideEager\|ProvideInstance" *_test.go` returns no matches.
  </verify>
  <done>
All internal tests compile and pass using For[T]() pattern. No references to deprecated methods remain in test files.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go test ./...` succeeds with all tests passing
3. `grep -rn "NewApp\|ProvideSingleton\|ProvideTransient\|ProvideEager\|ProvideInstance" *.go *_test.go` returns only For[T]() usages (should be empty for deprecated methods)
4. `grep -rn "lazySingletonAny\|transientServiceAny\|eagerSingletonAny\|instanceServiceAny" *.go` returns no matches
</verification>

<success_criteria>
- All deprecated APIs removed from core library
- All internal tests pass using For[T]() pattern
- No compilation errors
- CLN-01 through CLN-10 and CLN-12 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-cleanup/11-01-SUMMARY.md`
</output>
