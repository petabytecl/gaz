---
phase: 11-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.go
  - service.go
  - doc.go
  - cobra.go
  - app_test.go
  - app_integration_test.go
  - cobra_test.go
  - config_test.go
  - provider_config_test.go
  - example_test.go
  - example_lifecycle_test.go
  - health/integration.go
  - health/module_test.go
autonomous: true

must_haves:
  truths:
    - "NewApp() function does not exist in codebase"
    - "AppOption type does not exist in codebase"
    - "App.ProvideSingleton/ProvideTransient/ProvideEager/ProvideInstance methods do not exist"
    - "Reflection-based provider wrappers (lazySingletonAny, transientServiceAny, eagerSingletonAny) do not exist"
    - "registerInstance() and instanceServiceAny exist ONLY for internal use (WithConfig, logger registration)"
    - "All internal tests compile and pass using For[T]() pattern"
    - "health/integration.go and health/module_test.go use For[T]() pattern"
  artifacts:
    - path: "app.go"
      provides: "App without deprecated methods"
      must_not_contain: ["func NewApp", "func (a *App) ProvideSingleton", "func (a *App) registerProvider"]
    - path: "service.go"
      provides: "Service wrappers - deprecated types removed except internal helper"
      must_not_contain: ["lazySingletonAny", "transientServiceAny", "eagerSingletonAny"]
      note: "instanceServiceAny and newInstanceServiceAny retained for internal registerInstance() use"
    - path: "doc.go"
      provides: "Updated package documentation"
      contains: "For[T]"
  key_links:
    - from: "app_test.go"
      to: "registration.go"
      via: "For[T]() calls"
      pattern: "For\\[.*\\]\\("
---

<objective>
Remove all deprecated APIs from gaz core library and migrate all internal tests to use the generic fluent `For[T]()` registration pattern.

Purpose: Clean break from old reflection-based registration, enabling simpler codebase and type-safe DI.
Output: Core library files without deprecated code, all tests passing with new pattern.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-cleanup/11-CONTEXT.md

# Core files being modified
@app.go
@service.go
@doc.go
@registration.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove deprecated APIs from core files</name>
  <files>app.go, service.go, doc.go, cobra.go</files>
  <action>
Delete the following deprecated code from app.go:
1. `AppOption` type (line 55) and deprecation comment
2. `withShutdownTimeoutLegacy()` function (lines 83-88)
3. `NewApp()` function (lines 164-195) and its comment
4. `ProvideSingleton()` method (lines 229-246)
5. `ProvideTransient()` method (lines 248-259)
6. `ProvideEager()` method (lines 261-272)
7. `ProvideInstance()` method (lines 274-284)
8. `registerProvider()` method (lines 286-351)
9. Remove unused imports (`reflect`) if no longer needed - NOTE: keep `sort` import as `getSortedServiceNames()` uses it
10. Remove `providerWithErrorReturnCount` constant if unused

IMPORTANT: Keep `registerInstance()` method (lines 353-370) - it is used internally by:
- New() for Logger registration
- NewApp() legacy path (removed)
- WithConfig() for config struct registration (requires reflection to determine type)
- registerProviderFlags() for ProviderValues registration

Delete the following from service.go (lines 363-591):
1. The section comment about non-generic service wrappers - update to "Internal instance registration helper"
2. `lazySingletonAny` type and `newLazySingletonAny()` function
3. `transientServiceAny` type and `newTransientAny()` function
4. `eagerSingletonAny` type and `newEagerSingletonAny()` function
5. KEEP `instanceServiceAny` type and `newInstanceServiceAny()` function - needed by `registerInstance()` for internal use

Update doc.go (specific deprecated content):
1. Line 9 Quick Start example: Replace `app.ProvideSingleton(...)` with `gaz.For[*MyService](app.Container()).Provider(...)` pattern
2. Lines 21-23 GoDoc references: Update `[App.ProvideSingleton]`, `[App.ProvideTransient]`, `[App.ProvideEager]` to reference `[For]` and its methods (`.Provider()`, `.Transient()`, `.Eager()`)
3. Lines 99-100 Module example: Replace `app.ProvideSingleton(NewPool)` with `gaz.For[*Pool](app.Container()).Provider(NewPool)` pattern
4. Ensure all examples show correct error handling with the fluent pattern

Update cobra.go (specific deprecated content):
1. Lines 49-51 doc comment example: Replace `app.ProvideSingleton(NewDatabase)` with `gaz.For[*Database](app.Container()).Provider(NewDatabase)` in the WithCobra usage example

Update New() in app.go to use For[T]() for registering the Logger:
- Replace `app.registerInstance(app.Logger)` with `For[*slog.Logger](app.container).Instance(app.Logger)`
- Note: For[T]().Instance() does not return an error - it panics internally on registration failure (container closed/nil), which is appropriate for startup code

Keep WithConfig() and registerProviderFlags() unchanged:
- They use `registerInstance()` internally which requires reflection to determine the type at runtime
- Cannot use `For[T]()` because the type is only known at runtime via `reflect.TypeOf(target)`
- `registerInstance()` is now an internal-only helper (no public ProvideInstance method)
  </action>
  <verify>
Run `go build ./...` to confirm no compilation errors.
Run `grep -r "func NewApp\|ProvideSingleton\|ProvideTransient\|ProvideEager\|ProvideInstance\|registerProvider\|lazySingletonAny\|transientServiceAny\|eagerSingletonAny" *.go` returns no matches (note: registerInstance and instanceServiceAny are retained for internal use).
  </verify>
  <done>
All deprecated functions, methods, and types are removed from app.go, service.go, doc.go, and cobra.go. Internal helpers registerInstance() and instanceServiceAny retained. Code compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate internal tests to For[T]() pattern</name>
  <files>app_test.go, app_integration_test.go, cobra_test.go, config_test.go, provider_config_test.go, example_test.go, example_lifecycle_test.go, health/integration.go, health/module_test.go</files>
  <action>
Update all tests that use deprecated APIs to use the For[T]() fluent registration pattern.

Pattern replacements:
- `app.ProvideSingleton(func(c *Container) (*T, error) {...})` → `For[*T](app.Container()).Provider(func(c *Container) (*T, error) {...})`
- `app.ProvideTransient(func(c *Container) (*T, error) {...})` → `For[*T](app.Container()).Transient().Provider(func(c *Container) (*T, error) {...})`
- `app.ProvideEager(func(c *Container) (*T, error) {...})` → `For[*T](app.Container()).Eager().Provider(func(c *Container) (*T, error) {...})`
- `app.ProvideInstance(instance)` → `For[*T](app.Container()).Instance(instance)`

For chained calls like `app.ProvideSingleton(...).ProvideSingleton(...)`:
- Convert to separate For[T]() calls, checking errors as needed

**Detailed file-by-file migration (50+ deprecated API usages):**

1. **app_test.go (~20 usages):**
   - Replace all `app.ProvideSingleton(...)` calls with `For[*T](app.Container()).Provider(...)`
   - Replace all `app.ProvideTransient(...)` calls with `For[*T](app.Container()).Transient().Provider(...)`
   - Replace all `app.ProvideEager(...)` calls with `For[*T](app.Container()).Eager().Provider(...)`
   - Replace all `app.ProvideInstance(...)` calls with `For[*T](app.Container()).Instance(...)`
   - Update any tests using `NewApp()`/`AppOption` to use `New()` with `Option` functions
   - Pay attention to generic type parameters - use exact registered type (pointer vs value)

2. **app_integration_test.go (~5 usages):**
   - Replace `app.ProvideSingleton(...)` calls with `For[*T](app.Container()).Provider(...)`
   - These are integration tests, ensure the registration pattern matches production code

3. **cobra_test.go (~5 usages):**
   - Replace `app.ProvideSingleton(...)` calls with `For[*T](app.Container()).Provider(...)`
   - Update any command setup tests that use deprecated registration

4. **config_test.go (~1 usage):**
   - Replace single `app.ProvideSingleton(...)` or `app.ProvideInstance(...)` call
   - Likely config-related provider registration

5. **provider_config_test.go (~15 usages):**
   - Replace all `app.ProvideSingleton(...)` calls with `For[*T](app.Container()).Provider(...)`
   - Replace all `app.ProvideTransient(...)` calls with `For[*T](app.Container()).Transient().Provider(...)`
   - These test provider configurations - maintain test coverage for lifecycle behaviors

6. **example_test.go (~5 usages):**
   - **CRITICAL:** Rename `ExampleApp_ProvideSingleton()` function to `ExampleFor_singleton()` (Go example naming convention: Example<Type>_<method>)
   - Replace deprecated API calls with For[T]() pattern in all examples
   - Ensure examples demonstrate idiomatic For[T]() usage for documentation

7. **example_lifecycle_test.go (~1 usage):**
   - Replace single deprecated API call with For[T]() pattern
   - Maintain lifecycle demonstration purpose of the example

**Health package files (critical - these use deprecated ProvideInstance):**

8. health/integration.go (line 17):
   - Replace `app.ProvideInstance(config)` with `gaz.For[Config](app.Container()).Instance(config)`
   - Note: Config is a value type (not pointer) based on usage pattern

9. health/module_test.go (line 13):
   - Replace `app.ProvideInstance(DefaultConfig())` with `gaz.For[Config](app.Container()).Instance(DefaultConfig())`

Improve test quality while updating:
- Add error checking where missing
- Use clearer test helper names if appropriate
  </action>
  <verify>
Run `go test ./...` to confirm all tests pass.
Run `grep -r "ProvideSingleton\|ProvideTransient\|ProvideEager\|ProvideInstance" *_test.go health/` returns no matches.
  </verify>
  <done>
All internal tests compile and pass using For[T]() pattern. No references to deprecated methods remain in test files or health package.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go test ./...` succeeds with all tests passing
3. `grep -rn "NewApp\|ProvideSingleton\|ProvideTransient\|ProvideEager\|ProvideInstance" *.go *_test.go health/` returns no matches for deprecated public methods
4. `grep -rn "lazySingletonAny\|transientServiceAny\|eagerSingletonAny" *.go` returns no matches
5. `grep -rn "registerInstance\|instanceServiceAny" *.go` returns matches ONLY in app.go and service.go (internal use)
</verification>

<success_criteria>
- All deprecated APIs removed from core library
- All internal tests pass using For[T]() pattern
- No compilation errors
- CLN-01 through CLN-10 and CLN-12 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-cleanup/11-01-SUMMARY.md`
</output>
