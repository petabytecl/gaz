---
phase: 12-di
plan: 04
type: execute
wave: 4
depends_on: ["12-03"]
files_modified:
  - di/container_test.go
  - di/registration_test.go
  - di/resolution_test.go
  - container_test.go
  - container_graph_test.go
  - registration_test.go
  - resolution_test.go
  - inject_test.go
  - lifecycle_test.go
  - lifecycle_engine_test.go
  - service_test.go
  - types_test.go
autonomous: true

must_haves:
  truths:
    - "di package has its own test coverage"
    - "All existing root package tests pass with updated imports"
    - "Full test suite passes: go test ./..."
    - "MustResolve panic behavior is tested"
    - "NewTestContainer is tested"
  artifacts:
    - path: "di/container_test.go"
      provides: "Test coverage for di.Container"
      contains: "TestNew"
    - path: "di/registration_test.go"
      provides: "Test coverage for di.For[T]()"
      contains: "TestFor"
    - path: "di/resolution_test.go"
      provides: "Test coverage for di.Resolve[T]() and MustResolve[T]()"
      contains: "TestMustResolve"
  key_links:
    - from: "di/container_test.go"
      to: "di/container.go"
      via: "test imports"
      pattern: "package di"
    - from: "container_test.go"
      to: "compat.go"
      via: "backward compat test"
      pattern: "gaz\\.NewContainer"
---

<objective>
Create di package tests and update root package tests to work with the extracted di package.

Purpose: Ensure comprehensive test coverage for both di package (primary) and root gaz package (backward compat).
Output: Full test suite passing with `go test ./...`
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-di/12-CONTEXT.md

# Plan 1-3 outputs
@di/container.go
@di/registration.go
@di/resolution.go
@di/testing.go
@compat.go
@app.go

# Existing tests to update
@container_test.go
@registration_test.go
@resolution_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create di package tests</name>
  <files>
    di/container_test.go
    di/registration_test.go
    di/resolution_test.go
  </files>
  <action>
Create comprehensive tests for di package:

1. **di/container_test.go**:
   - Copy structure from root container_test.go
   - Update package to `di`
   - Rename TestNewContainer â†’ TestNew
   - Add tests for new APIs:
     - TestList_Empty, TestList_WithServices, TestList_Sorted
     - TestHas_NotRegistered, TestHas_Registered
     - TestForEachService_Empty, TestForEachService_WithServices
     - TestGetService_NotFound, TestGetService_Found

2. **di/registration_test.go**:
   - Copy structure from root registration_test.go
   - Update package to `di`
   - Test For[T](), Named(), Transient(), Eager(), Replace()
   - Test Provider(), ProviderFunc(), Instance()
   - Test OnStart(), OnStop() hooks

3. **di/resolution_test.go**:
   - Copy structure from root resolution_test.go
   - Update package to `di`
   - Test Resolve[T]() success and failure cases
   - Test MustResolve[T]() success case
   - Test MustResolve[T]() panic behavior:
     ```go
     func (s *ResolutionSuite) TestMustResolve_PanicsOnNotFound() {
         c := New()
         s.Panics(func() {
             MustResolve[*testService](c)
         })
     }
     ```
   - Test NewTestContainer() returns valid container

Test helper types (define in di package test files):
```go
type testService struct {
    name string
}

type testDependency struct{}

type testServiceWithDep struct {
    dep *testDependency
}
```
  </action>
  <verify>
    - `go test ./di/...` passes
    - `grep "TestNew" di/container_test.go` finds the test
    - `grep "TestMustResolve" di/resolution_test.go` finds the test
  </verify>
  <done>
di package has comprehensive test coverage including new APIs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update root package tests for backward compatibility</name>
  <files>
    container_test.go
    container_graph_test.go
    registration_test.go
    resolution_test.go
    inject_test.go
    lifecycle_test.go
    lifecycle_engine_test.go
    service_test.go
    types_test.go
  </files>
  <action>
Update root package tests to verify backward compatibility:

1. **container_test.go**:
   - Keep tests that verify gaz.NewContainer() works (wraps di.New())
   - Update any internal type references to use gaz.Container (which is di.Container)
   - Simplify to focus on backward compat verification, not exhaustive testing

2. **container_graph_test.go**:
   - Update to use gaz.Container type alias
   - Verify graph operations work through compat layer

3. **registration_test.go**:
   - Keep tests verifying gaz.For[T]() works
   - Verify Named(), Transient(), etc. work through compat wrappers

4. **resolution_test.go**:
   - Keep tests verifying gaz.Resolve[T]() works
   - Add test for gaz.MustResolve[T]() wrapper
   - Verify gaz.Named() option works

5. **inject_test.go**:
   - Should work unchanged (uses gaz types which are aliases)
   - Update any direct container field access if present

6. **lifecycle_test.go**:
   - Update to use di.Starter, di.Stopper via gaz re-exports
   - Verify lifecycle hooks work through compat layer

7. **lifecycle_engine_test.go**:
   - Verify ComputeStartupOrder, ComputeShutdownOrder work

8. **service_test.go**:
   - Remove tests for deleted types (lazySingleton, etc.)
   - Keep only tests for instanceServiceAny
   - Verify instanceServiceAny implements di.ServiceWrapper

9. **types_test.go**:
   - Update to test gaz.TypeName[T]() wrapper
   - Verify it returns same result as di.TypeName[T]()
  </action>
  <verify>
    - `go test ./...` passes (full test suite)
    - `go test ./... -race` passes with no race conditions
  </verify>
  <done>
All root package tests pass, verifying backward compatibility.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Full test suite passes: `go test ./... -race`
2. di package tests exist: `ls di/*_test.go` shows 3 test files
3. Test coverage is reasonable: `go test ./di/... -cover`
4. Root package tests pass: `go test .`
</verification>

<success_criteria>
- `go test ./...` passes with 0 failures
- `go test ./... -race` passes with 0 race conditions
- di package has di/container_test.go, di/registration_test.go, di/resolution_test.go
- Root package tests verify backward compatibility
- MustResolve panic behavior is tested
- NewTestContainer is tested
</success_criteria>

<output>
After completion, create `.planning/phases/12-di/12-04-SUMMARY.md`
</output>
