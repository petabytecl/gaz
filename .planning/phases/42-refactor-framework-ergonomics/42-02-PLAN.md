---
phase: 42
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - cobra.go
autonomous: true
must_haves:
  truths:
    - "WithCobra applies stored flags to the command"
    - "WithCobra injects default run loop if missing"
    - "App waits for shutdown signal automatically"
  artifacts:
    - path: cobra.go
      provides: "WithCobra enhancement"
  key_links:
    - from: "WithCobra"
      to: "App.flagFns"
      via: "iteration"
    - from: "WithCobra"
      to: "App.waitForShutdownSignal"
      via: "RunE injection"
---

<objective>
Update Cobra integration to apply deferred flags and provide default lifecycle management.

Purpose: Enable zero-config CLI integration where flags work automatically and blocking is handled by the framework.
Output: Enhanced WithCobra method.
</objective>

<context>
@cobra.go
@app.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply deferred flags in WithCobra</name>
  <files>cobra.go</files>
  <action>
    Update `WithCobra` in `cobra.go`:
    1. Iterate over `a.flagFns` and execute each function, passing `cmd.PersistentFlags()`.
    2. This applies all flags collected during `App.Use()` phases.
    
    Place this logic at the beginning of `WithCobra`, before setting hooks, to ensure flags are registered before any help generation or parsing.
  </action>
  <verify>
    `go build ./...`
  </verify>
  <done>
    Flags from all modules are applied to the Cobra command.
  </done>
</task>

<task type="auto">
  <name>Task 2: Inject default RunE loop</name>
  <files>cobra.go</files>
  <action>
    Update `WithCobra` in `cobra.go`:
    1. Check if `cmd.Run` AND `cmd.RunE` are both nil.
    2. If both are nil, assign a default `RunE`:
       ```go
       func(c *cobra.Command, args []string) error {
           return a.waitForShutdownSignal(c.Context())
       }
       ```
    3. Ensure `waitForShutdownSignal` is accessible (it's in `app.go`, package `gaz`).
    
    This allows users to define a command without a Run function, and gaz will handle the "start, wait, stop" lifecycle automatically.
  </action>
  <verify>
    `go test ./...`
  </verify>
  <done>
    Cobra command has a default RunE that blocks on signal.
  </done>
</task>

</tasks>

<verification>
Verify `WithCobra` applies flags and sets run loop.
</verification>

<output>
After completion, create .planning/phases/42-refactor-framework-ergonomics/42-02-SUMMARY.md
</output>
