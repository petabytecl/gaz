---
phase: 15-cron
plan: 04
type: execute
wave: 4
depends_on: ["15-03"]
files_modified:
  - cron/scheduler_test.go
  - cron/wrapper_test.go
  - cron/logger_test.go
autonomous: true

must_haves:
  truths:
    - "Scheduler tests verify job registration and execution"
    - "Wrapper tests verify panic recovery and context handling"
    - "Logger adapter tests verify slog integration"
    - "All tests pass with go test ./cron/..."
  artifacts:
    - path: "cron/scheduler_test.go"
      provides: "Scheduler unit tests"
      min_lines: 100
    - path: "cron/wrapper_test.go"
      provides: "Job wrapper unit tests"
      min_lines: 80
    - path: "cron/logger_test.go"
      provides: "Logger adapter tests"
      min_lines: 30
  key_links:
    - from: "cron/scheduler_test.go"
      to: "cron.Scheduler"
      via: "tests Scheduler methods"
      pattern: "TestScheduler"
---

<objective>
Create comprehensive tests for the cron package covering Scheduler, job wrapper, and logger adapter functionality.

Purpose: Verify all CRN requirements are met with passing tests and achieve target coverage.
Output: Test suite for cron package with 70%+ coverage.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-cron/15-CONTEXT.md
@.planning/phases/15-cron/15-RESEARCH.md
@.planning/phases/15-cron/15-03-SUMMARY.md
@cron/scheduler.go
@cron/wrapper.go
@cron/logger.go
@worker/manager_test.go
@worker/supervisor_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Scheduler and logger adapter tests</name>
  <files>cron/scheduler_test.go, cron/logger_test.go</files>
  <action>
1. Create `cron/logger_test.go`:
   - TestNewSlogAdapter: Verify adapter creation with logger
   - TestSlogAdapter_Info: Verify Info method logs correctly
   - TestSlogAdapter_Error: Verify Error method logs with error attribute
   - Use slog.NewTextHandler with bytes.Buffer to capture log output

2. Create `cron/scheduler_test.go`:

   a. Create mock CronJob for testing:
   ```go
   type mockCronJob struct {
       name     string
       schedule string
       timeout  time.Duration
       runFn    func(ctx context.Context) error
       runCount int
       mu       sync.Mutex
   }
   
   func (m *mockCronJob) Name() string           { return m.name }
   func (m *mockCronJob) Schedule() string       { return m.schedule }
   func (m *mockCronJob) Timeout() time.Duration { return m.timeout }
   func (m *mockCronJob) Run(ctx context.Context) error {
       m.mu.Lock()
       m.runCount++
       m.mu.Unlock()
       if m.runFn != nil {
           return m.runFn(ctx)
       }
       return nil
   }
   ```

   b. Create mock Resolver for testing:
   ```go
   type mockResolver struct {
       services map[string]any
   }
   
   func (r *mockResolver) ResolveByName(name string, opts any) (any, error) {
       if svc, ok := r.services[name]; ok {
           return svc, nil
       }
       return nil, errors.New("not found")
   }
   ```

   c. Test cases:
   - TestNewScheduler: Verify scheduler creation
   - TestScheduler_Name: Verify returns "cron.Scheduler"
   - TestScheduler_RegisterJob_Valid: Register job with valid schedule
   - TestScheduler_RegisterJob_EmptySchedule: Empty schedule doesn't register (disabled)
   - TestScheduler_RegisterJob_InvalidSchedule: Invalid cron expression returns error
   - TestScheduler_StartStop: Start and stop lifecycle
   - TestScheduler_JobCount: Verify job counting
   - TestScheduler_HealthCheck_Running: Returns nil when running
   - TestScheduler_HealthCheck_NotRunning: Returns error when not running
  </action>
  <verify>`go test ./cron/...` passes</verify>
  <done>Scheduler and logger tests pass, cover core functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create wrapper tests and verify coverage</name>
  <files>cron/wrapper_test.go</files>
  <action>
1. Create `cron/wrapper_test.go`:

   a. Test cases for wrapper functionality:
   - TestNewJobWrapper: Verify wrapper creation with all fields
   - TestJobWrapper_Run_Success: Job runs and logs success
   - TestJobWrapper_Run_Error: Job returns error, logs failure
   - TestJobWrapper_Run_Panic: Job panics, recovered and logged with stack
   - TestJobWrapper_Run_Timeout: Context timeout is respected
   - TestJobWrapper_Run_ContextCancelled: Respects app context cancellation
   - TestJobWrapper_StatusTracking: IsRunning, LastRun, LastError accessors
   - TestJobWrapper_TransientResolution: Fresh instance resolved each run

   b. For panic recovery test, create a job that panics:
   ```go
   panicJob := &mockCronJob{
       name:     "panic-job",
       schedule: "@every 1s",
       runFn: func(ctx context.Context) error {
           panic("test panic")
       },
   }
   ```
   Verify wrapper.Run() doesn't crash, and logs contain "job panicked" and stack trace.

   c. For transient resolution test:
   Create mock resolver that returns NEW instance each call, verify Run() calls resolve each time.

2. Run coverage check:
   ```bash
   go test ./cron/... -coverprofile=coverage.out
   go tool cover -func=coverage.out
   ```
   Target: 70%+ coverage

3. Run all project tests to verify no regressions:
   ```bash
   go test ./...
   ```
  </action>
  <verify>`go test ./cron/... -v` passes, `go test ./...` passes (no regressions)</verify>
  <done>Wrapper tests pass, panic recovery works, all CRN requirements verified via tests</done>
</task>

</tasks>

<verification>
1. `go test ./cron/...` - All cron tests pass
2. `go test ./cron/... -cover` - Coverage ≥ 70%
3. `go test ./...` - All project tests pass (no regressions)
4. `go vet ./...` - No vet errors
5. Verify test for panic recovery exists: grep "Panic" cron/wrapper_test.go
6. Verify test for empty schedule exists: grep "EmptySchedule" cron/scheduler_test.go
</verification>

<success_criteria>
- All cron package tests pass
- Coverage ≥ 70% for cron package
- Panic recovery tested and working (CRN-06)
- SkipIfStillRunning behavior tested (CRN-08)
- Empty schedule disabling tested (CONTEXT.md)
- Context timeout tested
- All existing project tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/15-cron/15-04-SUMMARY.md`
</output>
