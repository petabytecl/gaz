---
phase: 35-health-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - healthx/doc.go
  - healthx/status.go
  - healthx/status_test.go
  - healthx/check.go
  - healthx/checker.go
  - healthx/checker_test.go
autonomous: true

must_haves:
  truths:
    - "Checker executes all configured checks and returns aggregated status"
    - "Checks run in parallel with per-check timeouts (default 5s)"
    - "Panicking checks are recovered and marked as failed (not crash handler)"
    - "Critical checks affect overall status, warning checks report independently"
    - "Overall status is 'up' only when all critical checks pass"
  artifacts:
    - path: "healthx/doc.go"
      provides: "Package documentation"
      min_lines: 10
    - path: "healthx/status.go"
      provides: "AvailabilityStatus enum (StatusUnknown, StatusUp, StatusDown)"
      exports: ["AvailabilityStatus", "StatusUnknown", "StatusUp", "StatusDown"]
    - path: "healthx/check.go"
      provides: "Check struct with Name, Check func, Timeout, Critical fields"
      exports: ["Check", "CheckerOption", "CheckResult"]
    - path: "healthx/checker.go"
      provides: "NewChecker, Checker interface, parallel execution, panic recovery"
      exports: ["Checker", "CheckerResult", "NewChecker", "WithCheck", "WithTimeout"]
  key_links:
    - from: "healthx/checker.go"
      to: "healthx/status.go"
      via: "Uses AvailabilityStatus for result status"
      pattern: "AvailabilityStatus"
    - from: "healthx/checker.go"
      to: "healthx/check.go"
      via: "Executes Check structs"
      pattern: "Check\\{"
---

<objective>
Create the core healthx package with check types, status enum, and parallel checker implementation.

Purpose: Build the foundation for the internal health check system - types for defining checks and a checker that executes them in parallel with timeout and panic recovery.

Output:
- healthx/doc.go - Package documentation
- healthx/status.go - AvailabilityStatus enum (HLT-08)
- healthx/check.go - Check struct and CheckResult (HLT-01, HLT-07)
- healthx/checker.go - NewChecker with functional options, parallel execution (HLT-02, HLT-03)
- Comprehensive tests for checker behavior
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-health-package/35-CONTEXT.md
@.planning/phases/35-health-package/35-RESEARCH.md

Existing health package for reference:
@health/types.go
@health/manager.go
@health/writer.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create healthx package with status enum and check types</name>
  <files>
    - healthx/doc.go
    - healthx/status.go
    - healthx/status_test.go
    - healthx/check.go
  </files>
  <action>
Create the healthx package directory and implement core types:

1. **healthx/doc.go** - Package documentation:
   - Document purpose: internal health check execution with parallel processing
   - Mention it replaces alexliesenfeld/health with minimal API surface
   - Note parallel execution, per-check timeouts, and panic recovery

2. **healthx/status.go** - AvailabilityStatus enum (HLT-08):
   ```go
   // AvailabilityStatus represents system/component availability.
   type AvailabilityStatus string

   const (
       // StatusUnknown means the status is not yet known.
       StatusUnknown AvailabilityStatus = "unknown"
       // StatusUp means the system/component is available.
       StatusUp AvailabilityStatus = "up"
       // StatusDown means the system/component is unavailable.
       StatusDown AvailabilityStatus = "down"
   )
   ```

3. **healthx/status_test.go** - Basic status tests:
   - Verify constant values
   - Verify string representation

4. **healthx/check.go** - Check struct and related types (HLT-01, HLT-07):
   ```go
   // Check configures a health check.
   type Check struct {
       // Name must be unique among all checks. Required.
       Name string
       
       // Check is the function that performs the health check.
       // Must return nil if healthy, error if unhealthy.
       Check func(ctx context.Context) error
       
       // Timeout overrides the default timeout for this check.
       // Zero means use default (5s).
       Timeout time.Duration
       
       // Critical determines if this check affects overall status.
       // Default is true. Non-critical checks report independently.
       Critical bool
   }

   // CheckResult holds a single check's result.
   type CheckResult struct {
       // Status is the check's availability status.
       Status AvailabilityStatus
       // Timestamp is when the check was executed.
       Timestamp time.Time
       // Error is the check error (nil if healthy).
       Error error
   }
   ```

Key points from CONTEXT.md:
- Critical field defaults to true (affects overall status)
- Non-critical (warning) checks report independently but don't fail overall health
  </action>
  <verify>
```bash
# Package compiles
go build ./healthx/...

# Status tests pass
go test ./healthx/... -v -run "TestStatus"
```
  </verify>
  <done>
- healthx/doc.go exists with package documentation
- healthx/status.go exports AvailabilityStatus with StatusUnknown, StatusUp, StatusDown
- healthx/check.go exports Check struct and CheckResult struct
- No external dependencies (only Go stdlib)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create parallel checker with timeout and panic recovery</name>
  <files>
    - healthx/checker.go
    - healthx/checker_test.go
  </files>
  <action>
Implement the checker with parallel execution per CONTEXT.md decisions:

1. **healthx/checker.go** - Checker implementation (HLT-02, HLT-03):
   ```go
   // Checker executes health checks and returns aggregated results.
   type Checker interface {
       // Check runs all configured health checks and returns the result.
       Check(ctx context.Context) CheckerResult
   }

   // CheckerResult holds the aggregated health status and details.
   type CheckerResult struct {
       // Status is the aggregated availability status.
       Status AvailabilityStatus
       // Details contains per-check results keyed by check name.
       Details map[string]CheckResult
   }

   // CheckerOption configures the Checker.
   type CheckerOption func(*checkerConfig)

   // NewChecker creates a new Checker with the given options.
   func NewChecker(opts ...CheckerOption) Checker

   // WithCheck adds a health check to the checker.
   func WithCheck(check Check) CheckerOption

   // WithTimeout sets the default timeout for checks (default 5s).
   func WithTimeout(timeout time.Duration) CheckerOption
   ```

   Implementation requirements from CONTEXT.md:
   - Checks run in parallel (concurrent) using goroutines
   - Each check gets per-check timeout via context.WithTimeout (default 5s)
   - Panic recovery: wrap check execution in defer/recover, mark as failed
   - Use sync.Mutex for collecting results safely
   - Use sync.WaitGroup to wait for all checks
   - Overall status logic:
     - StatusUp only if ALL critical checks pass
     - StatusDown if ANY critical check fails
     - Warning (non-critical) checks don't affect overall status
     - StatusUnknown if no critical checks configured

2. **healthx/checker_test.go** - Comprehensive checker tests:
   - Test single check passing
   - Test single check failing
   - Test multiple checks in parallel (verify concurrency)
   - Test per-check timeout (slow check gets cancelled)
   - Test panic recovery (panicking check marked as failed)
   - Test critical vs non-critical checks (overall status logic)
   - Test empty checker (no checks configured)
   - Test WithTimeout option

Key implementation pattern from RESEARCH.md:
```go
func (c *checker) executeCheck(ctx context.Context, check *Check) CheckResult {
    timeout := check.Timeout
    if timeout == 0 {
        timeout = c.defaultTimeout
    }
    
    ctx, cancel := context.WithTimeout(ctx, timeout)
    defer cancel()
    
    result := CheckResult{
        Status:    StatusUp,
        Timestamp: time.Now().UTC(),
    }
    
    // Panic recovery
    err := func() (err error) {
        defer func() {
            if r := recover(); r != nil {
                err = fmt.Errorf("panic: %v", r)
            }
        }()
        return check.Check(ctx)
    }()
    
    if err != nil {
        result.Status = StatusDown
        result.Error = err
    }
    
    return result
}
```
  </action>
  <verify>
```bash
# Package compiles
go build ./healthx/...

# All checker tests pass
go test ./healthx/... -v

# Run with race detector (concurrency safety)
go test ./healthx/... -race

# Verify test coverage
go test ./healthx/... -cover
```
  </verify>
  <done>
- healthx/checker.go exports Checker interface, CheckerResult, NewChecker, WithCheck, WithTimeout
- Checks execute in parallel with goroutines
- Per-check timeouts work (default 5s)
- Panicking checks are recovered and marked as failed
- Critical vs non-critical logic works correctly
- All tests pass with race detector
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

```bash
# Full package test with coverage
go test ./healthx/... -v -cover -race

# Verify no external dependencies
go list -m all | grep -v "github.com/petabytecl/gaz" | wc -l
# Should show same count as before (no new deps)

# Verify exports
go doc ./healthx | head -30
```
</verification>

<success_criteria>
- [ ] healthx/doc.go exists with package documentation
- [ ] healthx/status.go exports AvailabilityStatus (StatusUnknown, StatusUp, StatusDown)
- [ ] healthx/check.go exports Check struct with Name, Check, Timeout, Critical fields
- [ ] healthx/check.go exports CheckResult struct with Status, Timestamp, Error
- [ ] healthx/checker.go exports Checker interface, CheckerResult, NewChecker
- [ ] healthx/checker.go exports WithCheck, WithTimeout options
- [ ] Checks execute in parallel (verified by tests)
- [ ] Per-check timeouts work (default 5s per CONTEXT.md)
- [ ] Panic recovery marks check as failed (not crash)
- [ ] Critical checks affect overall status, warnings don't
- [ ] All tests pass with race detector
- [ ] No new external dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/35-health-package/35-01-SUMMARY.md`
</output>
