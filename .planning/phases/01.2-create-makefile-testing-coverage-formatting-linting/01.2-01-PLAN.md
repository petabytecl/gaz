---
phase: 01.2-create-makefile
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Makefile, .github/workflows/ci.yml]
autonomous: true

must_haves:
  truths:
    - "`make test` runs all tests successfully"
    - "`make cover` runs tests with coverage and enforces 90% threshold"
    - "`make fmt` formats all Go files (auto-fix mode)"
    - "`make fmt-check` verifies formatting without modifying files"
    - "`make lint` runs golangci-lint"
    - "`make help` shows available targets"
    - "`make clean` removes generated files"
    - "GitHub Actions runs on push, pull_request, and nightly schedule"
  artifacts:
    - path: "Makefile"
      provides: "Development workflow targets"
      contains: ".PHONY"
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline"
      contains: "golangci-lint"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "Makefile"
      via: "make commands in workflow steps"
      pattern: "make (fmt-check|lint|cover)"
---

<objective>
Create Makefile with development workflow targets and GitHub Actions CI pipeline.

Purpose: Standardize development workflow with automated testing, coverage enforcement, formatting, and linting. Enable CI to validate all PRs and scheduled nightly runs.

Output: Makefile with test/cover/fmt/lint/clean/help targets + GitHub Actions workflow using these targets.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.2-create-makefile-testing-coverage-formatting-linting/01.2-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Makefile with all development targets</name>
  <files>Makefile</files>
  <action>
Create Makefile with the following targets:

**Variables:**
- `COVERAGE_THRESHOLD := 90` - minimum coverage percentage

**Targets:**
1. `help` (DEFAULT - runs when `make` invoked with no args) - list all available targets with descriptions
2. `test` - run `go test ./...` with race detector
3. `cover` - run tests with coverage, generate coverage.out, check threshold >= 90%, fail with clear message if below
4. `fmt` - run `gofmt -w .` AND `goimports -w .` (auto-fix mode)
5. `fmt-check` - verify formatting without modifying (for CI), fail if any file would be changed. Use `gofmt -l .` and `goimports -l .`, fail if output is non-empty
6. `lint` - run `golangci-lint run`, check if golangci-lint is installed first, fail with helpful install message if missing
7. `clean` - remove coverage.out and any other generated files

**Requirements:**
- Use `.PHONY` for all targets
- Default target must be `help`
- `lint` must check for golangci-lint availability: `@command -v golangci-lint >/dev/null || (echo "golangci-lint not installed. Run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest" && exit 1)`
- Coverage threshold check: parse coverage percentage from `go tool cover -func=coverage.out`, compare against threshold, fail if below
  </action>
  <verify>
`make help` shows all targets
`make test` runs tests (should pass)
`make fmt` runs without error
`make fmt-check` passes (no formatting issues)
`make lint` runs (may fail if golangci-lint not installed - that's expected)
`make cover` runs and shows coverage percentage
  </verify>
  <done>
Makefile exists with all 7 targets. `make` (no args) shows help. All targets are executable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create GitHub Actions workflow at `.github/workflows/ci.yml`:

**Triggers:**
- `push` to any branch
- `pull_request` to any branch  
- `schedule` - cron for nightly (e.g., `'0 0 * * *'` midnight UTC)

**Matrix:**
- Go versions: 1.22, 1.23, 1.24

**Jobs:**
1. `test` job:
   - runs-on: ubuntu-latest
   - strategy: matrix with go-version
   - steps:
     1. Checkout code
     2. Set up Go (use actions/setup-go@v5)
     3. Install goimports: `go install golang.org/x/tools/cmd/goimports@latest`
     4. Install golangci-lint: use `golangci/golangci-lint-action@v6`
     5. Run `make fmt-check`
     6. Run `make lint` 
     7. Run `make cover`

**Notes:**
- Use `fail-fast: false` in matrix strategy so all Go versions run even if one fails
- golangci-lint-action handles installation, so lint step can just run `make lint`
  </action>
  <verify>
`.github/workflows/ci.yml` exists
YAML is valid (no syntax errors)
Workflow defines test job with matrix of 3 Go versions
Workflow uses Makefile targets
  </verify>
  <done>
GitHub Actions workflow file exists with push/PR/schedule triggers, Go version matrix (1.22, 1.23, 1.24), and runs fmt-check + lint + cover via Makefile targets.
  </done>
</task>

</tasks>

<verification>
1. `make` - shows help output with all targets listed
2. `make test` - runs tests successfully  
3. `make cover` - shows coverage percentage, enforces 90% threshold
4. `make fmt-check` - passes (no formatting issues in codebase)
5. `make lint` - runs golangci-lint (if installed)
6. `cat .github/workflows/ci.yml` - shows valid workflow with matrix
</verification>

<success_criteria>
- Makefile exists with test, cover, fmt, fmt-check, lint, clean, help targets
- Default `make` (no args) shows help
- `make cover` enforces 90% minimum threshold
- GitHub Actions workflow triggers on push, PR, and schedule
- CI tests against Go 1.22, 1.23, 1.24
- CI runs fmt-check + lint + cover
</success_criteria>

<output>
After completion, create `.planning/phases/01.2-create-makefile-testing-coverage-formatting-linting/01.2-01-SUMMARY.md`
</output>
