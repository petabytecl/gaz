---
phase: 02.1-improve-code-quality
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - app.go
  - container.go
  - registration.go
autonomous: true

must_haves:
  truths:
    - "No copyloopvar issues in app.go"
    - "No shadow issues in app.go"
    - "No errcheck issues in container.go or registration.go"
    - "No unused-parameter issues in registration.go"
  artifacts:
    - path: "app.go"
      provides: "Fixed production code"
    - path: "container.go"
      provides: "Fixed type assertions"
    - path: "registration.go"
      provides: "Fixed error handling and params"
  key_links:
    - from: "container.go"
      to: "serviceWrapper interface"
      via: "checked type assertion"
      pattern: "ok.*serviceWrapper"
---

<objective>
Fix production code lint issues in app.go, container.go, registration.go

Purpose: Resolve copyloopvar, shadow, errcheck, errorlint, mnd, perfsprint issues in core files
Output: Clean production code in app.go, container.go, registration.go
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@app.go
@container.go
@registration.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix app.go lint issues</name>
  <files>app.go</files>
  <action>
Fix the following issues in app.go:

1. **copyloopvar** (lines 98, 186): Delete the loop variable copies - Go 1.22+ doesn't need them
   - Remove `name := name` inside the loop body

2. **errorlint** (line 204): Use `%w` for error wrapping instead of `%v`
   - Change `fmt.Errorf("%v; %w", lastErr, err)` to proper chaining
   - Use `errors.Join(lastErr, err)` instead (Go 1.20+) or wrap properly

3. **shadow** (lines 103, 111, 191): Fix variable shadowing of `err`
   - Use `=` instead of `:=` when `err` is already declared
   - Or rename inner variables to avoid shadowing

4. **mnd** (line 42): Extract magic number 30 to a named constant
   - Add `const defaultShutdownTimeout = 30 * time.Second`

5. **perfsprint** (line 64): Use `errors.New` instead of `fmt.Errorf` when no formatting
   - Change `fmt.Errorf("message")` to `errors.New("message")`
  </action>
  <verify>Run `make lint 2>&1 | grep "app.go" | grep -v "_test" | wc -l` returns 0</verify>
  <done>app.go has zero production lint issues</done>
</task>

<task type="auto">
  <name>Task 2: Fix container.go and registration.go lint issues</name>
  <files>container.go, registration.go</files>
  <action>
**container.go fixes:**

1. **errcheck** (lines 132, 186): Check type assertion results
   - Change `wrapper := svc.(serviceWrapper)` to:
     ```go
     wrapper, ok := svc.(serviceWrapper)
     if !ok {
         return fmt.Errorf("invalid service wrapper type")
     }
     ```

2. **mnd** (line 73): Extract magic number 10 to a named constant
   - Add `const defaultServiceCapacity = 10` and use it in make()

**registration.go fixes:**

1. **errcheck** (lines 92, 102): Check type assertion in OnStart/OnStop wrapper
   - The assertion `instance.(T)` should be checked
   - Add `, ok := instance.(T)` with error handling

2. **unused-parameter** (lines 89, 100): Rename unused `opts` to `_`
   - Change `opts OnStartOptions` to `_ OnStartOptions`
   - These are intentionally unused for future extensibility
  </action>
  <verify>Run `make lint 2>&1 | grep -E "(container\.go|registration\.go)" | grep -v "_test" | wc -l` returns 0</verify>
  <done>container.go and registration.go have zero production lint issues</done>
</task>

</tasks>

<verification>
```bash
# Verify no production issues in these files
make lint 2>&1 | grep -E "(app\.go|container\.go|registration\.go)" | grep -v "_test"

# Should show nothing
```
</verification>

<success_criteria>
- [ ] copyloopvar issues fixed in app.go (2 issues)
- [ ] errorlint issue fixed in app.go (1 issue)
- [ ] shadow issues fixed in app.go (3 issues)
- [ ] mnd issues fixed in app.go and container.go (2 issues)
- [ ] perfsprint issue fixed in app.go (1 issue)
- [ ] errcheck issues fixed in container.go (2 issues)
- [ ] errcheck issues fixed in registration.go (2 issues)
- [ ] unused-parameter issues fixed in registration.go (2 issues)
- [ ] Total: ~15 issues resolved
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-improve-code-quality-validating-linter-config/02.1-02-SUMMARY.md`
</output>
