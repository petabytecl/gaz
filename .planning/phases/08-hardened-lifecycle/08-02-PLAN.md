---
phase: 08-hardened-lifecycle
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - app.go
autonomous: true

must_haves:
  truths:
    - "First SIGINT logs hint about Ctrl+C again to force"
    - "Second SIGINT triggers immediate os.Exit(1)"
    - "SIGTERM triggers graceful shutdown (no double-signal behavior)"
    - "Force exit logs a brief message before exiting"
  artifacts:
    - path: "app.go"
      provides: "Double-SIGINT detection and force exit in Run()"
      contains: "Ctrl+C again to force"
  key_links:
    - from: "Run() signal handling"
      to: "double-signal detection"
      via: "counting SIGINT occurrences"
      pattern: "os\\.Interrupt"
    - from: "second SIGINT"
      to: "exitFunc(1)"
      via: "immediate call on second signal"
      pattern: "force.*exit"
---

<objective>
Implement double-SIGINT immediate exit behavior so users can force-quit a hanging shutdown.

Purpose: When graceful shutdown takes too long, users should be able to press Ctrl+C a second time to immediately terminate the process without waiting for the timeout.

Output: Modified `app.go` with double-SIGINT detection in `Run()` that shows a hint on first signal and immediately exits on second SIGINT.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hardened-lifecycle/08-CONTEXT.md
@.planning/phases/08-hardened-lifecycle/08-01-SUMMARY.md
@app.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Double-SIGINT Force Exit</name>
  <files>app.go</files>
  <action>
Modify signal handling in `Run()` to detect double-SIGINT and force exit:

1. **Refactor signal handling block** (current lines ~570-591):
   - Keep signal channel buffered: `make(chan os.Signal, 1)`
   - Continue listening for signals after first received

2. **On first SIGINT or SIGTERM**:
   - Log hint message: `"Shutting down gracefully... (Ctrl+C again to force)"`
   - Record whether it was SIGINT (for double-signal tracking)
   - Start graceful shutdown in a goroutine (so we can continue listening)
   - If it was SIGTERM, don't enable double-signal behavior (SIGTERM + SIGKILL is the ops pattern)

3. **Spawn force-exit watcher goroutine** (only if first signal was SIGINT):
   - Continue listening on signal channel for second SIGINT
   - On second SIGINT:
     - Log: `"Received second interrupt, forcing exit"`
     - Call `exitFunc(1)` immediately
   - Use a `done` channel to exit the watcher when shutdown completes normally

4. **Integration with global timeout**:
   - The global timeout goroutine (from 08-01) also calls exitFunc(1)
   - Both paths (double-SIGINT and global timeout) should log before exiting
   - No coordination needed - whichever triggers first wins

5. **Handle context cancellation**:
   - If Run()'s context is cancelled, treat it like SIGTERM (graceful, no double-signal)

Implementation structure:
```go
case sig := <-sigCh:
    // Log hint
    a.Logger.InfoContext(ctx, "Shutting down gracefully...", "hint", "Ctrl+C again to force")
    
    // Create shutdown context and done channel
    shutdownCtx, cancel := context.WithTimeout(context.Background(), a.opts.ShutdownTimeout)
    defer cancel()
    shutdownDone := make(chan error, 1)
    
    // Start graceful shutdown in goroutine
    go func() {
        shutdownDone <- a.Stop(shutdownCtx)
    }()
    
    // If SIGINT, spawn force-exit watcher
    if sig == os.Interrupt {
        go func() {
            select {
            case <-sigCh:
                a.Logger.ErrorContext(ctx, "Received second interrupt, forcing exit")
                exitFunc(1)
            case <-shutdownDone:
                // Normal completion
            }
        }()
    }
    
    // Wait for shutdown to complete
    return <-shutdownDone
```

Note: Be careful with channel semantics - the force-exit watcher reads from sigCh, which means signal.Notify must not be stopped until after shutdown completes or force exit happens.
  </action>
  <verify>
```bash
go build ./... && go test -run "TestSignalHandling" -v
```
Existing signal handling test passes. New behavior verified by manual review.
  </verify>
  <done>
- First SIGINT logs hint message about Ctrl+C to force
- Second SIGINT calls exitFunc(1) immediately with log
- SIGTERM does not enable double-signal behavior
- Graceful shutdown runs in goroutine so force-exit watcher can receive signals
- Force-exit watcher properly terminated when shutdown completes normally
  </done>
</task>

</tasks>

<verification>
```bash
# Build succeeds
go build ./...

# All app tests pass
go test -v -run "Test.*App.*|TestSignalHandling|TestRunAndStop"

# Lint passes
golangci-lint run
```
</verification>

<success_criteria>
- LIFE-03: Double SIGINT triggers immediate exit
- First SIGINT shows hint message
- SIGTERM remains single-signal graceful
- Existing signal tests pass
- No golangci-lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-hardened-lifecycle/08-02-SUMMARY.md`
</output>
