---
phase: 41-refactor-server-module-architecture-and-consistency
plan: 03
type: execute
wave: 3
depends_on: [41-01, 41-02]
files_modified:
  - server/grpc/module.go
  - server/http/module.go
  - server/otel/module.go
  - health/module.go
autonomous: true
must_haves:
  truths:
    - "All server modules have NewModuleWithFlags"
    - "NewModuleWithFlags signature is consistent"
  artifacts:
    - path: "server/grpc/module.go"
      provides: "NewModuleWithFlags"
    - path: "server/http/module.go"
      provides: "NewModuleWithFlags"
    - path: "server/otel/module.go"
      provides: "NewModuleWithFlags"
    - path: "health/module.go"
      provides: "NewModuleWithFlags"
  key_links:
    - from: "server/grpc/module.go"
      to: "github.com/spf13/pflag"
      via: "flag registration"
---

<objective>
Unify module configuration with flags across all server packages.
Purpose: consistent configuration experience for CLI apps.
Output: NewModuleWithFlags implementations in all server modules.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@server/gateway/module.go
@server/grpc/module.go
@server/http/module.go
@server/otel/module.go
@health/module.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NewModuleWithFlags to server packages</name>
  <files>server/grpc/module.go, server/http/module.go, server/otel/module.go</files>
  <action>
    Implement `NewModuleWithFlags(fs *pflag.FlagSet, opts ...ModuleOption) di.Module` in:
    - `server/grpc/module.go`: Add flags for port, etc.
    - `server/http/module.go`: Add flags for port, etc.
    - `server/otel/module.go`: Add flags for endpoint, service name, sample ratio.
    
    Match the pattern in `server/gateway/module.go`.
    Ensure flags use consistent naming (e.g. `--grpc-port`, `--http-port`, `--otel-endpoint`).
  </action>
  <verify>grep "func NewModuleWithFlags" server/grpc/module.go server/http/module.go server/otel/module.go</verify>
  <done>All server packages support flag configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Add NewModuleWithFlags to health package</name>
  <files>health/module.go</files>
  <action>
    Implement `NewModuleWithFlags(fs *pflag.FlagSet, opts ...ModuleOption) di.Module` in `health/module.go`.
    Add flags for:
    - `--health-port`
    - `--health-liveness-path`
    - `--health-readiness-path`
    - `--health-startup-path`
    
    Match the pattern in `server/gateway/module.go`.
  </action>
  <verify>grep "func NewModuleWithFlags" health/module.go</verify>
  <done>Health package supports flag configuration.</done>
</task>

</tasks>

<verification>
Run `make test` and `make lint`.
Verify all NewModuleWithFlags signatures match: `func NewModuleWithFlags(fs *pflag.FlagSet, opts ...ModuleOption) di.Module`.
</verification>

<success_criteria>
- All server-related modules provide consistent flag configuration support.
</success_criteria>

<output>
After completion, create `.planning/phases/41-refactor-server-module-architecture-and-consistency/41-03-SUMMARY.md`
</output>
