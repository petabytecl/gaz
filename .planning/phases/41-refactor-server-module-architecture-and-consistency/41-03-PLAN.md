---
phase: 41-refactor-server-module-architecture-and-consistency
plan: 03
type: execute
wave: 3
depends_on: [41-02]
files_modified:
  - server/module.go
  - server/grpc/config.go
  - server/http/config.go
  - server/gateway/config.go
  - server/otel/config.go
  - server/grpc/module.go
  - server/http/module.go
  - server/gateway/module.go
  - server/otel/module.go
autonomous: true
must_haves:
  truths:
    - "server.NewModule registers gRPC + Gateway only"
    - "server packages expose Config structs implementing gaz.ConfigProvider"
    - "Bare Module() functions are removed"
  artifacts:
    - path: "server/grpc/config.go"
      provides: "Config struct with Namespace/Flags"
    - path: "server/gateway/config.go"
      provides: "Config struct with Namespace/Flags"
  key_links:
    - from: "server/module.go"
      to: "server/grpc"
      via: "NewModule"
    - from: "server/module.go"
      to: "server/gateway"
      via: "NewModule"
---

<objective>
Refactor module bundling and adopt ConfigProvider pattern.
Purpose: Fix wrong module bundling (gRPC+HTTP -> gRPC+Gateway) and standardize configuration.
Output: Simplified API and structured config injection.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@server/module.go
@server/grpc/module.go
@server/http/module.go
@server/gateway/module.go
@server/otel/module.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Adopt ConfigProvider pattern</name>
  <files>server/grpc/config.go, server/http/config.go, server/gateway/config.go, server/otel/config.go</files>
  <action>
    For each package (grpc, http, gateway, otel):
    1. Create/Update `config.go` with a `Config` struct.
    2. Implement `Namespace() string` and `Flags(fs *pflag.FlagSet)` methods on `Config`.
    3. Ensure existing config fields (Port, Host, etc.) are mapped to flags with defaults.
    
    Refactor the module providers (`NewModule` or provider functions) to:
    - Inject `*Config` instead of relying on manually passed flags.
    - If `gaz` supports auto-binding `ConfigProvider`, rely on that. Otherwise, register the `Config` in the module via `gaz.For[*Config](c).Config()`.
  </action>
  <verify>grep "Namespace()" server/grpc/config.go</verify>
  <done>All server packages have Config structs with Namespace/Flags.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor server.NewModule</name>
  <files>server/module.go</files>
  <action>
    Update `server.NewModule(c *gaz.Container) error`:
    1. Remove `server/http` registration.
    2. Add `server/gateway` registration.
    3. Ensure `server/grpc` is registered.
    4. Remove any existing `Module()` alias if present (per simplifying API).
    
    Note: This is a BREAKING change.
  </action>
  <verify>grep "gateway.NewModule" server/module.go</verify>
  <done>server.NewModule bundles gRPC and Gateway.</done>
</task>

<task type="auto">
  <name>Task 3: Simplify API & Clean up</name>
  <files>server/grpc/module.go, server/http/module.go, server/gateway/module.go, server/otel/module.go</files>
  <action>
    1. Remove any bare `Module()` functions in subpackages if they exist.
    2. Standardize on `NewModule` (or `NewModuleWithFlags` if needed, but preference is `NewModule` + `ConfigProvider`).
    3. Since we are using `ConfigProvider`, we might not need `NewModuleWithFlags` anymore if the config is resolved via DI.
    4. Ensure the `NewModule` signature matches `func(c *gaz.Container) error` or returns a `di.Module`.
  </action>
  <verify>! grep "func Module(" server/grpc/module.go</verify>
  <done>Only NewModule exists.</done>
</task>

</tasks>

<verification>
Run `make test` to ensure basic functionality.
Check that flags are still registered correctly (via ConfigProvider).
</verification>

<success_criteria>
- server.NewModule bundles gRPC + Gateway.
- Config is handled via ConfigProvider pattern.
- API is simplified (no bare Module functions).
</success_criteria>

<output>
After completion, create `.planning/phases/41-refactor-server-module-architecture-and-consistency/41-03-SUMMARY.md`
</output>
