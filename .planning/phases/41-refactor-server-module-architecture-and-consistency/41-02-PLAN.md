---
phase: 41-refactor-server-module-architecture-and-consistency
plan: 02
type: execute
wave: 2
depends_on: [41-01]
files_modified:
  - server/gateway/gateway.go
  - server/gateway/handler.go
  - server/grpc/module.go
  - server/http/module.go
autonomous: true
must_haves:
  truths:
    - "Gateway Handler() is safe to call before OnStart"
    - "Gateway handler is updated atomically"
    - "Service registration interfaces use consistent 'Registrar' naming"
  artifacts:
    - path: "server/gateway/handler.go"
      provides: "Atomic DynamicHandler implementation"
  key_links:
    - from: "server/gateway/gateway.go"
      to: "server/gateway/handler.go"
      via: "Use of DynamicHandler"
---

<objective>
Fix race condition in Gateway handler and standardize naming conventions.
Purpose: Prevent race conditions during startup and ensure consistent API naming.
Output: Thread-safe Gateway and renamed interfaces.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@server/gateway/gateway.go
@server/grpc/module.go
@server/http/module.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement DynamicHandler in Gateway</name>
  <files>server/gateway/gateway.go, server/gateway/handler.go</files>
  <action>
    1. Create `server/gateway/handler.go` with `DynamicHandler` struct.
       - Use `atomic.Value` or `sync.RWMutex` to store `http.Handler`.
       - Implement `ServeHTTP` to delegate to stored handler (or 404/503 if nil).
    2. Update `Gateway` struct to use `DynamicHandler`.
    3. In `NewGateway`, initialize `DynamicHandler`.
    4. In `OnStart`, update `DynamicHandler` with the constructed chain (Mux -> CORS -> OTEL).
    5. Update `Handler()` to return the `DynamicHandler` (which is safe to use immediately).
  </action>
  <verify>go test -race ./server/gateway/...</verify>
  <done>Gateway handler is thread-safe.</done>
</task>

<task type="auto">
  <name>Task 2: Standardize Registrar naming</name>
  <files>server/grpc/module.go, server/http/module.go</files>
  <action>
    Check for interfaces named `Registerer` or similar in `server/grpc` and `server/http`.
    Rename them to `Registrar` to match `server/gateway/gateway.go`.
    Update all references and implementations.
    
    (If they are already named Registrar, this is a no-op check).
  </action>
  <verify>grep "Registrar" server/grpc/module.go server/http/module.go</verify>
  <done>All registration interfaces are named Registrar.</done>
</task>

</tasks>

<verification>
Run `make test` to ensure no regressions.
Verify race detector on gateway tests.
</verification>

<success_criteria>
- Gateway uses atomic handler swapping.
- Naming is consistent (Registrar).
</success_criteria>

<output>
After completion, create `.planning/phases/41-refactor-server-module-architecture-and-consistency/41-02-SUMMARY.md`
</output>
