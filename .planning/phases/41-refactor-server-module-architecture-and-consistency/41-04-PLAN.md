---
phase: 41-refactor-server-module-architecture-and-consistency
plan: 04
type: execute
wave: 4
depends_on: [41-03]
files_modified:
  - server/grpc/health_adapter.go
  - server/grpc/config.go
  - server/grpc/server.go
  - health/grpc.go
autonomous: true
must_haves:
  truths:
    - "server/grpc includes health check service by default"
    - "Health check can be toggled via config"
    - "health/grpc.go does not exist"
  artifacts:
    - path: "server/grpc/health_adapter.go"
      provides: "Internal health GRPC service adapter"
  key_links:
    - from: "server/grpc/server.go"
      to: "health.Manager"
      via: "Dependency Injection"
---

<objective>
Integrate native health checks into gRPC server.
Purpose: Simplify health check setup by including it in the standard gRPC server module, toggled by config.
Output: gRPC server with built-in health support.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@server/grpc/server.go
@server/grpc/config.go
@health/grpc.go
@health/manager.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move GRPC Health Logic</name>
  <files>server/grpc/health_adapter.go, health/grpc.go</files>
  <action>
    1. Read `health/grpc.go` logic (which implements `grpc_health_v1.HealthServer`).
    2. Move it to a new file `server/grpc/health_adapter.go` (internal or unexported if possible, or `healthAdapter`).
    3. Ensure it still relies on `health.Manager` (injected).
  </action>
  <verify>test -f server/grpc/health_adapter.go</verify>
  <done>Logic moved to server/grpc.</done>
</task>

<task type="auto">
  <name>Task 2: Update GRPC Config</name>
  <files>server/grpc/config.go</files>
  <action>
    Update `Config` struct in `server/grpc/config.go`:
    1. Add `HealthEnabled bool` (default true).
    2. Add `HealthCheckInterval time.Duration`.
    3. Add flags for these in `Flags()` method (e.g., `--grpc-health-enabled`, `--grpc-health-interval`).
  </action>
  <verify>grep "HealthEnabled" server/grpc/config.go</verify>
  <done>Config supports health settings.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Health into NewServer</name>
  <files>server/grpc/server.go</files>
  <action>
    Update `NewServer` (or the provider function) in `server/grpc/server.go`:
    1. Inject `*health.Manager` (add it to function arguments or resolve it).
    2. Check `config.HealthEnabled`.
    3. If enabled, instantiate the `healthAdapter` (from Task 1) and register it with the gRPC server.
       `grpc_health_v1.RegisterHealthServer(s.Server, healthAdapter)`
  </action>
  <verify>grep "RegisterHealthServer" server/grpc/server.go</verify>
  <done>Health server registered if enabled.</done>
</task>

<task type="auto">
  <name>Task 4: Cleanup</name>
  <files>health/grpc.go</files>
  <action>
    Delete `health/grpc.go`.
    Update any tests that relied on it (likely need to move them to `server/grpc` as well).
  </action>
  <verify>! test -f health/grpc.go</verify>
  <done>Old file removed.</done>
</task>

</tasks>

<verification>
Run `make test` to ensure gRPC server starts and health checks work.
Verify that disabling health via config works (maybe adding a test case for this).
</verification>

<success_criteria>
- gRPC server exposes standard GRPC health check service.
- Config controls availability.
- health/grpc.go is gone.
</success_criteria>

<output>
After completion, create `.planning/phases/41-refactor-server-module-architecture-and-consistency/41-04-SUMMARY.md`
</output>
