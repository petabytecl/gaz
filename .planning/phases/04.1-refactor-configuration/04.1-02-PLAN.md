---
phase: 04.1-refactor-configuration
plan: 02
type: execute
wave: 2
depends_on:
  - 04.1-01
files_modified:
  - app.go
  - cobra.go
  - app_test.go
  - cobra_test.go
autonomous: true
must_haves:
  truths:
    - "App struct uses ConfigManager instead of direct viper calls"
    - "WithConfig accepts variadic ConfigOption arguments"
    - "Cobra integration delegates flag binding to ConfigManager"
    - "All existing tests pass with the new API"
  artifacts:
    - path: "app.go"
      provides: "Refactored App struct"
    - path: "cobra.go"
      provides: "Updated WithCobra hook"
  key_links:
    - from: "App.WithConfig"
      to: "NewConfigManager"
      via: "instantiation"
---

<objective>
Integrate ConfigManager into App and Cobra, completing the refactor.

Purpose: Replace legacy configuration logic in App with the new decoupled ConfigManager.
Output: Refactored App and Cobra integration passing all tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/04.1-refactor-configuration/04.1-01-SUMMARY.md
@app.go
@cobra.go
@config_manager.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor App to use ConfigManager</name>
  <files>app.go</files>
  <action>
    Modify `App` struct:
    - Remove `viper *viper.Viper` field.
    - Add `configManager *ConfigManager` field.
    
    Modify `WithConfig`:
    - Change signature to `func(target any, opts ...ConfigOption) *App`.
    - Initialize `ConfigManager` and store it.
    - Remove `ConfigOptions` struct definition if defined here (or in types.go).
    
    Modify `loadConfig` (internal method called by Run/Build):
    - Delegate entirely to `a.configManager.Load()`.
    
    Remove `bindStructEnv` from `app.go` (it's now in ConfigManager).
  </action>
  <verify>go build app.go</verify>
  <done>App struct uses ConfigManager</done>
</task>

<task type="auto">
  <name>Task 2: Update Cobra Integration</name>
  <files>cobra.go</files>
  <action>
    Modify `WithCobra` implementation:
    - In the `PersistentPreRunE` hook, check if `a.configManager` is not null.
    - Call `a.configManager.BindFlags(cmd.Flags())`.
    - Remove any direct viper binding logic.
  </action>
  <verify>go build cobra.go</verify>
  <done>Cobra integration uses ConfigManager</done>
</task>

<task type="auto">
  <name>Task 3: Update Tests</name>
  <files>app_test.go, cobra_test.go</files>
  <action>
    Update all calls to `WithConfig` in test files to use the new functional options syntax.
    Example: `WithConfig(&cfg, ConfigOptions{...})` -> `WithConfig(&cfg, WithName("..."))`.
    
    Verify `cobra_test.go` still passes end-to-end (flags -> config).
  </action>
  <verify>make test</verify>
  <done>All tests pass</done>
</task>

</tasks>

<verification>
Run full project test suite to ensure no regressions.
`make test`
</verification>

<success_criteria>
- [ ] App compiles with new ConfigManager
- [ ] WithConfig API uses functional options
- [ ] Cobra flags bind correctly
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-refactor-configuration/04.1-02-SUMMARY.md`
</output>
