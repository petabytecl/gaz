---
phase: 22-test-coverage-improvement
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - health/module_test.go
  - health/integration_test.go
  - app_test.go
autonomous: true

must_haves:
  truths:
    - "health.Module error paths are tested"
    - "WithHealthChecks integration helper is tested"
    - "App.EventBus() accessor is tested"
    - "WithLoggerConfig option is tested"
  artifacts:
    - path: "health/module_test.go"
      provides: "Extended Module error path tests"
    - path: "health/integration_test.go"
      provides: "Tests for WithHealthChecks"
    - path: "app_test.go"
      provides: "Tests for EventBus and WithLoggerConfig"
  key_links:
    - from: "health/module_test.go"
      to: "health/module.go"
      via: "error path coverage"
---

<objective>
Improve health package (83.8%) and app.go coverage for EventBus/WithLoggerConfig

Purpose: Cover health.Module error paths (65.4%), WithHealthChecks (0%), and app accessors
Output: Tests for error scenarios and integration helpers
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@health/module.go
@health/integration.go
@app.go
@health/module_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health.Module error path tests</name>
  <files>health/module_test.go</files>
  <action>
Extend health/module_test.go with error path tests:

1. TestModule_ShutdownCheckError:
   - Create container that will fail ShutdownCheck registration
   - Verify error is returned with "register shutdown check" message

2. TestModule_ManagerError:
   - Mock scenario where Manager registration fails
   - Verify error contains "register manager" message

3. TestModule_ManagementServerError:
   - Mock scenario where ManagementServer registration fails
   - Verify error contains "register management server" message

4. TestModule_ConfigNotRegistered:
   - Call Module without registering health.Config
   - Verify appropriate error when resolving Config in ManagementServer provider

Note: Error paths require manipulating container state to trigger failures.
Use container that already has conflicting registrations or mock providers that fail.
  </action>
  <verify>go test -v -run "TestModule" ./health/...</verify>
  <done>Module error paths for ShutdownCheck, Manager, and ManagementServer covered</done>
</task>

<task type="auto">
  <name>Task 2: Add WithHealthChecks and integration tests</name>
  <files>health/integration_test.go</files>
  <action>
Create health/integration_test.go:

1. TestWithHealthChecks:
   - Create gaz.App
   - Apply WithHealthChecks with custom config
   - Verify health.Config is registered in container
   - Verify health.Module is applied
   - Start app and verify management server is running
   - Make HTTP request to health endpoint

2. TestWithHealthChecks_DefaultConfig:
   - Apply WithHealthChecks with DefaultConfig()
   - Verify default port (8081) and paths are used

Note: WithHealthChecks is in health/integration.go and is currently at 0% coverage.
  </action>
  <verify>go test -v -run "TestWithHealthChecks" ./health/...</verify>
  <done>WithHealthChecks tested with custom and default configs</done>
</task>

<task type="auto">
  <name>Task 3: Add EventBus and WithLoggerConfig tests</name>
  <files>app_test.go</files>
  <action>
Extend app_test.go with:

1. TestApp_EventBus:
   - Create App with eventbus provider
   - Call app.EventBus()
   - Verify returns eventbus instance
   - Test eventbus is nil before Build()

2. TestWithLoggerConfig:
   - Create App with WithLoggerConfig option
   - Verify logger is configured with provided config
   - Test with custom log level and format

3. TestDiscoverCronJobs:
   - Register service implementing cron.JobProvider
   - Build app
   - Verify cron jobs are discovered and registered
   - Test error paths (invalid schedule, etc.)

Note: EventBus() is 0%, WithLoggerConfig is 0%, discoverCronJobs is 38.5%.
  </action>
  <verify>go test -v -run "TestApp_EventBus|TestWithLoggerConfig|TestDiscoverCronJobs" ./...</verify>
  <done>EventBus accessor, WithLoggerConfig option, and discoverCronJobs paths covered</done>
</task>

</tasks>

<verification>
```bash
go test -cover ./health/... 2>&1 | grep "coverage:"
# Expected: health package coverage should be 90%+ (up from 83.8%)

go test -cover . 2>&1 | grep "coverage:"
# Expected: root package EventBus and WithLoggerConfig no longer at 0%
```
</verification>

<success_criteria>
- health package coverage reaches 90%+
- health.Module coverage: 85%+ (was 65.4%)
- WithHealthChecks coverage: 80%+ (was 0%)
- App.EventBus() coverage: 100% (was 0%)
- WithLoggerConfig coverage: 80%+ (was 0%)
</success_criteria>

<output>
After completion, create `.planning/phases/22-test-coverage-improvement/22-03-SUMMARY.md`
</output>
