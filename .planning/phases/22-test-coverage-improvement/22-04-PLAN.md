---
phase: 22-test-coverage-improvement
plan: 04
type: execute
wave: 2
depends_on: ["22-01", "22-02", "22-03"]
files_modified:
  - di/service_test.go
  - config/viper/backend_test.go
  - worker/supervisor_test.go
autonomous: true

must_haves:
  truths:
    - "IsTransient() methods are tested on all service types"
    - "Viper backend write operations are tested"
    - "Worker supervisor stop function is tested"
  artifacts:
    - path: "di/service_test.go"
      provides: "Extended service wrapper tests"
    - path: "config/viper/backend_test.go"
      provides: "Tests for write operations"
    - path: "worker/supervisor_test.go"
      provides: "Tests for stop function"
  key_links:
    - from: "di/service_test.go"
      to: "di/service.go"
      via: "IsTransient coverage"
---

<objective>
Complete remaining coverage gaps to reach 90% threshold

Purpose: Cover IsTransient (0%), viper write ops (0%), worker supervisor stop (0%)
Output: Final tests to push overall coverage above 90%
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@di/service.go
@config/viper/backend.go
@worker/supervisor.go
@di/service_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IsTransient and service edge case tests</name>
  <files>di/service_test.go</files>
  <action>
Extend di/service_test.go with:

1. TestLazySingleton_IsTransient:
   - Create lazy singleton
   - Verify IsTransient() returns false

2. TestTransientService_IsTransient:
   - Create transient service
   - Verify IsTransient() returns true

3. TestEagerSingleton_IsTransient:
   - Create eager singleton
   - Verify IsTransient() returns false

4. TestInstanceService_IsTransient:
   - Create instance service
   - Verify IsTransient() returns false

5. TestEagerSingleton_HasLifecycle:
   - Test HasLifecycle on eager service (currently 0%)

6. TestInstanceServiceAny_Methods:
   - Test IsEager(), IsTransient(), GetInstance() on instanceServiceAny (all 0%)

Note: These are simple accessor tests but currently show 0% because not explicitly tested.
  </action>
  <verify>go test -v -run "TestLazy.*IsTransient|TestTransient.*IsTransient|TestEager.*IsTransient|TestInstance.*IsTransient" ./di/...</verify>
  <done>IsTransient() tested on all service wrapper types, instanceServiceAny methods covered</done>
</task>

<task type="auto">
  <name>Task 2: Add Viper backend write operation tests</name>
  <files>config/viper/backend_test.go</files>
  <action>
Create or extend config/viper/backend_test.go:

1. TestBackend_WriteConfig:
   - Create backend with temp config file
   - Set values
   - Call WriteConfig()
   - Verify file written

2. TestBackend_SafeWriteConfig:
   - Create backend
   - Call SafeWriteConfig() when file doesn't exist
   - Verify file created

3. TestBackend_SetConfigFile:
   - Call SetConfigFile with path
   - Verify ConfigFileUsed() returns correct path

4. TestBackend_BindPFlags:
   - Create cobra pflags
   - Call BindPFlags
   - Verify values accessible

5. TestBackend_BindPFlag:
   - Bind single pflag
   - Verify value accessible

Note: Write operations need temp directory. Use t.TempDir().
  </action>
  <verify>go test -v -run "TestBackend_Write|TestBackend_Safe|TestBackend_SetConfig|TestBackend_BindP" ./config/viper/...</verify>
  <done>WriteConfig, SafeWriteConfig, SetConfigFile, BindPFlags, BindPFlag all tested</done>
</task>

<task type="auto">
  <name>Task 3: Add worker supervisor and remaining tests</name>
  <files>worker/supervisor_test.go</files>
  <action>
Create worker/supervisor_test.go:

1. TestSupervisor_Stop:
   - Create supervisor with running worker
   - Call stop()
   - Verify worker stopped gracefully
   - Verify done channel closed

2. TestNoopWorker_StartStop:
   - Test noopWorker Start() and Stop() (both 0%)
   - These are placeholder implementations

Also add to existing test files:

3. In lifecycle_test.go - TestWithHookTimeout:
   - Test WithHookTimeout option (0% in both di/lifecycle.go and lifecycle.go)

4. In cobra_flags_test.go - TestRegisterCobraFlags_Errors:
   - Test RegisterCobraFlags error path (57.1% coverage)
  </action>
  <verify>go test -v -run "TestSupervisor_Stop|TestNoopWorker|TestWithHookTimeout|TestRegisterCobraFlags" ./...</verify>
  <done>Supervisor stop, noopWorker methods, WithHookTimeout option tested</done>
</task>

</tasks>

<verification>
```bash
make cover
# Expected: Coverage >= 90% (threshold passes)
```
</verification>

<success_criteria>
- `make cover` passes (coverage >= 90%)
- di package: 85%+ (was 73.3%)
- config package: 90%+ (was 77.1%)
- config/viper package: 90%+ (was 83.3%)
- health package: 90%+ (was 83.8%)
- Overall: 90%+ (was 84.3%)
</success_criteria>

<output>
After completion, create `.planning/phases/22-test-coverage-improvement/22-04-SUMMARY.md`
</output>
