---
phase: 24-lifecycle-interface
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - di/registration.go
  - di/service.go
  - di/registration_test.go
autonomous: true

must_haves:
  truths:
    - "RegistrationBuilder has no OnStart() or OnStop() fluent methods"
    - "Service types have no startHooks or stopHooks fields"
    - "Interface-based lifecycle auto-detection (Starter/Stopper) still works"
    - "All DI package tests pass"
  artifacts:
    - path: "di/registration.go"
      provides: "RegistrationBuilder without fluent hook methods"
      min_lines: 100
    - path: "di/service.go"
      provides: "Service wrappers with interface-only lifecycle"
      contains: "runStartLifecycle"
  key_links:
    - from: "di/service.go"
      to: "di.Starter"
      via: "type assertion in runStartLifecycle"
      pattern: "instance\\.\\(Starter\\)"
    - from: "di/service.go"
      to: "di.Stopper"
      via: "type assertion in runStopLifecycle"
      pattern: "instance\\.\\(Stopper\\)"
---

<objective>
Remove OnStart/OnStop fluent methods from RegistrationBuilder - interface-only lifecycle

Purpose: Simplify lifecycle management by removing the dual mechanism (fluent hooks vs interfaces). Services requiring lifecycle must implement Starter/Stopper interfaces directly on the type. This is a v3.0 breaking change.

Output: DI package with interface-only lifecycle, all tests passing
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-lifecycle-interface/24-CONTEXT.md

@di/registration.go
@di/service.go
@di/lifecycle.go
@di/registration_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove Fluent Hook Methods from RegistrationBuilder</name>
  <files>di/registration.go</files>
  <action>
    Remove the OnStart() and OnStop() fluent methods and their supporting fields:

    1. Remove from RegistrationBuilder struct:
       - `startHooks   []func(context.Context, any) error`
       - `stopHooks    []func(context.Context, any) error`

    2. Delete the OnStart() method entirely (lines ~88-104)

    3. Delete the OnStop() method entirely (lines ~106-122)

    4. Update Provider() method:
       - Remove startHooks/stopHooks parameters from newLazySingleton() call
       - Remove startHooks/stopHooks parameters from newEagerSingleton() call

    5. Update Instance() method:
       - Remove startHooks/stopHooks parameters from newInstanceService() call

    6. Keep all other methods unchanged: Named(), Transient(), Eager(), Replace(), Provider(), ProviderFunc(), Instance()
  </action>
  <verify>
    `grep -n "OnStart\|OnStop" di/registration.go` returns no matches (methods removed)
    `grep -n "startHooks\|stopHooks" di/registration.go` returns no matches (fields removed)
    `go build ./di/...` compiles (may fail due to service.go - that's expected, fixed in Task 2)
  </verify>
  <done>
    RegistrationBuilder has no OnStart/OnStop methods, no hook fields
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify Service Wrappers to Interface-Only Lifecycle</name>
  <files>di/service.go</files>
  <action>
    Remove fluent hook handling from service wrappers, keeping only interface-based lifecycle:

    1. Update baseService struct:
       - Remove `startHooks []func(context.Context, any) error`
       - Remove `stopHooks  []func(context.Context, any) error`

    2. Update HasLifecycle() on baseService:
       - Remove hook length check, just return false (base has no lifecycle)
       - The typed wrappers override this with interface checking

    3. Delete these methods from baseService:
       - `runStartHooks()` - no longer needed
       - `runStopHooks()` - no longer needed

    4. Simplify runStartLifecycle():
       - Remove the "if explicit hooks" branch entirely
       - Just check for Starter interface and call OnStart(ctx)

    5. Simplify runStopLifecycle():
       - Remove the "if explicit hooks" branch entirely
       - Just check for Stopper interface and call OnStop(ctx)

    6. Update factory functions (remove hook parameters):
       - `newLazySingleton(name, typeName string, provider func)` - no hook params
       - `newEagerSingleton(name, typeName string, provider func)` - no hook params
       - `newInstanceService(name, typeName string, value T)` - no hook params
       - `NewInstanceServiceAny(name, typeName string, value any)` - no hook params

    7. Update the service wrapper constructors to not store hooks in baseService

    8. Update lazySingleton.Start() and lazySingleton.Stop():
       - Call runStartLifecycle/runStopLifecycle directly (they now only check interfaces)
  </action>
  <verify>
    `grep -n "startHooks\|stopHooks" di/service.go` returns no matches
    `grep -n "runStartHooks\|runStopHooks" di/service.go` returns no matches
    `go build ./di/...` compiles successfully
  </verify>
  <done>
    Service wrappers only use interface-based lifecycle (Starter/Stopper), no fluent hooks
  </done>
</task>

<task type="auto">
  <name>Task 3: Update DI Package Tests</name>
  <files>di/registration_test.go</files>
  <action>
    Update tests to reflect removed fluent hooks:

    1. Delete these test methods that test removed functionality:
       - `TestFor_OnStart_HookCalled` (tests removed OnStart method)
       - `TestFor_OnStop_HookCalled` (tests removed OnStop method)
       - `TestFor_BothHooks_CalledCorrectly` (tests removed hook functionality)

    2. Verify lifecycle_auto_test.go tests still pass:
       - These test Starter/Stopper interface detection
       - No changes needed - they test the interface pattern we're keeping

    3. Run all DI tests to ensure nothing is broken:
       - Interface-based lifecycle should still work
       - All other registration tests should pass
  </action>
  <verify>
    `go test ./di/... -v` passes all tests
    `grep -n "TestFor_OnStart\|TestFor_OnStop\|TestFor_BothHooks" di/registration_test.go` returns no matches (tests deleted)
  </verify>
  <done>
    DI package tests pass, fluent hook tests removed, interface lifecycle tests pass
  </done>
</task>

</tasks>

<verification>
Run full DI package tests:
```bash
go test ./di/... -v -count=1
```

Verify no fluent hook remnants:
```bash
grep -rn "OnStart\|OnStop" di/registration.go
```
Should return no matches (methods fully removed from registration builder).

Verify interface lifecycle still works:
```bash
go test ./di/... -run "Lifecycle" -v
```
Should pass lifecycle_auto_test.go tests.
</verification>

<success_criteria>
1. RegistrationBuilder has no OnStart() or OnStop() methods
2. Service wrappers have no startHooks or stopHooks fields
3. runStartLifecycle/runStopLifecycle only check Starter/Stopper interfaces
4. All DI package tests pass
5. Interface-based lifecycle auto-detection works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/24-lifecycle-interface/24-02-SUMMARY.md`
</output>
