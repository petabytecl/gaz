---
phase: 24-lifecycle-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - worker/worker.go
  - worker/manager.go
  - worker/supervisor.go
  - worker/manager_test.go
  - worker/supervisor_test.go
autonomous: true

must_haves:
  truths:
    - "worker.Worker interface has OnStart(ctx context.Context) error method"
    - "worker.Worker interface has OnStop(ctx context.Context) error method"
    - "Worker implementations receive context and can return errors"
    - "All worker package tests pass with new interface"
  artifacts:
    - path: "worker/worker.go"
      provides: "Updated Worker interface with OnStart/OnStop signatures"
      contains: "OnStart(context.Context) error"
    - path: "worker/manager.go"
      provides: "Updated pooledWorker delegating new interface"
      contains: "OnStart(ctx)"
    - path: "worker/supervisor.go"
      provides: "Supervisor calling OnStart/OnStop with context"
      contains: "worker.OnStart(s.ctx)"
  key_links:
    - from: "worker/supervisor.go"
      to: "worker.Worker"
      via: "runWithRecovery calling OnStart/OnStop"
      pattern: "worker\\.On(Start|Stop)\\(s\\.ctx\\)"
    - from: "worker/manager.go"
      to: "worker.Worker"
      via: "pooledWorker delegation"
      pattern: "delegate\\.On(Start|Stop)"
---

<objective>
Migrate worker.Worker interface from Start()/Stop() to OnStart(ctx context.Context) error / OnStop(ctx context.Context) error

Purpose: Align worker interface with di.Starter/di.Stopper patterns, enabling context propagation and error handling for worker lifecycle operations. This is a v3.0 breaking change.

Output: Updated worker package with new interface, passing tests
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-lifecycle-interface/24-CONTEXT.md

@worker/worker.go
@worker/manager.go
@worker/supervisor.go
@di/lifecycle.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Worker Interface Definition</name>
  <files>worker/worker.go</files>
  <action>
    Update the Worker interface to match di.Starter/di.Stopper patterns:

    1. Change `Start()` to `OnStart(ctx context.Context) error`
    2. Change `Stop()` to `OnStop(ctx context.Context) error`
    3. Update all documentation/comments to reflect:
       - OnStart receives context for cancellation signals
       - OnStart returns error (startup failure stops the worker)
       - OnStop receives context with shutdown deadline
       - OnStop returns error (logged but shutdown continues)
    4. Keep `Name() string` unchanged
    5. Update the example in the doc comment to show new signatures:
       - `func (p *Poller) OnStart(ctx context.Context) error`
       - `func (p *Poller) OnStop(ctx context.Context) error`
       - Example should show spawning goroutine in OnStart, returning nil on success
       - Example should show cleanup in OnStop, returning nil

    Note: The interface should NOT embed di.Starter and di.Stopper - just have matching signatures. This keeps the worker package independent of di package.
  </action>
  <verify>
    `go build ./worker/...` succeeds (compilation check)
    Interface has correct signatures per `grep -n "OnStart\|OnStop" worker/worker.go`
  </verify>
  <done>
    Worker interface has OnStart(ctx context.Context) error and OnStop(ctx context.Context) error methods with updated documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Worker Package Implementation</name>
  <files>worker/manager.go, worker/supervisor.go</files>
  <action>
    Update implementations to use new Worker interface:

    **In worker/supervisor.go (runWithRecovery function):**
    1. Change `s.worker.Start()` to `if err := s.worker.OnStart(s.ctx); err != nil { ... }`
       - Log the error: `s.logger.Error("worker failed to start", slog.Any("error", err))`
       - Treat start failure as a panic-equivalent (increment failures, trigger restart logic)
    2. Change `s.worker.Stop()` to `if err := s.worker.OnStop(s.ctx); err != nil { ... }`
       - Log the error: `s.logger.Warn("worker stop error", slog.Any("error", err))`
       - Continue with shutdown even on error (stop errors are non-fatal)
    3. Update log messages from "worker starting"/"worker stopping" to reflect OnStart/OnStop

    **In worker/manager.go (pooledWorker type):**
    1. Change `func (p *pooledWorker) Start()` to `func (p *pooledWorker) OnStart(ctx context.Context) error`
       - Return `p.delegate.OnStart(ctx)`
    2. Change `func (p *pooledWorker) Stop()` to `func (p *pooledWorker) OnStop(ctx context.Context) error`
       - Return `p.delegate.OnStop(ctx)`
  </action>
  <verify>
    `go build ./worker/...` succeeds
    `grep -n "OnStart\|OnStop" worker/supervisor.go` shows context-aware calls
    `grep -n "OnStart\|OnStop" worker/manager.go` shows updated pooledWorker methods
  </verify>
  <done>
    Supervisor calls worker.OnStart(ctx)/OnStop(ctx), pooledWorker delegates correctly, errors are logged appropriately
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Worker Package Tests</name>
  <files>worker/manager_test.go, worker/supervisor_test.go</files>
  <action>
    Update all test worker implementations to use new interface:

    **In worker/manager_test.go (simpleWorker type):**
    1. Change `func (w *simpleWorker) Start()` to `func (w *simpleWorker) OnStart(ctx context.Context) error`
       - Add `import "context"` if not present
       - Keep existing logic, return nil at end
    2. Change `func (w *simpleWorker) Stop()` to `func (w *simpleWorker) OnStop(ctx context.Context) error`
       - Keep existing logic, return nil at end

    **In worker/supervisor_test.go (mockWorker, panicWorker types):**
    1. Update mockWorker:
       - `func (w *mockWorker) OnStart(ctx context.Context) error` - keep panic logic, return nil
       - `func (w *mockWorker) OnStop(ctx context.Context) error` - keep existing logic, return nil
    2. Update panicWorker:
       - `func (w *panicWorker) OnStart(ctx context.Context) error` - keep panic, add return nil after (unreachable)
       - `func (w *panicWorker) OnStop(ctx context.Context) error` - return nil

    Ensure all tests pass after migration. The test logic should remain the same - only signatures change.
  </action>
  <verify>
    `go test ./worker/... -v` passes all tests
    No compilation errors
  </verify>
  <done>
    All worker package tests pass with new interface signatures, test coverage maintained
  </done>
</task>

</tasks>

<verification>
Run full worker package tests:
```bash
go test ./worker/... -v -count=1
```

Verify interface compliance:
```bash
go build ./worker/...
```

Check no old interface methods remain:
```bash
grep -rn "func.*Start()" worker/*.go | grep -v OnStart
grep -rn "func.*Stop()" worker/*.go | grep -v OnStop
```
Should show no matches (only OnStart/OnStop remain).
</verification>

<success_criteria>
1. worker.Worker interface has OnStart(ctx context.Context) error signature
2. worker.Worker interface has OnStop(ctx context.Context) error signature
3. All worker package tests pass
4. Supervisor correctly propagates context to workers
5. Errors from OnStart/OnStop are logged appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/24-lifecycle-interface/24-01-SUMMARY.md`
</output>
