---
phase: 34-cron-package
plan: 03
type: execute
wave: 3
depends_on: ["34-02"]
files_modified:
  - cron/scheduler.go
  - cron/logger.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "cron/scheduler.go uses internal cronx package instead of robfig/cron/v3"
    - "cron/logger.go is deleted (no longer needed)"
    - "robfig/cron/v3 is removed from go.mod"
    - "All existing cron tests pass with the new implementation"
    - "Scheduler maintains same public API (NewScheduler, RegisterJob, etc.)"
  artifacts:
    - path: "cron/scheduler.go"
      provides: "Scheduler using internal cronx package"
      contains: "github.com/petabytecl/gaz/cronx"
    - path: "go.mod"
      provides: "Module file without robfig/cron/v3"
  key_links:
    - from: "cron/scheduler.go"
      to: "cronx/cron.go"
      via: "import and use cronx.Cron"
      pattern: "cronx\\.New|cronx\\.Cron"
    - from: "cron/wrapper.go"
      to: "cronx/cron.go"
      via: "wrapper implements cronx.Job interface"
      pattern: "cronx\\.Job"
---

<objective>
Integrate cronx into cron/scheduler and remove robfig/cron/v3 dependency.

Purpose: Complete the migration from external robfig/cron/v3 to internal cronx package, removing the external dependency while maintaining full API compatibility.

Output:
- cron/scheduler.go updated to use internal cronx package
- cron/logger.go deleted (cronx uses slog directly)
- go.mod without robfig/cron/v3
- All tests passing
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-cron-package/34-01-SUMMARY.md
@.planning/phases/34-cron-package/34-02-SUMMARY.md

Current files to modify:
@cron/scheduler.go
@cron/logger.go
@cron/wrapper.go
@go.mod

cronx package (from Plans 01-02):
@cronx/cron.go
@cronx/chain.go
@cronx/option.go
@cronx/parser.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update cron/scheduler.go to use internal cronx package</name>
  <files>
    - cron/scheduler.go
    - cron/wrapper.go
  </files>
  <action>
Migrate cron/scheduler.go from robfig/cron/v3 to internal cronx:

1. **cron/scheduler.go** - Update imports and types:

   Change imports:
   ```go
   // Old
   import (
       "github.com/robfig/cron/v3"
   )

   // New
   import (
       "github.com/petabytecl/gaz/cronx"
   )
   ```

   Update Scheduler struct:
   ```go
   type Scheduler struct {
       cron     *cronx.Cron  // was *cron.Cron
       logger   *slog.Logger
       resolver Resolver
       appCtx   context.Context
       mu      sync.Mutex
       jobs    []*diJobWrapper
       running bool
   }
   ```

   Update NewScheduler:
   ```go
   func NewScheduler(resolver Resolver, appCtx context.Context, logger *slog.Logger) *Scheduler {
       // cronx uses slog directly, no adapter needed
       c := cronx.New(
           cronx.WithLogger(logger),
           cronx.WithChain(cronx.SkipIfStillRunning(logger)),
       )
       return &Scheduler{
           cron:     c,
           logger:   logger.With("component", "cron.Scheduler"),
           resolver: resolver,
           appCtx:   appCtx,
           jobs:     make([]*diJobWrapper, 0),
       }
   }
   ```

   RegisterJob stays mostly the same:
   ```go
   func (s *Scheduler) RegisterJob(serviceName, jobName, schedule string, timeout time.Duration) error {
       // ... validation ...
       
       // Create DI-aware job wrapper (unchanged)
       wrapper := NewJobWrapper(...)
       
       // Register with cronx (same API)
       _, err := s.cron.AddJob(schedule, wrapper)
       // ...
   }
   ```

   OnStart/OnStop use same cronx API:
   - s.cron.Start() - same
   - s.cron.Stop() returns context.Context - same

2. **cron/wrapper.go** - Minimal changes:

   The diJobWrapper implements Run() which matches cronx.Job interface:
   ```go
   // cronx.Job interface
   type Job interface {
       Run()
   }
   ```

   The existing wrapper.Run() method already matches this signature - no changes needed!

   Verify wrapper still works:
   - wrapper.Run() calls runWithRecovery() which calls executeJob()
   - executeJob() resolves CronJob from container and calls job.Run(ctx)
   - This maintains the existing DI-aware, context-aware execution pattern
  </action>
  <verify>
```bash
# Package compiles
go build ./cron/...

# Scheduler tests pass
go test ./cron/... -v -run "TestScheduler"

# Check no robfig imports remain
grep -r "robfig/cron" ./cron/ && echo "ERROR: robfig import found" || echo "OK: no robfig imports"
```
  </verify>
  <done>
- cron/scheduler.go imports and uses github.com/petabytecl/gaz/cronx
- No more robfig/cron/v3 imports in cron package
- Scheduler maintains exact same public API
- All scheduler tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove cron/logger.go and robfig/cron/v3 dependency</name>
  <files>
    - cron/logger.go (delete)
    - go.mod
    - go.sum
  </files>
  <action>
Complete the dependency removal:

1. **Delete cron/logger.go**:
   ```bash
   rm cron/logger.go
   ```

   This file contained slogAdapter which adapted slog.Logger to cron.Logger interface.
   It's no longer needed because cronx uses *slog.Logger directly.

   Also delete the test if it exists:
   ```bash
   rm -f cron/logger_test.go
   ```

2. **Update go.mod**:
   ```bash
   # Remove the robfig/cron/v3 dependency
   go mod edit -droprequire github.com/robfig/cron/v3

   # Tidy to clean up
   go mod tidy
   ```

   Verify go.mod no longer contains:
   ```
   github.com/robfig/cron/v3 v3.0.1
   ```

3. **Run full test suite**:
   ```bash
   # All cron tests
   go test ./cron/... -v

   # All cronx tests
   go test ./cronx/... -v

   # Full project
   go test ./... -v

   # Race detection
   go test ./cron/... -race
   go test ./cronx/... -race
   ```

4. **Verify dependency removal**:
   ```bash
   # Should not find robfig/cron
   go list -m all | grep robfig && echo "ERROR: robfig still present" || echo "OK: robfig removed"
   ```
  </action>
  <verify>
```bash
# Verify logger.go is deleted
test ! -f cron/logger.go && echo "OK: logger.go deleted" || echo "ERROR: logger.go still exists"

# Verify robfig removed from go.mod
grep "robfig/cron" go.mod && echo "ERROR: robfig in go.mod" || echo "OK: robfig removed"

# Full test suite
go test ./... -v

# Race detection on cron packages
go test ./cron/... -race
go test ./cronx/... -race
```
  </verify>
  <done>
- cron/logger.go deleted (no longer needed)
- robfig/cron/v3 removed from go.mod
- All project tests pass
- No race conditions detected
- Phase 34 (Cron Package) complete
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

```bash
# Verify no robfig imports anywhere
grep -r "robfig" . --include="*.go" && echo "ERROR" || echo "OK: no robfig"

# Verify no robfig in go.mod
cat go.mod | grep robfig && echo "ERROR" || echo "OK"

# Full test suite with coverage
go test ./... -v -cover

# Count dependencies (should be one less)
go list -m all | wc -l

# Verify cron package uses cronx
grep -l "petabytecl/gaz/cronx" cron/*.go
```
</verification>

<success_criteria>
- [ ] cron/scheduler.go uses internal cronx package
- [ ] cron/logger.go is deleted
- [ ] robfig/cron/v3 removed from go.mod (CRN-12)
- [ ] All existing cron tests pass (100% compatibility)
- [ ] All cronx tests pass
- [ ] Full project test suite passes
- [ ] No race conditions
- [ ] Scheduler maintains same public API
- [ ] Phase 34 complete: internal cron implementation replaces robfig/cron/v3
</success_criteria>

<output>
After completion, create `.planning/phases/34-cron-package/34-03-SUMMARY.md`
</output>
