---
phase: 34-cron-package
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cronx/doc.go
  - cronx/spec.go
  - cronx/spec_test.go
  - cronx/constantdelay.go
  - cronx/constantdelay_test.go
  - cronx/parser.go
  - cronx/parser_test.go
autonomous: true

must_haves:
  truths:
    - "Parser can parse standard 5-field cron expressions (minute hour dom month dow)"
    - "Parser can parse descriptors (@daily, @hourly, @weekly, @monthly, @yearly, @annually, @every)"
    - "Parser supports CRON_TZ= prefix for timezone-specific schedules"
    - "SpecSchedule.Next() calculates next activation time correctly"
    - "SpecSchedule handles DST transitions (spring forward skips, fall back runs once)"
    - "ConstantDelaySchedule supports @every duration expressions"
  artifacts:
    - path: "cronx/doc.go"
      provides: "Package documentation"
      min_lines: 10
    - path: "cronx/spec.go"
      provides: "SpecSchedule with Next() method and DST handling"
      exports: ["SpecSchedule", "bounds", "seconds", "minutes", "hours", "dom", "months", "dow"]
    - path: "cronx/constantdelay.go"
      provides: "ConstantDelaySchedule for @every support"
      exports: ["ConstantDelaySchedule", "Every"]
    - path: "cronx/parser.go"
      provides: "Parser with 5-field parsing and descriptor support"
      exports: ["Parser", "NewParser", "ParseOption", "ParseStandard", "Schedule", "ScheduleParser"]
  key_links:
    - from: "cronx/parser.go"
      to: "cronx/spec.go"
      via: "Parser returns SpecSchedule"
      pattern: "\\*SpecSchedule"
    - from: "cronx/parser.go"
      to: "cronx/constantdelay.go"
      via: "parseDescriptor returns ConstantDelaySchedule for @every"
      pattern: "Every\\("
---

<objective>
Create the core cronx package with schedule types and cron expression parser.

Purpose: Build the foundation for the internal cron scheduler - schedule types that calculate next activation times and a parser that converts cron expressions to schedules.

Output:
- cronx/doc.go - Package documentation
- cronx/spec.go - SpecSchedule with Next() method, DST handling, bounds definitions
- cronx/constantdelay.go - ConstantDelaySchedule for @every expressions
- cronx/parser.go - Parser with 5-field cron parsing and descriptor support
- Comprehensive tests for all schedule types and parser
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference implementation to adapt:
@_tmp_trust/cronx/spec.go
@_tmp_trust/cronx/constantdelay.go
@_tmp_trust/cronx/parser.go
@_tmp_trust/cronx/spec_test.go
@_tmp_trust/cronx/constantdelay_test.go
@_tmp_trust/cronx/parser_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cronx package with spec and constantdelay types</name>
  <files>
    - cronx/doc.go
    - cronx/spec.go
    - cronx/spec_test.go
    - cronx/constantdelay.go
    - cronx/constantdelay_test.go
  </files>
  <action>
Create the cronx package directory and implement schedule types:

1. **cronx/doc.go** - Package documentation:
   - Document purpose: internal cron expression parsing and schedule calculation
   - Mention it replaces robfig/cron/v3 with minimal API surface
   - Note DST handling and CRON_TZ support

2. **cronx/spec.go** - Adapt from reference `_tmp_trust/cronx/spec.go`:
   - Copy SpecSchedule struct (Second, Minute, Hour, Dom, Month, Dow, Location fields)
   - Copy bounds struct and all bound constants (seconds, minutes, hours, dom, months, dow)
   - Copy starBit constant
   - Copy Next() method with DST handling logic (spring forward/fall back)
   - Copy dayMatches() helper
   - NO external dependencies - pure Go time package only

3. **cronx/constantdelay.go** - Adapt from reference `_tmp_trust/cronx/constantdelay.go`:
   - Copy ConstantDelaySchedule struct
   - Copy Every() function (rounds to second, min 1 second)
   - Copy Next() method

4. **cronx/spec_test.go** - Adapt from reference tests:
   - Test Next() with various schedules
   - Test DST transitions (if practical - may need specific timezone)
   - Test edge cases (year boundaries, month boundaries)

5. **cronx/constantdelay_test.go** - Adapt from reference tests:
   - Test Every() with various durations
   - Test sub-second rounding
   - Test Next() calculation

Key adaptations from reference:
- Remove `dev.azure.com/SovosGvatLatam/Trust-Services/_git/xgo-lib.git/logx` dependency
- Use pure Go standard library only
- Keep exact same algorithm and DST handling logic
  </action>
  <verify>
```bash
# Package compiles
go build ./cronx/...

# Tests pass
go test ./cronx/... -v -run "TestSpec|TestConstant|TestEvery"
```
  </verify>
  <done>
- cronx/spec.go exports SpecSchedule with working Next() method
- cronx/constantdelay.go exports Every() and ConstantDelaySchedule
- Tests verify schedule calculation correctness
- No external dependencies (only Go stdlib)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cron expression parser with descriptor support</name>
  <files>
    - cronx/parser.go
    - cronx/parser_test.go
  </files>
  <action>
Implement the cron expression parser:

1. **cronx/parser.go** - Adapt from reference `_tmp_trust/cronx/parser.go`:
   - Copy ParseOption type and constants (Second, SecondOptional, Minute, Hour, Dom, Month, Dow, DowOptional, Descriptor)
   - Copy Parser struct and NewParser constructor
   - Copy Parser.Parse() method with:
     - CRON_TZ= prefix extraction
     - TZ= prefix extraction
     - Descriptor handling (@yearly, @annually, @monthly, @weekly, @daily, @midnight, @hourly, @every)
     - Field normalization and parsing
   - Copy standardParser (Minute | Hour | Dom | Month | Dow | Descriptor)
   - Copy ParseStandard() convenience function
   - Copy helper functions: normalizeFields, getField, getRange, parseIntOrName, mustParseInt, getBits, all, parseDescriptor
   - Define Schedule and ScheduleParser interfaces in this file

2. **cronx/parser_test.go** - Adapt from reference tests:
   - Test getRange() with various range expressions
   - Test getField() with comma-separated values
   - Test all() for bounds
   - Test ParseStandard() with standard 5-field expressions
   - Test descriptors: @yearly, @annually, @monthly, @weekly, @daily, @midnight, @hourly
   - Test @every with various durations
   - Test CRON_TZ= prefix parsing
   - Test error cases (invalid expressions, out of bounds)

Key interfaces to define:
```go
// Schedule describes a job's duty cycle.
type Schedule interface {
    Next(time.Time) time.Time
}

// ScheduleParser is an interface for schedule spec parsers
type ScheduleParser interface {
    Parse(spec string) (Schedule, error)
}
```
  </action>
  <verify>
```bash
# Package compiles
go build ./cronx/...

# All parser tests pass
go test ./cronx/... -v

# Verify specific parsing
go test ./cronx/... -v -run "TestParse|TestRange|TestField|TestDescriptor"
```
  </verify>
  <done>
- cronx/parser.go exports Parser, NewParser, ParseStandard, Schedule, ScheduleParser
- Standard 5-field expressions parse correctly
- All descriptors work (@daily, @hourly, @weekly, @monthly, @yearly, @annually, @every)
- CRON_TZ= prefix support works
- Error handling for invalid expressions
- All tests pass
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

```bash
# Full package test with coverage
go test ./cronx/... -v -cover

# Verify no external dependencies
go list -m all | grep -v "github.com/petabytecl/gaz" | grep -v "^$" | wc -l
# Should show same count as before (no new deps)

# Quick integration check - parser creates schedule, schedule calculates next
go test ./cronx/... -v -run "TestParse"
```
</verification>

<success_criteria>
- [ ] cronx/doc.go exists with package documentation
- [ ] cronx/spec.go exports SpecSchedule with Next() method
- [ ] cronx/constantdelay.go exports Every() and ConstantDelaySchedule
- [ ] cronx/parser.go exports Parser, NewParser, ParseStandard, Schedule, ScheduleParser
- [ ] 5-field cron expressions parse correctly (minute hour dom month dow)
- [ ] All descriptors work (@daily, @hourly, @weekly, @monthly, @yearly, @annually, @every)
- [ ] CRON_TZ= prefix support works
- [ ] DST transitions handled correctly in SpecSchedule.Next()
- [ ] All tests pass
- [ ] No new external dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/34-cron-package/34-01-SUMMARY.md`
</output>
