---
phase: 26-module-service-consolidation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - worker/module.go
  - cron/module.go
  - eventbus/module.go
  - config/module.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "worker.NewModule() returns di.Module"
    - "cron.NewModule() returns di.Module"
    - "eventbus.NewModule() returns di.Module"
    - "config.NewModule() returns di.Module"
    - "All four modules follow health.NewModule() pattern"
  artifacts:
    - path: "worker/module.go"
      provides: "di.Module-returning NewModule"
      contains: "di.NewModuleFunc"
    - path: "cron/module.go"
      provides: "di.Module-returning NewModule"
      contains: "di.NewModuleFunc"
    - path: "eventbus/module.go"
      provides: "di.Module-returning NewModule"
      contains: "di.NewModuleFunc"
    - path: "config/module.go"
      provides: "di.Module-returning NewModule"
      contains: "di.NewModuleFunc"
  key_links:
    - from: "worker/module.go"
      to: "di.NewModuleFunc"
      via: "return statement"
      pattern: "return di\\.NewModuleFunc"
    - from: "cron/module.go"
      to: "di.NewModuleFunc"
      via: "return statement"
      pattern: "return di\\.NewModuleFunc"
    - from: "eventbus/module.go"
      to: "di.NewModuleFunc"
      via: "return statement"
      pattern: "return di\\.NewModuleFunc"
    - from: "config/module.go"
      to: "di.NewModuleFunc"
      via: "return statement"
      pattern: "return di\\.NewModuleFunc"
---

<objective>
Fix 4 subsystem modules to return di.Module instead of func(*di.Container) error

**Gap Source:** 26-VERIFICATION.md — MOD-03 requirement not fully met
**Issue:** worker, cron, eventbus, config return wrong type
**Fix:** Wrap registration functions with di.NewModuleFunc() like health.NewModule() does

Purpose: Achieve API consistency with health.NewModule() and enable app.UseDI() usage
Output: All 5 subsystem packages export NewModule() → di.Module
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
**Reference Pattern (health/module.go:71-91):**
```go
func NewModule(opts ...ModuleOption) di.Module {
    cfg := defaultModuleConfig()
    for _, opt := range opts {
        opt(cfg)
    }

    return di.NewModuleFunc("health", func(c *di.Container) error {
        // registration logic
        return nil
    })
}
```

**Gap from VERIFICATION.md:**
- worker.NewModule() returns `func(*di.Container) error` (line 36)
- cron.NewModule() returns `func(*di.Container) error` (line 36)
- eventbus.NewModule() returns `func(*di.Container) error` (line 35)
- config.NewModule() returns `func(*di.Container) error` (line 31)

All four need to:
1. Change return type from `func(*di.Container) error` to `di.Module`
2. Wrap existing registration function with `di.NewModuleFunc("name", fn)`
3. Update doc comments to reflect new return type
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix worker.NewModule() return type</name>
  <files>worker/module.go</files>
  <action>
Update worker.NewModule() to return di.Module:

1. Change function signature from:
   `func NewModule(opts ...ModuleOption) func(*di.Container) error`
   to:
   `func NewModule(opts ...ModuleOption) di.Module`

2. Update doc comment to say "Returns a di.Module" instead of "Returns a function"

3. Update example in doc from:
   `app.Module("worker", worker.NewModule())`
   to:
   `app.UseDI(worker.NewModule())`

4. Wrap the return with di.NewModuleFunc:
   ```go
   return di.NewModuleFunc("worker", func(c *di.Container) error {
       // existing validation logic
       return nil
   })
   ```

The internal logic stays identical - only the wrapping changes.
  </action>
  <verify>
```bash
grep -n "func NewModule.*di.Module" worker/module.go
grep -n "di.NewModuleFunc" worker/module.go
go build ./worker/...
```
  </verify>
  <done>
worker.NewModule() signature is `func NewModule(opts ...ModuleOption) di.Module` and uses di.NewModuleFunc
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix cron.NewModule() return type</name>
  <files>cron/module.go</files>
  <action>
Update cron.NewModule() to return di.Module:

1. Change function signature from:
   `func NewModule(opts ...ModuleOption) func(*di.Container) error`
   to:
   `func NewModule(opts ...ModuleOption) di.Module`

2. Update doc comment to say "Returns a di.Module" instead of "Returns a function"

3. Update example in doc from:
   `app.Module("cron", cron.NewModule())`
   to:
   `app.UseDI(cron.NewModule())`

4. Wrap the return with di.NewModuleFunc:
   ```go
   return di.NewModuleFunc("cron", func(c *di.Container) error {
       // existing validation logic
       return nil
   })
   ```
  </action>
  <verify>
```bash
grep -n "func NewModule.*di.Module" cron/module.go
grep -n "di.NewModuleFunc" cron/module.go
go build ./cron/...
```
  </verify>
  <done>
cron.NewModule() signature is `func NewModule(opts ...ModuleOption) di.Module` and uses di.NewModuleFunc
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix eventbus.NewModule() return type</name>
  <files>eventbus/module.go</files>
  <action>
Update eventbus.NewModule() to return di.Module:

1. Change function signature from:
   `func NewModule(opts ...ModuleOption) func(*di.Container) error`
   to:
   `func NewModule(opts ...ModuleOption) di.Module`

2. Update doc comment to say "Returns a di.Module" instead of "Returns a function"

3. Update example in doc from:
   `app.Module("eventbus", eventbus.NewModule())`
   to:
   `app.UseDI(eventbus.NewModule())`

4. Wrap the return with di.NewModuleFunc:
   ```go
   return di.NewModuleFunc("eventbus", func(c *di.Container) error {
       // existing validation logic
       return nil
   })
   ```
  </action>
  <verify>
```bash
grep -n "func NewModule.*di.Module" eventbus/module.go
grep -n "di.NewModuleFunc" eventbus/module.go
go build ./eventbus/...
```
  </verify>
  <done>
eventbus.NewModule() signature is `func NewModule(opts ...ModuleOption) di.Module` and uses di.NewModuleFunc
  </done>
</task>

<task type="auto">
  <name>Task 4: Fix config.NewModule() return type</name>
  <files>config/module.go</files>
  <action>
Update config.NewModule() to return di.Module:

1. Change function signature from:
   `func NewModule(opts ...ModuleOption) func(*di.Container) error`
   to:
   `func NewModule(opts ...ModuleOption) di.Module`

2. Update doc comment to say "Returns a di.Module" instead of "Returns a function"

3. Update example in doc from:
   `app.Module("config", config.NewModule())`
   to:
   `app.UseDI(config.NewModule())`

4. Wrap the return with di.NewModuleFunc:
   ```go
   return di.NewModuleFunc("config", func(c *di.Container) error {
       // existing placeholder logic
       return nil
   })
   ```
  </action>
  <verify>
```bash
grep -n "func NewModule.*di.Module" config/module.go
grep -n "di.NewModuleFunc" config/module.go
go build ./config/...
```
  </verify>
  <done>
config.NewModule() signature is `func NewModule(opts ...ModuleOption) di.Module` and uses di.NewModuleFunc
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Verify all 4 modules return di.Module
for pkg in worker cron eventbus config; do
  grep -q "func NewModule.*di.Module" $pkg/module.go && echo "$pkg: OK" || echo "$pkg: FAILED"
done

# Verify all use di.NewModuleFunc
for pkg in worker cron eventbus config; do
  grep -q "di.NewModuleFunc" $pkg/module.go && echo "$pkg: OK" || echo "$pkg: FAILED"
done

# Full build + test
go build ./...
go test ./worker/... ./cron/... ./eventbus/... ./config/...
```
</verification>

<success_criteria>
1. All 4 modules (worker, cron, eventbus, config) return di.Module
2. All use di.NewModuleFunc() pattern matching health.NewModule()
3. go build ./... passes
4. go test ./... passes (existing tests should continue to work)
5. MOD-03 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/26-module-service-consolidation/26-06-SUMMARY.md`
</output>
