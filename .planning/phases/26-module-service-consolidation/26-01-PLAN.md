---
phase: 26-module-service-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.go
  - service/builder.go
  - service/builder_test.go
  - service/doc.go
autonomous: true

must_haves:
  truths:
    - "gaz.App.Build() auto-registers health module when config implements HealthConfigProvider"
    - "gaz/service package import path no longer exists"
    - "All tests pass after service package removal"
  artifacts:
    - path: "app.go"
      provides: "HealthConfigProvider auto-registration logic"
      contains: "HealthConfigProvider"
    - path: "service/"
      provides: "Deleted directory"
      exists: false
  key_links:
    - from: "app.go"
      to: "health.HealthConfigProvider"
      via: "type assertion in Build()"
      pattern: "HealthConfigProvider"
---

<objective>
Migrate service.Builder functionality into gaz.App and remove the service package entirely.

Purpose: The service package duplicates functionality already available in gaz.App. Removing it simplifies the API surface and aligns with v3 patterns where gaz.App is the single entry point.

Output: Updated app.go with HealthConfigProvider auto-registration, deleted service/ directory
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-module-service-consolidation/26-CONTEXT.md
@.planning/phases/26-module-service-consolidation/26-RESEARCH.md

@app.go
@service/builder.go
@health/config_provider.go
@health/module.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HealthConfigProvider auto-registration to gaz.App.Build()</name>
  <files>app.go</files>
  <action>
Add HealthConfigProvider auto-registration logic to gaz.App.Build(), matching what service.Builder.Build() does:

1. Add import for `github.com/petabytecl/gaz/health` if not present

2. In Build() method, after loadConfig() call and before container.Build(), add:
```go
// Auto-register health module if config implements HealthConfigProvider
// and health module is not already registered
if a.configTarget != nil {
    if hp, ok := a.configTarget.(health.HealthConfigProvider); ok {
        // Only auto-register if health module not already applied
        if !a.modules["health"] {
            cfg := hp.HealthConfig()

            // Register health.Config in container
            if err := For[health.Config](a.container).Instance(cfg); err != nil {
                errs = append(errs, fmt.Errorf("register health config: %w", err))
            } else {
                // Create and apply health module
                healthModule := NewModule("health").
                    Provide(health.Module).
                    Build()
                if err := healthModule.Apply(a); err != nil {
                    errs = append(errs, fmt.Errorf("apply health module: %w", err))
                } else {
                    a.modules["health"] = true
                }
            }
        }
    }
}
```

3. This logic must run BEFORE the `// Discover workers from registered services` section but AFTER `collectProviderConfigs()`.

Key behaviors to preserve:
- Only triggers if configTarget implements health.HealthConfigProvider
- Only triggers if health module not already registered via Use()
- Registers health.Config first, then applies health.Module
  </action>
  <verify>
Run: `go build ./...` — compiles successfully
Run: `go test ./... -run HealthConfig -count=1` — health config provider tests pass
  </verify>
  <done>
gaz.App.Build() auto-registers health module when config implements HealthConfigProvider, matching previous service.Builder behavior
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove service package entirely</name>
  <files>service/builder.go, service/builder_test.go, service/doc.go</files>
  <action>
Remove the service package completely:

1. Delete the entire service/ directory:
   - `rm -rf service/`

2. Verify no internal imports of service package:
   - Run: `grep -r "gaz/service" --include="*.go" .`
   - Should return no results (or only in _tmp/ which is excluded)

3. If any imports found in main codebase (not _tmp/), update them:
   - Replace `service.New()...Build()` pattern with `gaz.New()...Build()`
   - Per CONTEXT.md migration pattern:
     - `WithCmd(cmd)` → `WithCobra(cmd)`
     - `WithEnvPrefix("X")` → use `config.WithEnvPrefix("X")` in `WithConfig()`

This is a clean break for v3 — no deprecation period needed.
  </action>
  <verify>
Run: `ls service/` — should fail with "No such file or directory"
Run: `grep -r "gaz/service" --include="*.go" . | grep -v "_tmp/"` — returns empty
Run: `go build ./...` — compiles successfully
Run: `go test ./... -count=1` — all tests pass
  </verify>
  <done>
service/ directory is deleted, no internal code imports it, all tests pass
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — all packages compile
2. `go test ./... -count=1` — all tests pass
3. `ls service/` — directory does not exist
4. Health auto-registration works: create app with HealthConfigProvider, verify health module applies
</verification>

<success_criteria>
- [ ] app.go contains HealthConfigProvider check in Build()
- [ ] service/ directory is deleted
- [ ] All tests pass with no service package references
- [ ] MOD-01 complete: service.Builder absorbed into gaz.App
- [ ] MOD-02 complete: gaz/service package removed
</success_criteria>

<output>
After completion, create `.planning/phases/26-module-service-consolidation/26-01-SUMMARY.md`
</output>
