---
phase: 24-lifecycle-interface
plan: 03
type: execute
wave: 2
depends_on: ["24-01", "24-02"]
files_modified:
  - cron/scheduler.go
  - cron/scheduler_test.go
  - examples/system-info-cli/worker.go
  - app_worker_test.go
autonomous: true

must_haves:
  truths:
    - "cron.Scheduler implements worker.Worker with OnStart/OnStop signatures"
    - "Example worker implementations use OnStart/OnStop signatures"
    - "All cron tests pass with new worker interface"
    - "App worker integration tests pass"
  artifacts:
    - path: "cron/scheduler.go"
      provides: "Scheduler implementing new Worker interface"
      contains: "OnStart(ctx context.Context) error"
    - path: "examples/system-info-cli/worker.go"
      provides: "Example worker with new interface"
      contains: "OnStart(ctx context.Context) error"
  key_links:
    - from: "cron/scheduler.go"
      to: "worker.Worker"
      via: "interface implementation"
      pattern: "func \\(s \\*Scheduler\\) OnStart"
---

<objective>
Update cron.Scheduler and example workers to use new worker.Worker interface

Purpose: Align all Worker implementations with the new OnStart(ctx)/OnStop(ctx) error interface. This completes the worker interface migration across the codebase.

Output: All Worker implementations migrated, tests passing
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-lifecycle-interface/24-CONTEXT.md

@.planning/phases/24-lifecycle-interface/24-01-SUMMARY.md
@cron/scheduler.go
@examples/system-info-cli/worker.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate cron.Scheduler to New Worker Interface</name>
  <files>cron/scheduler.go, cron/scheduler_test.go</files>
  <action>
    Update cron.Scheduler to implement new worker.Worker interface:

    **In cron/scheduler.go:**
    1. Change `func (s *Scheduler) Start()` to:
       ```go
       func (s *Scheduler) OnStart(ctx context.Context) error
       ```
       - Keep existing logic
       - Store ctx if needed for job context propagation
       - Return nil at end (scheduler start doesn't fail)

    2. Change `func (s *Scheduler) Stop()` to:
       ```go
       func (s *Scheduler) OnStop(ctx context.Context) error
       ```
       - Keep existing logic (waits for running jobs)
       - Use ctx for shutdown deadline if needed (optional enhancement)
       - Return nil at end

    3. Update doc comments to reflect new signatures

    **In cron/scheduler_test.go:**
    1. Update all `scheduler.Start()` calls to `scheduler.OnStart(ctx)` with appropriate context
    2. Update all `scheduler.Stop()` calls to `scheduler.OnStop(ctx)` with appropriate context
    3. Add error checking where appropriate (though start/stop typically return nil)

    Note: The Scheduler already has `appCtx` stored, so OnStart doesn't need to store the ctx separately unless we want to use it for something.
  </action>
  <verify>
    `go test ./cron/... -v` passes all tests
    `grep -n "func.*Scheduler.*OnStart\|func.*Scheduler.*OnStop" cron/scheduler.go` shows new signatures
  </verify>
  <done>
    cron.Scheduler implements worker.Worker with OnStart(ctx)/OnStop(ctx) error, tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Example Workers</name>
  <files>examples/system-info-cli/worker.go</files>
  <action>
    Update the RefreshWorker example to use new interface:

    1. Change `func (w *RefreshWorker) Start()` to:
       ```go
       func (w *RefreshWorker) OnStart(ctx context.Context) error
       ```
       - Add `import "context"` if not present
       - Keep existing goroutine-spawning logic
       - Return nil at end

    2. Change `func (w *RefreshWorker) Stop()` to:
       ```go
       func (w *RefreshWorker) OnStop(ctx context.Context) error
       ```
       - Keep existing logic (close done, wait for wg)
       - Return nil at end

    3. Update doc comments to reflect new signatures
  </action>
  <verify>
    `go build ./examples/system-info-cli/...` compiles successfully
    `grep -n "OnStart\|OnStop" examples/system-info-cli/worker.go` shows new method names
  </verify>
  <done>
    Example worker uses OnStart(ctx)/OnStop(ctx) error signatures
  </done>
</task>

<task type="auto">
  <name>Task 3: Update App-Level Worker Tests</name>
  <files>app_worker_test.go</files>
  <action>
    Update app worker integration tests to use new interface:

    1. Find any test worker types in app_worker_test.go that implement worker.Worker
    2. Change `Start()` methods to `OnStart(ctx context.Context) error`
    3. Change `Stop()` methods to `OnStop(ctx context.Context) error`
    4. Update any direct calls to `worker.Start()`/`worker.Stop()` if present

    Also check for fluent hook usage (OnStart/OnStop on registration builder):
    - Lines ~146, ~211 use `.OnStart()` / `.OnStop()` on registration builder
    - These need to be converted to interface-based approach:
      - Create wrapper types that implement di.Starter/di.Stopper
      - Or modify the test service types to implement the interfaces directly

    The test types should implement di.Starter and/or di.Stopper interfaces instead of using fluent hooks.
  </action>
  <verify>
    `go test ./... -run "Worker" -v` passes worker-related tests
    `grep -n "\.OnStart\|\.OnStop" app_worker_test.go` shows no fluent hook usage on builders
  </verify>
  <done>
    App worker tests use new worker interface and interface-based lifecycle (no fluent hooks)
  </done>
</task>

</tasks>

<verification>
Run all affected tests:
```bash
go test ./cron/... -v -count=1
go test ./... -run "Worker" -v -count=1
go build ./examples/...
```

Verify no old interface methods remain:
```bash
grep -rn "func.*Start\(\)" cron/scheduler.go examples/system-info-cli/worker.go | grep -v OnStart
grep -rn "func.*Stop\(\)" cron/scheduler.go examples/system-info-cli/worker.go | grep -v OnStop
```
Should return no matches.
</verification>

<success_criteria>
1. cron.Scheduler has OnStart(ctx) error and OnStop(ctx) error methods
2. Example RefreshWorker has OnStart(ctx) error and OnStop(ctx) error methods
3. All cron package tests pass
4. App worker integration tests pass
5. No old Start()/Stop() signatures remain in these files
</success_criteria>

<output>
After completion, create `.planning/phases/24-lifecycle-interface/24-03-SUMMARY.md`
</output>
