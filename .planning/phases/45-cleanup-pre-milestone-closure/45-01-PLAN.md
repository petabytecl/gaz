---
phase: 45-cleanup-pre-milestone-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - di/lifecycle_engine.go
  - di/lifecycle_engine_test.go
  - lifecycle.go
autonomous: true

must_haves:
  truths:
    - "No dead code exists in di/ package"
    - "Lifecycle types have a single source of truth"
    - "All tests pass after cleanup"
    - "Linter passes with no issues"
  artifacts:
    - path: "di/lifecycle.go"
      provides: "Canonical Starter, Stopper, HookFunc, HookConfig, HookOption types"
    - path: "lifecycle.go"
      provides: "Type aliases to di package types"
      contains: "type Starter = di.Starter"
  key_links:
    - from: "lifecycle.go"
      to: "di/lifecycle.go"
      via: "type alias"
      pattern: "type Starter = di\\.Starter"
    - from: "di/service.go"
      to: "di/lifecycle.go"
      via: "Starter/Stopper type assertions"
      pattern: "instance\\.\\(Starter\\)"
---

<objective>
Remove dead code and consolidate duplicate lifecycle type definitions to improve codebase quality before milestone closure.

Purpose: The `di/lifecycle_engine.go` file contains ~110 lines of dead code (never called), and lifecycle types are duplicated between root `lifecycle.go` and `di/lifecycle.go`. This cleanup eliminates tech debt before closing the v4.4 milestone.

Output: Cleaner codebase with single source of truth for lifecycle types and no unused code in di/ package.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@CLEANUP-PHASE.md

# Key files to understand
@di/lifecycle_engine.go
@di/lifecycle.go
@lifecycle.go
@lifecycle_engine.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete dead lifecycle_engine.go from di package</name>
  <files>di/lifecycle_engine.go, di/lifecycle_engine_test.go</files>
  <action>
Delete the following files which contain dead code (never called from anywhere):

1. `di/lifecycle_engine.go` - Contains `ComputeStartupOrder` and `ComputeShutdownOrder` functions that are duplicated in root `lifecycle_engine.go`. The root versions are the ones actually used by `app.go` and `cobra.go`.

2. `di/lifecycle_engine_test.go` - Tests for the dead code above.

Evidence of dead code:
- `grep -rn "di\.ComputeStartupOrder\|di\.ComputeShutdownOrder" .` returns no matches outside the di package itself
- The root package `lifecycle_engine.go` has identical functions that ARE used

Use `rm` to delete both files.
  </action>
  <verify>
1. `go build ./...` passes
2. `go test ./...` passes
3. `ls di/lifecycle_engine*.go` shows "No such file"
  </verify>
  <done>di/lifecycle_engine.go and di/lifecycle_engine_test.go are deleted, build and tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Consolidate lifecycle types via aliases</name>
  <files>lifecycle.go</files>
  <action>
Refactor root `lifecycle.go` to use type aliases from `di/lifecycle.go` instead of duplicate definitions.

Replace the entire file content with:

```go
package gaz

import (
	"github.com/petabytecl/gaz/di"
)

// HookFunc is a function that performs a lifecycle action.
type HookFunc = di.HookFunc

// HookConfig holds configuration for lifecycle hooks.
type HookConfig = di.HookConfig

// HookOption configures a lifecycle hook.
type HookOption = di.HookOption

// WithHookTimeout sets a custom timeout for this specific hook.
// If not set, the hook uses the App's default PerHookTimeout.
var WithHookTimeout = di.WithHookTimeout

// Starter is an interface for services that need to perform action on startup.
// Implementing this interface is the sole mechanism for lifecycle participation.
// OnStart is called automatically after container Build() when the service is
// first instantiated. Hooks are called in dependency order: dependencies start first.
//
// This interface is auto-detected by the DI container. No registration of lifecycle
// hooks is needed - simply implement the interface.
type Starter = di.Starter

// Stopper is an interface for services that need to perform action on shutdown.
// Implementing this interface is the sole mechanism for lifecycle participation.
// OnStop is called automatically during graceful shutdown. Hooks are called in
// reverse dependency order: dependents stop first, then their dependencies.
//
// This interface is auto-detected by the DI container. No registration of lifecycle
// hooks is needed - simply implement the interface.
type Stopper = di.Stopper
```

This:
- Makes `di.Starter` and `di.Stopper` the single source of truth
- Exports them as `gaz.Starter` and `gaz.Stopper` via type aliases
- Removes ~20 lines of duplicate code while preserving the public API
- Keeps all documentation on the aliases for godoc
  </action>
  <verify>
1. `go build ./...` passes
2. `go test ./...` passes  
3. `make lint` passes (0 issues)
4. `grep "type Starter = di.Starter" lifecycle.go` shows the alias
  </verify>
  <done>lifecycle.go uses type aliases to di package, single source of truth established</done>
</task>

</tasks>

<verification>
After completing all tasks, run the full verification suite:

```bash
go build ./...
go test -race ./...
make lint
make cover
```

All commands must pass. Coverage should remain >= 90%.
</verification>

<success_criteria>
1. `di/lifecycle_engine.go` and `di/lifecycle_engine_test.go` are deleted
2. `lifecycle.go` uses type aliases to `di/lifecycle.go`
3. `go build ./...` passes
4. `go test -race ./...` passes
5. `make lint` passes (0 issues)
6. `make cover` passes (>= 90% coverage)
7. No regression in functionality
</success_criteria>

<output>
After completion, create `.planning/phases/45-cleanup-pre-milestone-closure/45-01-SUMMARY.md`
</output>
