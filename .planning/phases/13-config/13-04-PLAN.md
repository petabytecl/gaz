---
phase: 13-config
plan: 04
type: execute
wave: 4
depends_on: ["13-03"]
files_modified:
  - config/manager_test.go
  - config/validation_test.go
  - config/accessor_test.go
  - config/viper/backend_test.go
autonomous: true

must_haves:
  truths:
    - "config.New() creates working Manager without gaz.App"
    - "Manager.LoadInto() validates and unmarshals correctly"
    - "Get[T]() returns typed values"
    - "ViperBackend implements all interface methods"
    - "All existing gaz tests still pass"
  artifacts:
    - path: "config/manager_test.go"
      provides: "Manager unit tests"
      min_lines: 100
    - path: "config/validation_test.go"
      provides: "Validation unit tests"
      min_lines: 50
    - path: "config/viper/backend_test.go"
      provides: "ViperBackend unit tests"
      min_lines: 50
  key_links:
    - from: "config/manager_test.go"
      to: "config/manager.go"
      via: "tests New(), LoadInto(), Backend()"
      pattern: "config\\.New|LoadInto"
---

<objective>
Create comprehensive tests for config package and verify all existing tests pass.

Purpose: Ensure the extracted config package works correctly standalone and the integration with gaz is solid.
Output: Test files for config and config/viper packages, all tests passing.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-config/13-CONTEXT.md
@.planning/phases/13-config/13-03-SUMMARY.md

# Test patterns from existing tests:
@app_test.go
@config_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config package tests</name>
  <files>config/manager_test.go, config/validation_test.go, config/accessor_test.go</files>
  <action>
1. **config/manager_test.go** - Test Manager functionality:

   Test cases for New():
   - New() returns non-nil Manager
   - New() with options applies them correctly
   - NewWithBackend() accepts custom backend
   - NewWithBackend(nil) panics

   Test cases for Load():
   - Load() with missing config file (no error - graceful)
   - Load() with valid config file
   - Load() with profile config merging
   - Load() with env prefix binds env vars
   - Load() with defaults applies them

   Test cases for LoadInto():
   - LoadInto() unmarshals into struct
   - LoadInto() calls Defaulter.Default()
   - LoadInto() validates struct tags (required, min, max)
   - LoadInto() calls Validator.Validate()
   - LoadInto() returns ValidationErrors for invalid config

   Create test fixtures:
   - testdata/config.yaml with sample config
   - Test struct types with validate tags

   Use mock backend for some tests to isolate Manager logic from viper.

2. **config/validation_test.go** - Test validation:
   - ValidateStruct with valid struct returns nil
   - ValidateStruct with missing required field returns error
   - ValidateStruct with min/max violations returns error
   - Error messages use mapstructure field names
   - humanizeTag returns correct messages for all supported tags

3. **config/accessor_test.go** - Test generic accessors:
   - Get[string] returns string value
   - Get[int] returns int value
   - Get[bool] returns bool value
   - Get[T] returns zero value for missing key
   - Get[T] returns zero value for type mismatch
   - GetOr[T] returns fallback for missing key
   - GetOr[T] returns fallback for type mismatch
   - GetOr[T] returns value when present and correct type

Use testify/assert and testify/require as per project conventions.
  </action>
  <verify>
Run: `go test ./config/... -v` - All tests pass.
Check coverage: `go test ./config/... -cover` - Aim for 70%+ coverage.
  </verify>
  <done>
config package has comprehensive tests for Manager, validation, and accessors with 70%+ coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create viper backend tests and verify all tests pass</name>
  <files>config/viper/backend_test.go</files>
  <action>
1. **config/viper/backend_test.go** - Test ViperBackend:

   Test Backend interface methods:
   - Get/Set round-trip for string, int, bool, duration, float64
   - GetString, GetInt, GetBool, GetDuration, GetFloat64
   - SetDefault applies default values
   - IsSet returns correct status
   - Unmarshal into struct works
   - UnmarshalKey for nested config

   Test Watcher interface:
   - WatchConfig() doesn't panic (can't easily test actual file watching)
   - OnConfigChange accepts callback (can't easily test actual change)

   Test Writer interface:
   - WriteConfigAs writes to temp file
   - SafeWriteConfigAs doesn't overwrite existing

   Test EnvBinder interface:
   - SetEnvPrefix sets prefix
   - BindEnv binds key to env var
   - AutomaticEnv enables auto-binding

   Test viper-specific methods:
   - SetConfigName, SetConfigType, AddConfigPath
   - ReadInConfig with valid file
   - MergeInConfig with profile file

2. **Verify all gaz tests pass**:
   - Run full test suite: `go test ./...`
   - Fix any regressions from config extraction
   - Ensure backward compatibility shims work correctly

3. **Check for coverage targets**:
   - config package: 70%+ coverage
   - config/viper package: 60%+ coverage (some methods hard to test)
   - gaz root package: maintain existing coverage

Create testdata directories:
- config/testdata/config.yaml
- config/testdata/config.local.yaml (for profile testing)
- config/viper/testdata/...
  </action>
  <verify>
Run: `go test ./... -v` - All tests pass.
Run: `go test ./config/... -cover` - Shows coverage percentages.
Run: `go test ./config/viper/... -cover` - Shows viper package coverage.
  </verify>
  <done>
All tests pass. config package has 70%+ coverage. config/viper package has 60%+ coverage. No regressions in gaz tests.
  </done>
</task>

</tasks>

<verification>
1. `go test ./...` - All tests pass
2. `go test ./config/... -cover` - 70%+ coverage
3. `go test ./config/viper/... -cover` - 60%+ coverage
4. No regressions in existing gaz tests
5. Examples compile and work correctly
</verification>

<success_criteria>
- [ ] config/manager_test.go tests New, Load, LoadInto, Backend
- [ ] config/validation_test.go tests ValidateStruct and error formatting
- [ ] config/accessor_test.go tests Get[T] and GetOr[T]
- [ ] config/viper/backend_test.go tests Backend interface implementation
- [ ] `go test ./...` passes with no failures
- [ ] config package has 70%+ test coverage
- [ ] config/viper package has 60%+ test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/13-config/13-04-SUMMARY.md`
</output>
