---
phase: 13-config
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - config/manager.go
  - config/options.go
  - config/validation.go
  - config/accessor.go
autonomous: true

must_haves:
  truths:
    - "config.New() returns Manager without requiring gaz.App"
    - "Manager.LoadInto(&cfg) loads config and unmarshals into struct"
    - "config.Get[T](mgr, key) returns typed value"
    - "Validation runs automatically during LoadInto"
  artifacts:
    - path: "config/manager.go"
      provides: "Manager struct with New(), Load(), LoadInto()"
      exports: ["Manager", "New", "NewWithBackend"]
    - path: "config/options.go"
      provides: "ConfigOption functions"
      exports: ["Option", "WithName", "WithType", "WithEnvPrefix", "WithSearchPaths", "WithProfileEnv", "WithDefaults"]
    - path: "config/validation.go"
      provides: "Struct tag validation"
      exports: ["ValidateStruct"]
    - path: "config/accessor.go"
      provides: "Generic typed accessors"
      exports: ["Get", "GetOr"]
  key_links:
    - from: "config/manager.go"
      to: "config/backend.go"
      via: "Manager uses Backend interface"
      pattern: "backend Backend"
    - from: "config/manager.go"
      to: "config/validation.go"
      via: "LoadInto calls validation"
      pattern: "ValidateStruct"
---

<objective>
Move ConfigManager, options, and validation to config package with new LoadInto() and Get[T]() features.

Purpose: Creates the standalone config management API that works without gaz.App, following the pattern established in Phase 12 for DI.
Output: Complete config package with Manager, options, validation, and generic accessors.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-config/13-CONTEXT.md
@.planning/phases/13-config/13-RESEARCH.md
@.planning/phases/13-config/13-01-SUMMARY.md

# Source files to move:
@config_manager.go
@options.go
@validation.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config/manager.go with Manager struct and constructors</name>
  <files>config/manager.go</files>
  <action>
Create config/manager.go by adapting the current config_manager.go:

1. **Manager struct** (renamed from ConfigManager):
   ```go
   type Manager struct {
       backend     Backend
       fileName    string
       fileType    string
       searchPaths []string
       envPrefix   string
       profileEnv  string
       defaults    map[string]any
   }
   ```

2. **New() constructor** - Creates Manager with default ViperBackend:
   ```go
   func New(opts ...Option) *Manager {
       m := &Manager{
           backend:     viper.New(),  // import config/viper
           fileName:    "config",
           fileType:    "yaml",
           searchPaths: []string{"."},
           defaults:    make(map[string]any),
       }
       for _, opt := range opts {
           opt(m)
       }
       return m
   }
   ```

3. **NewWithBackend() constructor** - For custom/test backends:
   ```go
   func NewWithBackend(backend Backend, opts ...Option) *Manager {
       if backend == nil {
           panic("config: backend cannot be nil")
       }
       m := &Manager{
           backend:     backend,
           fileName:    "config",
           fileType:    "yaml",
           searchPaths: []string{"."},
           defaults:    make(map[string]any),
       }
       for _, opt := range opts {
           opt(m)
       }
       return m
   }
   ```

4. **Load() method** - Loads config from files/env (no target):
   - Configure backend with file name, type, search paths
   - Apply defaults via backend.SetDefault()
   - If envPrefix set: configure env binding via EnvBinder interface (type assert)
   - Read config file (handle ConfigFileNotFoundError gracefully)
   - Load profile config if profileEnv set

5. **LoadInto(target any) error** - Combined load + unmarshal per CONTEXT.md:
   - Call Load() first
   - Unmarshal into target via backend.Unmarshal()
   - Apply Defaulter if target implements it
   - Call ValidateStruct(target) for struct tag validation
   - Call Validator.Validate() if target implements it
   - Return combined errors

6. **Backend() accessor** - Returns the underlying Backend for direct access

7. **Helper methods** moved from current ConfigManager:
   - loadProfileConfig() - internal
   - BindFlags(fs *pflag.FlagSet) error - for Cobra integration

Use type assertions to access optional interfaces:
```go
if eb, ok := m.backend.(EnvBinder); ok {
    eb.SetEnvPrefix(m.envPrefix)
    eb.AutomaticEnv()
}
```

Import config/viper for the default backend. This is acceptable because config package imports config/viper, not the other way around.
  </action>
  <verify>
Run: `go build ./config/...` - Should compile.
Check: New() returns functional Manager with viper backend.
  </verify>
  <done>
Manager struct exists with New(), NewWithBackend(), Load(), LoadInto(), Backend() methods. Manager uses Backend interface internally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create options.go and validation.go, add generic accessors</name>
  <files>config/options.go, config/validation.go, config/accessor.go</files>
  <action>
1. **config/options.go** - Move from root options.go:
   ```go
   type Option func(*Manager)
   
   func WithName(name string) Option { ... }
   func WithType(t string) Option { ... }
   func WithEnvPrefix(prefix string) Option { ... }
   func WithSearchPaths(paths ...string) Option { ... }
   func WithProfileEnv(envVar string) Option { ... }
   func WithDefaults(defaults map[string]any) Option { ... }
   ```
   
   Keep exact same behavior but reference Manager (not ConfigManager).

2. **config/validation.go** - Move from root validation.go:
   - Keep the configValidator singleton pattern (thread-safe, efficient)
   - Keep RegisterTagNameFunc for mapstructure tag priority
   - Rename validateConfigTags to ValidateStruct (exported for external use)
   - Update formatValidationErrors to use config.ErrConfigValidation (not gaz.ErrConfigValidation)
   - Keep humanizeTag function unchanged
   
   Import go-playground/validator/v10 as before.

3. **config/accessor.go** - New generic accessors per RESEARCH.md:
   ```go
   // Get retrieves a typed value from the Manager.
   // Returns zero value if key not found or type assertion fails.
   func Get[T any](m *Manager, key string) T {
       val := m.backend.Get(key)
       if val == nil {
           var zero T
           return zero
       }
       typed, ok := val.(T)
       if !ok {
           var zero T
           return zero
       }
       return typed
   }
   
   // GetOr retrieves a typed value with a fallback default.
   func GetOr[T any](m *Manager, key string, fallback T) T {
       val := m.backend.Get(key)
       if val == nil {
           return fallback
       }
       typed, ok := val.(T)
       if !ok {
           return fallback
       }
       return typed
   }
   ```

Ensure no imports from parent gaz package.
  </action>
  <verify>
Run: `go build ./config/...` - Should compile.
Verify no gaz imports: `grep -r 'github.com/petabytecl/gaz"' config/*.go` returns empty (only config/viper allowed).
  </verify>
  <done>
config package has Option functions, ValidateStruct, Get[T], GetOr[T] all working with Manager.
  </done>
</task>

</tasks>

<verification>
1. `go build ./config/...` compiles all config packages
2. No import from parent gaz package in config/*.go files
3. ValidateStruct uses config.ErrConfigValidation, not gaz.ErrConfigValidation
4. Options modify Manager fields correctly
5. Get[T] and GetOr[T] return typed values from backend
</verification>

<success_criteria>
- [ ] config/manager.go exports Manager, New, NewWithBackend
- [ ] Manager.LoadInto() loads config and validates
- [ ] config/options.go exports WithName, WithType, WithEnvPrefix, WithSearchPaths, WithProfileEnv, WithDefaults
- [ ] config/validation.go exports ValidateStruct
- [ ] config/accessor.go exports Get[T], GetOr[T]
- [ ] All code compiles without errors
- [ ] No imports from gaz root package
</success_criteria>

<output>
After completion, create `.planning/phases/13-config/13-02-SUMMARY.md`
</output>
