---
phase: 13-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/backend.go
  - config/types.go
  - config/errors.go
  - config/doc.go
  - config/viper/backend.go
  - config/viper/doc.go
autonomous: true

must_haves:
  truths:
    - "Backend interface defines Get, Set, Unmarshal operations"
    - "Watcher, Writer, EnvBinder are optional composed interfaces"
    - "ViperBackend implements all four interfaces"
    - "Defaulter and Validator interfaces exist in config package"
  artifacts:
    - path: "config/backend.go"
      provides: "Backend, Watcher, Writer, EnvBinder interfaces"
      exports: ["Backend", "Watcher", "Writer", "EnvBinder", "StringReplacer"]
    - path: "config/types.go"
      provides: "Config lifecycle interfaces"
      exports: ["Defaulter", "Validator"]
    - path: "config/errors.go"
      provides: "Config-specific sentinel errors"
      exports: ["ErrConfigValidation"]
    - path: "config/viper/backend.go"
      provides: "Viper-based Backend implementation"
      exports: ["Backend", "New"]
  key_links:
    - from: "config/viper/backend.go"
      to: "config/backend.go"
      via: "interface implementation"
      pattern: "implements config\\.Backend"
---

<objective>
Create the config package foundation with Backend interface hierarchy and ViperBackend implementation.

Purpose: Establishes the interface abstraction layer that decouples config consumers from viper, enabling standalone usage and testability.
Output: config/ and config/viper/ packages with interfaces and viper implementation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-config/13-CONTEXT.md
@.planning/phases/13-config/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config package with Backend interface and types</name>
  <files>config/backend.go, config/types.go, config/errors.go, config/doc.go</files>
  <action>
Create the config package with core interfaces:

1. **config/doc.go** - Package documentation:
   - Describe standalone config management
   - Note that viper backend is in config/viper subpackage

2. **config/backend.go** - Core Backend interface per RESEARCH.md:
   ```go
   type Backend interface {
       Get(key string) any
       GetString(key string) string
       GetInt(key string) int
       GetBool(key string) bool
       GetDuration(key string) time.Duration
       GetFloat64(key string) float64
       Set(key string, value any)
       SetDefault(key string, value any)
       IsSet(key string) bool
       Unmarshal(target any) error
       UnmarshalKey(key string, target any) error
   }
   ```
   
   Plus composed optional interfaces:
   - `Watcher` - WatchConfig(), OnConfigChange(callback func(event any))
   - `Writer` - WriteConfig(), WriteConfigAs(filename string), SafeWriteConfig(), SafeWriteConfigAs(filename string)
   - `EnvBinder` - SetEnvPrefix(prefix string), AutomaticEnv(), BindEnv(keys ...string), SetEnvKeyReplacer(replacer StringReplacer)
   - `StringReplacer` interface with Replace(s string) string

3. **config/types.go** - Move interfaces from root config.go:
   - `Defaulter` interface (Default() method)
   - `Validator` interface (Validate() error method)
   - Keep exact same signatures as current gaz package

4. **config/errors.go** - Config-specific errors:
   - `ErrConfigValidation` sentinel error with "config:" prefix (not "gaz:")
   - `ValidationErrors` struct for multiple field errors
   - `FieldError` struct with Namespace, Tag, Param, Message fields

Do NOT import anything from parent gaz package (prevents import cycles).
  </action>
  <verify>
Run: `go build ./config/...` - Should compile without errors.
Verify no gaz imports: `grep -r 'github.com/petabytecl/gaz"' config/*.go` returns empty.
  </verify>
  <done>
config package compiles standalone with Backend, Watcher, Writer, EnvBinder, Defaulter, Validator interfaces and ErrConfigValidation error.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ViperBackend in config/viper subpackage</name>
  <files>config/viper/backend.go, config/viper/doc.go</files>
  <action>
Create the viper implementation in its own subpackage to isolate the viper dependency:

1. **config/viper/doc.go** - Package documentation:
   - Explain this provides viper-based Backend implementation
   - Note it implements all optional interfaces (Watcher, Writer, EnvBinder)

2. **config/viper/backend.go** - ViperBackend struct:
   ```go
   package viper
   
   import (
       "github.com/petabytecl/gaz/config"
       "github.com/spf13/viper"
   )
   
   // Backend implements config.Backend, config.Watcher, config.Writer, and config.EnvBinder.
   type Backend struct {
       v *viper.Viper
   }
   
   // New creates a new ViperBackend.
   func New() *Backend {
       return &Backend{v: viper.New()}
   }
   ```

   Implement ALL methods from config.Backend:
   - Get, GetString, GetInt, GetBool, GetDuration, GetFloat64
   - Set, SetDefault, IsSet
   - Unmarshal, UnmarshalKey (delegate to viper methods)

   Implement config.Watcher:
   - WatchConfig() - delegates to v.WatchConfig()
   - OnConfigChange(callback func(event any)) - wraps fsnotify.Event

   Implement config.Writer:
   - WriteConfig, WriteConfigAs, SafeWriteConfig, SafeWriteConfigAs

   Implement config.EnvBinder:
   - SetEnvPrefix, AutomaticEnv, BindEnv, SetEnvKeyReplacer

   Add additional viper-specific methods needed by Manager:
   - SetConfigName(name string)
   - SetConfigType(t string)
   - AddConfigPath(path string)
   - ReadInConfig() error
   - MergeInConfig() error
   - BindPFlags(fs *pflag.FlagSet) error
   - ConfigFileNotFoundError type check helper

Add compile-time interface assertion:
```go
var (
    _ config.Backend   = (*Backend)(nil)
    _ config.Watcher   = (*Backend)(nil)
    _ config.Writer    = (*Backend)(nil)
    _ config.EnvBinder = (*Backend)(nil)
)
```
  </action>
  <verify>
Run: `go build ./config/viper/...` - Should compile without errors.
Verify interface satisfaction: Build includes compile-time assertions.
  </verify>
  <done>
config/viper.Backend implements all four config interfaces (Backend, Watcher, Writer, EnvBinder) with viper delegation.
  </done>
</task>

</tasks>

<verification>
1. `go build ./config/...` compiles both packages
2. `go build ./config/viper/...` compiles viper package
3. No import cycles: `go list -f '{{.ImportPath}} {{.Imports}}' ./config/... | grep petabytecl/gaz` shows only config -> viper, never gaz -> config
4. Interface assertions pass at compile time
</verification>

<success_criteria>
- [ ] config/backend.go exports Backend, Watcher, Writer, EnvBinder, StringReplacer interfaces
- [ ] config/types.go exports Defaulter, Validator interfaces
- [ ] config/errors.go exports ErrConfigValidation, ValidationErrors, FieldError
- [ ] config/viper/backend.go exports Backend struct implementing all interfaces
- [ ] Both packages compile without errors
- [ ] No imports from parent gaz package
</success_criteria>

<output>
After completion, create `.planning/phases/13-config/13-01-SUMMARY.md`
</output>
