---
phase: 38-transport-foundations
plan: 03
type: execute
wave: 2
depends_on: ["38-01", "38-02"]
files_modified:
  - server/doc.go
  - server/module.go
  - server/grpc/server_test.go
  - server/http/server_test.go
autonomous: true

must_haves:
  truths:
    - "Unified server module starts gRPC first, then HTTP"
    - "Unified server module shuts down HTTP first, then gRPC"
    - "gRPC reflection is queryable after startup"
    - "Both servers start and stop without errors in tests"
  artifacts:
    - path: "server/doc.go"
      provides: "Package documentation for server transport layer"
      contains: "Package server"
    - path: "server/module.go"
      provides: "Unified module combining gRPC and HTTP"
      exports: ["NewModule", "WithGRPC", "WithHTTP"]
    - path: "server/grpc/server_test.go"
      provides: "Unit tests for gRPC server lifecycle"
      contains: "func Test"
    - path: "server/http/server_test.go"
      provides: "Unit tests for HTTP server lifecycle"
      contains: "func Test"
  key_links:
    - from: "server/module.go"
      to: "server/grpc"
      via: "imports and registers grpc.Module"
      pattern: "grpc\\.Module|grpc\\.NewModule"
    - from: "server/module.go"
      to: "server/http"
      via: "imports and registers http.Module"
      pattern: "http\\.Module|http\\.NewModule"
---

<objective>
Create unified server module and comprehensive tests for transport layer.

Purpose: Integrate gRPC and HTTP servers with correct lifecycle ordering and verify everything works end-to-end.
Output: Unified server module, unit tests for both servers, and verified grpcurl functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/38-transport-foundations/38-CONTEXT.md
@.planning/phases/38-transport-foundations/38-RESEARCH.md
@.planning/phases/38-transport-foundations/38-01-SUMMARY.md
@.planning/phases/38-transport-foundations/38-02-SUMMARY.md

# Existing patterns to follow
@health/module.go
@health/server_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unified server package and module</name>
  <files>server/doc.go, server/module.go</files>
  <action>
Create the top-level server package:

1. `server/doc.go`:
   - Package documentation explaining transport layer
   - Document that gRPC starts first, HTTP second
   - Document shutdown order (HTTP first, gRPC second)

2. `server/module.go`:
   - `ModuleOption func(*moduleConfig)` for unified config
   - `moduleConfig` with grpc and http options

   Option functions:
   - `WithGRPCPort(port int) ModuleOption`
   - `WithHTTPPort(port int) ModuleOption`
   - `WithGRPCReflection(enabled bool) ModuleOption`
   - `WithHTTPHandler(h http.Handler) ModuleOption`

   - `NewModule(opts ...ModuleOption) di.Module`:
     - Apply options
     - Return composite module that registers both grpc and http submodules
     - Ensure registration order: grpc first, http second
       (DI container starts services in registration order)

The module should compose the submodules:
```go
func NewModule(opts ...ModuleOption) di.Module {
    cfg := defaultModuleConfig()
    for _, opt := range opts {
        opt(cfg)
    }
    
    return di.NewModuleFunc("server", func(c *di.Container) error {
        // Register gRPC first (starts first)
        if err := grpc.NewModule(grpc.WithPort(cfg.grpcPort)...)(c); err != nil {
            return err
        }
        // Register HTTP second (starts second, stops first)
        if err := http.NewModule(http.WithPort(cfg.httpPort)...)(c); err != nil {
            return err
        }
        return nil
    })
}
```
  </action>
  <verify>`go build ./server/...` compiles</verify>
  <done>Unified module composes grpc and http with correct registration order</done>
</task>

<task type="auto">
  <name>Task 2: Add gRPC server tests</name>
  <files>server/grpc/server_test.go</files>
  <action>
Create unit tests for gRPC server:

1. Use testify/suite pattern (matching project conventions)

2. Test cases:
   - `TestGRPCServerStartStop`: Server starts and stops cleanly
   - `TestGRPCServerReflection`: Reflection is enabled by default
   - `TestGRPCServerServiceDiscovery`: Services implementing ServiceRegistrar are discovered
   - `TestGRPCServerPortBindingError`: Clear error when port unavailable
   - `TestGRPCServerGracefulShutdown`: Pending requests complete before shutdown

3. Use gaztest helper if appropriate, or create minimal container for tests

4. For reflection test, use a simple grpc.ClientConn to verify reflection works:
   ```go
   conn, _ := grpc.Dial("localhost:PORT", grpc.WithTransportCredentials(insecure.NewCredentials()))
   client := grpc_reflection_v1alpha.NewServerReflectionClient(conn)
   // Verify list services works
   ```

Ensure tests pass with `go test -race ./server/grpc/...`
  </action>
  <verify>`go test -race -v ./server/grpc/...` passes</verify>
  <done>gRPC server tests cover lifecycle, reflection, and service discovery</done>
</task>

<task type="auto">
  <name>Task 3: Add HTTP server tests</name>
  <files>server/http/server_test.go</files>
  <action>
Create unit tests for HTTP server:

1. Use testify/suite pattern (matching project conventions)

2. Test cases:
   - `TestHTTPServerStartStop`: Server starts and stops cleanly
   - `TestHTTPServerTimeout`: Verify timeout configuration is applied
   - `TestHTTPServerCustomHandler`: Custom handler receives requests
   - `TestHTTPServerPortBindingError`: Clear error when port unavailable
   - `TestHTTPServerGracefulShutdown`: Active requests complete before shutdown

3. For handler test, register a simple handler and verify it receives requests:
   ```go
   handler := http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
       w.WriteHeader(http.StatusOK)
   })
   server := NewHTTPServer(cfg, handler, logger)
   // Start, make request, verify response
   ```

4. Use net/http/httptest where appropriate

Ensure tests pass with `go test -race ./server/http/...`
  </action>
  <verify>`go test -race -v ./server/http/...` passes</verify>
  <done>HTTP server tests cover lifecycle, timeouts, and custom handlers</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go build ./server/...` - all packages compile
2. `go test -race ./server/...` - all tests pass
3. `make lint` - passes linting
4. `make cover` - maintains 90%+ coverage threshold
</verification>

<success_criteria>
- server/doc.go and server/module.go exist
- Unified module correctly composes grpc and http submodules
- gRPC tests verify: lifecycle, reflection, service discovery
- HTTP tests verify: lifecycle, timeouts, custom handlers
- All tests pass with race detection
- Coverage threshold maintained
</success_criteria>

<output>
After completion, create `.planning/phases/38-transport-foundations/38-03-SUMMARY.md`
</output>
