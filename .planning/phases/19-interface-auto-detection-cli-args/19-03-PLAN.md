---
phase: 19-interface-auto-detection-cli-args
plan: 03
type: execute
wave: 1
depends_on: [19-01, 19-02]
files_modified: [di/service.go, di/lifecycle_auto_test.go]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Explicit .OnStart() hook prevents implicit Starter.OnStart() from running"
    - "Explicit .OnStop() hook prevents implicit Stopper.OnStop() from running"
  artifacts:
    - path: "di/service.go"
      provides: "Mutual exclusion logic for lifecycle hooks vs interfaces"
  key_links:
    - from: "di/service.go"
      to: "Starter.OnStart"
      via: "Conditional check for empty hooks"
---

<objective>
Implement mutual exclusion for lifecycle hooks: if explicit hooks are registered, implicit interface methods (Starter/Stopper) should be skipped.

Purpose: Allow users to override default lifecycle behavior by providing their own hooks.
Output: Updated service wrapper logic and verification tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/19-interface-auto-detection-cli-args/19-01-SUMMARY.md
@.planning/phases/19-interface-auto-detection-cli-args/19-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement lifecycle hook mutual exclusion</name>
  <files>di/service.go</files>
  <action>
    Modify `baseService.runStartLifecycle`:
    - Check if `len(s.startHooks) > 0`
    - If true, run hooks and return (skipping `Starter` check)
    - If false, proceed to check/run `Starter` interface

    Modify `baseService.runStopLifecycle`:
    - Check if `len(s.stopHooks) > 0`
    - If true, run hooks and return (skipping `Stopper` check)
    - If false, proceed to check/run `Stopper` interface
  </action>
  <verify>
    Check code structure ensures mutual exclusion.
  </verify>
  <done>
    Explicit hooks strictly prevent interface methods from running.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify mutual exclusion behavior</name>
  <files>di/lifecycle_auto_test.go</files>
  <action>
    Add test `TestLifecycle_ExplicitOverridesImplicit` to `di/lifecycle_auto_test.go`:
    1. Define struct `DoubleLifecycle` implementing `Starter` and `Stopper`
    2. Register it with `OnStart` and `OnStop` hooks
    3. Start/Stop the container
    4. Assert that ONLY the explicit hooks ran, and interface methods did NOT run
  </action>
  <verify>
    go test -v -run TestLifecycle_ExplicitOverridesImplicit ./di
  </verify>
  <done>
    Test confirms explicit hooks take precedence.
  </done>
</task>

</tasks>

<verification>
Run all lifecycle tests to ensure no regressions:
`go test -v ./di/...`
</verification>

<success_criteria>
- [ ] Explicit hooks override implicit interface methods
- [ ] Existing lifecycle tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/19-interface-auto-detection-cli-args/19-03-SUMMARY.md`
</output>
