---
phase: 05-health-checks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - go.mod
  - go.sum
  - health/types.go
  - health/checker.go
  - health/shutdown.go
  - health/manager.go
autonomous: true
must_haves:
  truths:
    - "Application has distinct registries for Liveness, Readiness, and Startup checks"
    - "Shutdown signal causes Readiness check to immediately fail"
    - "Health module uses alexliesenfeld/health under the hood"
  artifacts:
    - path: "health/types.go"
      provides: "HealthRegistrar interface"
    - path: "health/shutdown.go"
      provides: "ShutdownReadinessChecker"
    - path: "health/manager.go"
      provides: "Manager with registry logic"
  key_links:
    - from: "health/shutdown.go"
      to: "lifecycle.OnStop"
      via: "hook registration"
---

<objective>
Establish the core health check infrastructure using a Registry pattern. This allows services to register their own checks explicitly, bypassing the need for advanced DI multibinding features.

Purpose: Foundation for production-grade observability.
Output: Registry interfaces, Manager implementation, and shutdown signal integration.
</objective>

<context>
@.planning/phases/05-health-checks/05-RESEARCH.md
@.planning/phases/02-lifecycle-management/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and define interfaces</name>
  <files>go.mod, health/types.go</files>
  <action>
    1. Run `go get github.com/alexliesenfeld/health`.
    2. Create `health/types.go`:
       - Define `CheckFunc` type alias (matching `func(context.Context) error`).
       - Define `HealthRegistrar` interface with methods:
         - `AddLivenessCheck(name string, check CheckFunc)`
         - `AddReadinessCheck(name string, check CheckFunc)`
         - `AddStartupCheck(name string, check CheckFunc)`
    3. Define `CheckOptions` struct for per-check configuration (name, timeout).
  </action>
  <verify>
    `go list -m github.com/alexliesenfeld/health` returns version.
    `go build ./health/...` passes.
  </verify>
  <done>
    Interfaces defined and library installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement ShutdownReadinessChecker</name>
  <files>health/shutdown.go</files>
  <action>
    Implement `ShutdownCheck` struct.
    - Use `atomic.Bool` to track state (default: up/false).
    - `Check(ctx)`: return error if shutting down.
    - `MarkShuttingDown()`: sets state to down/true.
    - Ensure it is thread-safe.
  </action>
  <verify>
    Create test: Assert `Check` returns nil initially, then returns error after `MarkShuttingDown` is called.
  </verify>
  <done>
    Shutdown logic implemented and tested.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Health Manager (Registry)</name>
  <files>health/manager.go</files>
  <action>
    Create `Manager` struct that implements `HealthRegistrar`.
    - Maintain thread-safe internal lists/maps of checks for each type (Liveness, Readiness, Startup).
    - Implement `Add*Check` methods to append to these lists.
    - Implement methods to build/retrieve the underlying `health.Checker` for each type (e.g., `LivenessChecker()`, `ReadinessChecker()`).
    - Note: `health.NewChecker` creates an immutable checker. The Manager should construct these checkers lazily or upon first request (e.g., in `Start`), using the accumulated checks.
  </action>
  <verify>
    Test that `Manager` correctly registers checks and includes them when the `health.Checker` is built.
    1. Instantiate Manager.
    2. Add mock liveness check.
    3. Get LivenessChecker -> verify it executes the mock check.
  </verify>
  <done>
    Manager aggregates checks via explicit registration.
  </done>
</task>

</tasks>

<verification>
Run `go test ./health/...`
</verification>

<success_criteria>
- Core health module compiles
- Registry pattern allows adding checks dynamically
- Shutdown checker flips state correctly
- Manager aggregates checks into health.Checker
</success_criteria>

<output>
After completion, create `.planning/phases/05-health-checks/05-01-SUMMARY.md`
</output>
