---
phase: 05-health-checks
plan: 03
type: execute
wave: 3
depends_on: [05-02]
files_modified:
  - health/server.go
  - health/config.go
  - health/module.go
  - gaz.go
autonomous: true
must_haves:
  truths:
    - "Management server runs on a separate port (default 9090)"
    - "Health endpoints are exposed at /live, /ready, /startup"
    - "Management server gracefully shuts down last"
  artifacts:
    - path: "health/server.go"
      provides: "ManagementServer"
    - path: "health/module.go"
      provides: "DI Module"
  key_links:
    - from: "health/server.go"
      to: "gaz.App"
      via: "Lifecycle hooks"
---

<objective>
Integrate the health handlers into a dedicated Management Server that runs alongside the main application, exposing probes on a separate port.

Purpose: Operational isolation of management traffic.
Output: A functional Management Server integrated with the App lifecycle.
</objective>

<context>
@.planning/phases/05-health-checks/05-02-SUMMARY.md
@.planning/phases/03-app-builder-cobra/03-03-SUMMARY.md
@.planning/phases/04-config-system/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Management Server</name>
  <files>health/server.go, health/config.go</files>
  <action>
    1. Define `Config` struct (Port, Path prefixes).
    2. Create `ManagementServer` struct.
    3. Implement `Start` method:
       - Starts `http.Server` on configured port.
       - Mounts `Manager` handlers to `/live`, `/ready`, `/startup`.
    4. Implement `Stop` method:
       - Calls `server.Shutdown(ctx)`.
  </action>
  <verify>
    Test `Start` launches server and `Stop` closes it.
  </verify>
  <done>
    Server logic implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate with Lifecycle and DI</name>
  <files>health/module.go</files>
  <action>
    Create a `gaz.Module` for Health:
    - Provides `Manager`.
    - Provides `ManagementServer`.
    - Provides `ShutdownReadinessChecker`.
    - Invokes a function to register Lifecycle hooks:
       - `OnStart`: Start ManagementServer.
       - `OnStop`:
         1. Call `ShutdownReadinessChecker.MarkShuttingDown()` (First!)
         2. Stop ManagementServer (Last! - verify order).
  </action>
  <verify>
    Verify DI graph resolution.
  </verify>
  <done>
    Module provides all components and wires lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate with App</name>
  <files>gaz.go</files>
  <action>
    Add `WithHealthChecks(config)` option to `gaz.New` (or similar mechanism) that includes the Health module.
    Ensure `Config` can be loaded from the main config system (Phase 4).
  </action>
  <verify>
    Create an integration test in `tests/health_test.go`:
    - Create App with health checks.
    - Start App.
    - `curl localhost:9090/live` -> 200.
    - Stop App.
  </verify>
  <done>
    Public API exposed and verified end-to-end.
  </done>
</task>

</tasks>

<verification>
Run `go test ./tests/...` (End-to-end verification)
</verification>

<success_criteria>
- App exposes health ports
- Shutdown signal triggers readiness failure
- Endpoints return correct JSON
</success_criteria>

<output>
After completion, create `.planning/phases/05-health-checks/05-03-SUMMARY.md`
</output>
