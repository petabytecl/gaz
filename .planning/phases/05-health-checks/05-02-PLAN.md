---
phase: 05-health-checks
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - health/writer.go
  - health/handlers.go
  - health/writer_test.go
autonomous: true
must_haves:
  truths:
    - "Health output follows IETF JSON format"
    - "Readiness failure returns 503"
    - "Liveness failure returns 200 (with error body)"
  artifacts:
    - path: "health/writer.go"
      provides: "IETFResultWriter"
    - path: "health/handlers.go"
      provides: "HTTP handlers"
  key_links:
    - from: "health/handlers.go"
      to: "health/manager.go"
      via: "Checker usage"
---

<objective>
Implement HTTP handlers for health checks with strict IETF JSON output formatting and correct status code mapping for Kubernetes compliance.

Purpose: Ensure observability tools can consume health data correctly and orchestrators behave as expected.
Output: IETF-compliant ResponseWriter and HTTP Handler factory.
</objective>

<context>
@.planning/phases/05-health-checks/05-01-SUMMARY.md
@.planning/phases/05-health-checks/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement IETF Result Writer</name>
  <files>health/writer.go, health/writer_test.go</files>
  <action>
    Implement `IETFResultWriter` function matching `health.ResultWriter` signature.
    - Transform `health.CheckerResult` into IETF JSON structure:
      - `status`: "pass" | "fail" | "warn"
      - `checks`: map[string][]CheckObject
    - Handle standard fields (componentId, componentType, time, output).
    - Ensure `json.Marshal` is used.
  </action>
  <verify>
    Create unit test: Pass a known `health.CheckerResult` and assert the written JSON matches the IETF schema.
  </verify>
  <done>
    Writer produces valid IETF JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Handler Factory</name>
  <files>health/handlers.go</files>
  <action>
    Extend `Manager` or create `HandlerFactory` to produce `http.Handler`s.
    - `NewLivenessHandler()`: uses `health.NewHandler`, configures `WithStatusCodeDown(200)`, uses `IETFResultWriter`.
    - `NewReadinessHandler()`: uses `health.NewHandler`, configures `WithStatusCodeDown(503)`, uses `IETFResultWriter`.
    - `NewStartupHandler()`: uses `health.NewHandler`, configures `WithStatusCodeDown(503)`, uses `IETFResultWriter`.
  </action>
  <verify>
    Unit test:
    - Liveness handler returns 200 even on check failure.
    - Readiness handler returns 503 on check failure.
    - Both return JSON body.
  </verify>
  <done>
    Handlers configured with correct status codes and writer.
  </done>
</task>

</tasks>

<verification>
Run `go test ./health/...`
</verification>

<success_criteria>
- IETF JSON format validated
- Status codes correct for each probe type
</success_criteria>

<output>
After completion, create `.planning/phases/05-health-checks/05-02-SUMMARY.md`
</output>
