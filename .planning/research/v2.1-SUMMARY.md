# v2.1 API Enhancement Research Summary

**Project:** GAZ v2.1 - RuntimeX-inspired API Improvements
**Domain:** Go DI Framework Enhancement
**Researched:** 2026-01-29
**Confidence:** HIGH (verified via Context7, codebase analysis, official sources)

## Executive Summary

GAZ v2.1 enhances the existing DI framework with 8 RuntimeX-inspired features that improve developer experience without architectural rewrites. The research reveals a critical insight: **interface auto-detection for Starter/Stopper is already partially implemented** in `di/service.go` — the execution logic exists, but `HasLifecycle()` doesn't check for interface implementation, causing services with lifecycle methods to be missed during ordering. This milestone closes that gap and adds production-grade conveniences.

The recommended approach is pure Go implementation with **zero new dependencies**. All features (build info, args injection, hooks, testing utilities) leverage Go's standard library — specifically `reflect`, `runtime`, and `runtime/debug` packages. The existing stack (Cobra 1.10.2, Viper 1.21.0, testify 1.11.1) is current and sufficient. This is an additive enhancement milestone, not a dependency refresh.

Key risks center on reflection edge cases (pointer vs value receiver method sets), namespace collisions (args vs named services), and API design (extending `For[T]()` vs adding confusing alternatives). All identified pitfalls have documented prevention strategies. The phased approach builds foundational fixes first, then layers convenience features.

## Key Findings

### Recommended Stack

**No changes required.** The existing stack is verified current and sufficient for all v2.1 features.

| Technology | Version | Purpose | Status |
|------------|---------|---------|--------|
| Go | 1.25.6 | Runtime, generics, errors.Join | Current |
| Cobra | 1.10.2 | CLI integration, version flag | Current |
| Viper | 1.21.0 | Configuration | Current |
| testify | 1.11.1 | Test assertions (require pkg) | Current |

**Core stdlib packages used:**
- `reflect` — Interface detection via `reflect.Type.Implements()`
- `runtime` — Frame introspection via `runtime.Caller()`
- `runtime/debug` — Build info via `debug.ReadBuildInfo()`
- `context` — Lifecycle hooks (existing)

### Expected Features

**Table Stakes (must have):**

| Feature | Complexity | Why Essential |
|---------|------------|---------------|
| Build Info Package | Low | Production debugging requires version/commit visibility |
| Command Args Injection | Low | Commands need positional args in services |
| Pre/Post Run Hooks | Low | Setup/teardown outside lifecycle (migrations, warmup) |
| Test Builder (gaztest) | Medium | Testing DI apps is painful without proper utilities |

**Differentiators (competitive advantage):**

| Feature | Complexity | Why Valuable |
|---------|------------|--------------|
| Interface Auto-Detection | Medium | Cleaner service definitions, less boilerplate |
| Service Builder | Low-Medium | Reduces "time to first HTTP" significantly |
| Unified Provider | Medium | Makes library packages cleaner with bundled modules |

**Defer to v2.2+:**
- Frame Introspection — Nice to have, but `log/slog` with `AddSource: true` handles the primary logging use case

### Architecture Approach

The v2.1 features integrate into GAZ's existing package structure through extension, not replacement. Core changes affect `di/service.go` and `di/registration.go` for interface detection, `app.go` and `cobra.go` for hooks and args. New standalone packages (`buildinfo/`, `gaztest/`) follow the existing pattern of autonomous subpackages (like `health/`, `config/`).

**Major components:**

| Component | Type | Responsibility |
|-----------|------|----------------|
| `gaz/di/service.go` | Modify | Fix `HasLifecycle()` to detect interface implementation |
| `gaz/di/registration.go` | Modify | Track interface implementation at registration time |
| `gaz/app.go` | Modify | Add pre/post run hooks, integrate buildinfo |
| `gaz/cobra.go` | Modify | Register Args in `bootstrap()`, version flag |
| `gaz/buildinfo/` | New | Build metadata (version, commit, branch) |
| `gaz/gaztest/` | New | fxtest-like testing utilities |
| `gaz/debug/` | New (optional) | Frame introspection utilities |

**Key architectural principle:** All changes build on existing patterns (`For[T]()`, `Module()`). No new registration APIs that duplicate existing functionality.

### Critical Pitfalls

| # | Pitfall | Risk Level | Prevention Strategy |
|---|---------|------------|---------------------|
| 1 | **Pointer vs value receiver detection** | Critical | Check BOTH `T` and `*T` for interface implementation: `reflect.PtrTo(t).Implements(iface)` |
| 2 | **reflect.Implements() panic** | Critical | Use `(*Interface)(nil)).Elem()` pattern for interface type; define at package level |
| 3 | **Hook ordering confusion** | Critical | Document explicit order: PreStart → OnStart hooks → Starter.OnStart() → PostStart |
| 4 | **Args namespace collision** | Critical | Separate args registry from services; prefix with `gaz.args.` or use distinct type |
| 5 | **API confusion with For[T]()** | High | Extend existing builder, don't add `Provide[]`, `Register[]` synonyms |

## Implications for Roadmap

Based on research, recommended phase structure for v2.1:

### Phase 1: Foundation (Interface Fix + Core Additions)

**Rationale:** Interface auto-detection is a bug fix that enables cleaner service definitions. Args injection is simple and immediately useful. These are foundational for subsequent phases.

**Delivers:**
- Fixed `HasLifecycle()` to detect Starter/Stopper interface implementations
- `gaz.Args` type registered in bootstrap for DI access
- Interface detection using correct reflection patterns

**Features addressed:** Interface Auto-Detection (#1), Command Args Injection (#3)

**Pitfalls to avoid:**
- P1: Pointer vs value receiver — check both T and *T
- P10: reflect.Implements() panic — use `(*Interface)(nil)).Elem()` pattern

**Research needed:** None — well-documented Go reflection patterns

### Phase 2: Build Info + Hooks

**Rationale:** Standalone additions that improve developer experience. No dependencies on Phase 1. Can run in parallel if resources allow.

**Delivers:**
- `gaz/buildinfo/` package with ldflags integration
- `runtime/debug.ReadBuildInfo()` fallback for VCS info
- Pre/Post run hooks on `App` struct
- Cobra version flag integration

**Features addressed:** Build Info Package (#2), Pre/Post Run Hooks (#4)

**Pitfalls to avoid:**
- P5: ldflags only works with strings — all version vars must be strings
- P6: Dual source of truth — single BuildInfo struct with ldflags priority, debug fallback
- P3: Hook ordering — document explicit order contract

**Research needed:** None — standard Go patterns

### Phase 3: Test Builder (gaztest)

**Rationale:** Testing utilities benefit from having Phases 1-2 complete. The test builder can verify all new functionality.

**Delivers:**
- `gaz/gaztest/` package with `TestApp` wrapper
- `RequireStart()`, `RequireStop()` methods
- Automatic `t.Cleanup()` integration
- `NewLifecycle()` for unit testing hooks

**Features addressed:** Test Builder (#8)

**Pitfalls to avoid:**
- P9: Parallel test cleanup — each test gets isolated container
- Document t.Parallel() + shared container anti-pattern

**Research needed:** None — fxtest patterns well-documented

### Phase 4: Developer Experience (Polish)

**Rationale:** Convenience APIs that build on stable foundation. Lower priority, can be deferred if timeline is tight.

**Delivers:**
- Service Builder helper function (optional)
- Enhanced Module pattern with flags bundling (optional)
- Frame introspection utilities (optional, low priority)

**Features addressed:** Service Builder (#6), Unified Provider (#7), Frame Utils (#5)

**Pitfalls to avoid:**
- P8: Builder hidden state — consume-once pattern
- P4: API confusion — extend `For[T]()`, don't duplicate
- P7: Frame skip off-by-one — configurable skip parameter

**Research needed:** API design iteration recommended before implementation

### Phase Ordering Rationale

1. **Phase 1 first:** Interface detection is a correctness fix affecting how services are ordered in lifecycle. Must be correct before adding more lifecycle hooks.

2. **Phase 2 can parallelize:** Build info and hooks are independent of interface detection. Can develop in parallel with Phase 1 if multiple contributors.

3. **Phase 3 depends on 1-2:** Test builder validates all new functionality. Best developed after features are stable.

4. **Phase 4 is polish:** Service builder and unified provider are convenience layers. Can be deferred to v2.2 if timeline is constrained.

### Research Flags

**Phases needing deeper research during planning:**
- **Phase 4 (Unified Provider):** API design needs iteration — how to bundle flags + constructor + lifecycle without duplicating `For[T]()`. Consider user feedback before finalizing.

**Phases with standard patterns (skip additional research):**
- **Phase 1:** Go reflection patterns well-documented
- **Phase 2:** ldflags and debug.ReadBuildInfo() are standard Go
- **Phase 3:** fxtest provides clear reference implementation

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | Verified via Context7, GitHub releases, go.mod |
| Features | HIGH | Based on fx/fxtest patterns, GAZ codebase analysis |
| Architecture | HIGH | Direct codebase analysis, existing patterns understood |
| Pitfalls | HIGH | Verified against Go reflect docs, runtime behavior |

**Overall confidence:** HIGH

### Gaps to Address

| Gap | How to Handle |
|-----|---------------|
| Unified Provider API design | Prototype during Phase 4, gather user feedback before finalizing |
| Service Builder defaults | Determine which providers are "standard" (health, logging?) |
| Frame introspection priority | Defer unless specific use case emerges beyond slog |

## Sources

### Primary (HIGH confidence)

| Source | Topics |
|--------|--------|
| Context7 `/golang/go` | reflect.Type.Implements(), runtime.Caller(), debug.ReadBuildInfo() |
| Context7 `/uber-go/fx` | Lifecycle patterns, fxtest API design |
| Context7 `/stretchr/testify` | require package for test utilities |
| Context7 `/spf13/cobra` | Version flag, hook execution order |
| GAZ codebase (`di/service.go`, `di/registration.go`, `app.go`, `cobra.go`) | Current implementation patterns |

### Secondary (MEDIUM confidence)

| Source | Finding |
|--------|---------|
| pkg.go.dev/go.uber.org/fx/fxtest | fxtest.App, RequireStart/Stop patterns |
| pkg.go.dev/runtime/debug | BuildInfo struct, VCS settings |
| Internal `_tmp_trust/runtimex/` | Builder pattern, args injection, build info |

### Tertiary (Validated)

| Source | Finding |
|--------|---------|
| WebSearch (Go reflection) | Pointer vs value receiver method set rules |
| WebSearch (ldflags) | String-only limitation, full package path requirement |

---
*Research completed: 2026-01-29*
*Ready for roadmap: yes*
