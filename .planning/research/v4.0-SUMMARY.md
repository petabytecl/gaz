# Research Summary: v4.0 Dependency Reduction

**Milestone:** v4.0 Dependency Replacement
**Domain:** Internal dependency internalization
**Researched:** 2026-02-01
**Confidence:** HIGH

## Executive Summary

This milestone replaces 4 external dependencies (`jpillora/backoff`, `robfig/cron/v3`, `lmittmann/tint`, `alexliesenfeld/health`) with internal implementations, eliminating external maintenance burden and gaining full control over critical infrastructure. The research reveals a clear, low-risk strategy: create **standalone top-level packages** (`backoff/`, `cronx/`, `tintx/`, `healthx/`) that existing consumer packages (`worker/`, `cron/`, `logger/`, `health/`) import. Reference implementations exist for 2 of 4 packages in `_tmp_trust/`, significantly reducing implementation risk.

The recommended approach follows a **dependency-ordered build sequence**: backoff first (smallest, standalone, reference exists), then tintx (no dependencies, well-defined interface), then cronx (largest codebase but complete reference), and finally healthx (highest API surface, no reference). Each replacement is surgically isolated - consumer packages update import paths and wrapper types, but public APIs remain unchanged. This preserves the 92.9% test coverage and maintains backward compatibility.

Key risks center on **subtle behavioral differences**: DST edge cases in cron scheduling, health check status code semantics (liveness returns 200 even on failure), backoff overflow/jitter race conditions, and slog handler `WithAttrs`/`WithGroup` semantics. All require characterization tests BEFORE replacement to capture current behavior. The total effort is estimated at 10-15 hours across 4 focused phases.

---

## Key Findings

### Recommended Stack

Four new top-level packages replace external dependencies:

| Package | Replaces | Placement | Reference Source |
|---------|----------|-----------|------------------|
| `backoff/` | `jpillora/backoff` | `github.com/petabytecl/gaz/backoff` | `_tmp_trust/srex/backoff/` |
| `cronx/` | `robfig/cron/v3` | `github.com/petabytecl/gaz/cronx` | `_tmp_trust/cronx/` |
| `tintx/` | `lmittmann/tint` | `github.com/petabytecl/gaz/tintx` | None (new implementation) |
| `healthx/` | `alexliesenfeld/health` | `github.com/petabytecl/gaz/healthx` | None (new implementation) |

**Core design decisions:**
- **Top-level packages, not internal subpackages** — Enables reuse across consumer packages and follows gaz convention
- **Interface-first design** — `backoff.BackOff`, `healthx.Checker` interfaces enable testing and future implementations
- **Logger standardization** — cronx uses slog-compatible interface, not robfig's custom logger
- **Leaf packages** — All 4 packages import only stdlib, preventing import cycles

### Expected Features

**Table stakes (must implement):**
- `backoff/`: Exponential backoff with min/max/multiplier/jitter, `NextBackOff()`, `Reset()`
- `cronx/`: 5-field parser, descriptor support (@daily), `SkipIfStillRunning` wrapper, graceful shutdown
- `tintx/`: ANSI color output, level-based colors, time formatting, source info, `slog.Handler` interface
- `healthx/`: `Check` struct, `NewChecker()` with options, HTTP handler, status codes, `ResultWriter` interface

**Should implement (improvements):**
- `backoff/`: `WithMaxRetries()` wrapper, `Stop` sentinel value, context support
- `cronx/`: Native slog.Logger support (no adapter needed), CRON_TZ prefix
- `tintx/`: Auto TTY detection, `NoColor` option
- `healthx/`: Built-in IETF writer, simpler API (no periodic checks)

**Defer (anti-features - do NOT implement):**
- `backoff/`: Retry utilities, Ticker abstraction — supervisor handles retry loop
- `cronx/`: Entry/EntryID tracking, Remove(), Entries() introspection — not used by gaz
- `tintx/`: ReplaceAttr callbacks, Windows console support — over-engineering
- `healthx/`: WithPeriodicCheck(), caching — gaz uses synchronous checks only

### Architecture Approach

Each replacement follows the **adapter pattern**: consumer packages (`worker/`, `cron/`, `logger/`, `health/`) wrap internal implementations behind unchanged public APIs. The data flow changes only at the import layer:

**Before:** `worker/supervisor.go` → `jpillora/backoff.Backoff` (external)
**After:** `worker/supervisor.go` → `backoff.ExponentialBackOff` (internal)

**Package import graph (post-migration):**
```
gaz (app.go)
    |
    +-- worker  ──▶ backoff   ──▶ stdlib
    +-- cron    ──▶ cronx     ──▶ stdlib  
    +-- logger  ──▶ tintx     ──▶ stdlib
    +-- health  ──▶ healthx   ──▶ stdlib
```

All new packages are **leaf packages** with no gaz dependencies, making import cycles impossible.

### Critical Pitfalls

1. **DST Edge Cases in cronx** — Jobs at 2:30 AM during spring-forward may skip; jobs at 1:30 AM during fall-back may double-fire. Port extensive DST tests from cronx reference and robfig/cron issues #157, #144.

2. **Health Check Status Code Semantics** — Liveness uses `WithStatusCodeDown(http.StatusOK)` returning 200 even on failure. If internal impl returns 503, Kubernetes kills pods. Write characterization tests BEFORE replacement.

3. **Backoff Overflow to Negative** — `time.Duration` is int64; calculating `base * 2^n` overflows after ~30 attempts, wrapping negative. Must clamp to MaxInterval on overflow.

4. **Jitter Race Condition** — Backoff with jitter uses RNG; pre-Go 1.22 `math/rand` is not thread-safe. Use `math/rand/v2` or per-instance mutex.

5. **slog Handler WithAttrs/WithGroup** — Naive tint replacement returns `self` instead of new handler, losing contextual attributes. Must return shallow copy with appended attrs.

---

## Implications for Roadmap

### Phase 1: backoff Package
**Rationale:** Lowest risk, single consumer, complete reference implementation
**Delivers:** `backoff/` package with `ExponentialBackOff`, interface-first design
**Estimate:** 1-2 hours
**Features:**
- `BackOff` interface (`NextBackOff()`, `Reset()`)
- `ExponentialBackOff` struct with min/max/multiplier/jitter
- Overflow protection, thread-safe jitter
**Changes to consumer:**
- `worker/backoff.go`: Return `backoff.BackOff` interface
- `worker/supervisor.go`: Use interface, rename `Duration()` → `NextBackOff()`
**Avoids:** Pitfalls #3 (overflow), #4 (jitter race), #11 (test mocking)

### Phase 2: tintx Package
**Rationale:** No reference code but simple slog.Handler interface, isolated
**Delivers:** `tintx/` package with colored console handler
**Estimate:** 2-3 hours
**Features:**
- `Handler` implementing `slog.Handler`
- Level-based ANSI colors (ERROR=red, WARN=yellow, INFO=green, DEBUG=blue)
- `Options` with Level, AddSource, TimeFormat, NoColor
- Proper `WithAttrs()`, `WithGroup()` returning new handler
**Changes to consumer:**
- `logger/provider.go`: Use `tintx.NewHandler` instead of `tint.NewHandler`
**Avoids:** Pitfalls #5 (WithAttrs/WithGroup), #8 (ANSI in non-TTY)

### Phase 3: cronx Package  
**Rationale:** Largest codebase but complete reference; logger interface change needed
**Delivers:** `cronx/` package with full cron engine
**Estimate:** 4-6 hours
**Features:**
- `Cron` scheduler with `AddJob()`, `Start()`, `Stop()`
- 5-field parser with descriptor support (@daily, @hourly, @every)
- `SkipIfStillRunning` job wrapper
- slog-compatible `Logger` interface
**Changes to consumer:**
- `cron/scheduler.go`: Import cronx, use internal engine
- `cron/logger.go`: Adapt to cronx.Logger interface
**Avoids:** Pitfalls #1 (DST), #6 (SkipIfStillRunning), #9 (parser fields), #10 (DOW/DOM)

### Phase 4: healthx Package
**Rationale:** Highest risk, no reference, largest API surface, multiple consumers
**Delivers:** `healthx/` package with health check engine and HTTP handler
**Estimate:** 3-4 hours
**Features:**
- `Check` struct, `Checker` interface
- `NewChecker()` with options (`WithCheck`, `WithTimeout`)
- `NewHandler()` with options (`WithResultWriter`, `WithStatusCodeUp/Down`)
- `ResultWriter` interface, `CheckerResult`, `AvailabilityStatus`
**Changes to consumer:**
- `health/manager.go`: Use healthx types
- `health/handlers.go`: Use healthx.NewHandler
- `health/writer.go`: Implement healthx.ResultWriter
**Avoids:** Pitfalls #2 (status codes), #7 (timeout propagation), #12 (metric changes)

### Phase Ordering Rationale

1. **Dependency independence** — All 4 packages are independent; no gaz cross-dependencies
2. **Risk escalation** — Start with lowest risk (backoff) to establish pattern, end with highest (healthx)
3. **Reference availability** — Phases 1 and 3 have complete references; phases 2 and 4 need implementation
4. **Consumer isolation** — Each phase touches single consumer package, enabling atomic testing

### Research Flags

**Phases likely needing deeper research:**
- **Phase 4 (healthx):** No reference implementation; must study alexliesenfeld/health API carefully. Consider `/gsd-research-phase` before implementation.

**Phases with standard patterns (skip research):**
- **Phase 1 (backoff):** Complete reference in `_tmp_trust/srex/backoff/`, well-documented pattern
- **Phase 2 (tintx):** slog.Handler interface is well-defined, simple implementation
- **Phase 3 (cronx):** Complete reference in `_tmp_trust/cronx/`, robfig/cron is de-facto standard

---

## Confidence Assessment

| Area | Confidence | Notes |
|------|------------|-------|
| Stack | HIGH | Clear package structure, reference implementations available |
| Features | HIGH | Direct codebase analysis of actual usage patterns |
| Architecture | HIGH | Adapter pattern well-established in gaz |
| Pitfalls | HIGH | Combination of code analysis, issue research, ecosystem patterns |

**Overall confidence:** HIGH

### Gaps to Address

| Gap | How to Handle |
|-----|---------------|
| tintx implementation | No reference; study lmittmann/tint source (MIT licensed) for implementation guidance |
| healthx API surface | Characterize all alexliesenfeld/health types before implementation |
| DST test coverage | Port robfig/cron DST tests; add Sao Paulo edge case tests |
| TTY detection | Decide: add `go-isatty` dependency or skip auto-detection (use NoColor option) |

---

## Sources

### Primary (HIGH confidence)
- Direct codebase analysis: `worker/backoff.go`, `worker/supervisor.go`, `cron/scheduler.go`, `cron/logger.go`, `logger/provider.go`, `health/manager.go`, `health/handlers.go`, `health/writer.go`
- Reference implementations: `_tmp_trust/srex/backoff/*`, `_tmp_trust/cronx/*`
- Context7: robfig/cron Logger interface, alexliesenfeld/health Checker API

### Secondary (MEDIUM confidence)
- robfig/cron GitHub issues #157 (Sao Paulo DST), #144 (slash-0 hang)
- DST handling patterns from cron ecosystem
- Kubernetes health check best practices

### Tertiary (LOW confidence)
- lmittmann/tint source code (for tintx implementation reference)

---

*Research completed: 2026-02-01*
*Ready for roadmap: yes*
